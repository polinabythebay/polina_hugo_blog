
<!DOCTYPE html>


<html class="no-js" lang="en">
<head>
<meta charset="utf-8">
<title>Computers are *fast*! - Polina Soshnin</title>
<meta name="author" content="Julia Evans">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="description" content="Computers are *fast*!">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="canonical" href="https://jvns.ca/blog/2014/05/12/computers-are-fast/">
<link href="/favicon.ico" rel="icon">
<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
<link href="/atom.xml" rel="alternate" title="Julia Evans" type="application/atom+xml">
 
<link href="https://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='https://fonts.googleapis.com/css?family=Montserrat:700,400' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Alegreya:400,900,700' rel='stylesheet' type='text/css'>
</head>
<body>
<div id="wrap">
<header role="banner">
<hgroup>
<h1><a href="/">Polina Soshnin</a></h1>
</hgroup>
<ul class="header-links">
<span><li><a href="/about">About</a></li>
<li><a href="/projects">Projects</a></li></span>
    <li><a href="https://github.com/polinadotio">Github</a></li></span>
    <li><a href="https://www.linkedin.com/in/polinasoshnin">LinkedIn</a></li></span>
</ul>
</header>
<nav role="navigation" class="header-nav"><ul class="main-navigation">
<li><a href="/categories/favorite/">Favorites</a></li>
<li><a href="/zines">Zines</a></li>
</ul>
</nav>
<div id="main">
<div id="content">

<div>
<article class="hentry" role="article">
<header>
<h1 class="entry-title">Computers are *fast*!</h1>

<div class="post-tags">
  
  •
  
    <a class="post-tag" href="/categories/performance">performance</a> 	•
  
    <a class="post-tag" href="/categories/favorite">favorite</a> 	•
  
    <a class="post-tag" href="/categories/perf">perf</a> 	•
  
  
</div>
<p class="meta">
<time datetime="2014-05-12T21:31:59" pubdate data-updated="true"></time>
</p>
</header>
<div class="entry-content">
     <p>So I have a computer. My computer contains hardware (like a CPU! RAM!
L1/L2 caches!) But I don&rsquo;t understand very well how fast that hardware
is, what tools I have to profile it, and how much of the time that my
programs are running is split between RAM/the hard disk/the CPU.</p>

<p>So today I paired with
<a href="https://twitter.com/SashaLaundy">Sasha Laundy</a>, and we ran Serious
Investigations into how fast my computer can process a 1GB file.</p>

<p><strong>The objects:</strong></p>

<ul>
<li>An episode of The Newsroom (1GB)</li>
<li>A task: add up all the bytes (mod 256)</li>
</ul>

<p>This was basically the easiest task that I could think of that
involved processing the entire file (so nothing gets optimized out by
the compiler).</p>

<p></p>

<h3 id="step-1-write-a-program-to-add-up-all-the-bytes">Step 1: Write a program to add up all the bytes</h3>

<p>I wrote a small C program to add up all the bytes in a file. It&rsquo;s
called
<a href="https://github.com/jvns/howcomputer/blob/master/bytesum.c">bytesum.c</a>.
It reads the file in chunks of 64k, and then adds up all the bytes
into a char.</p>

<p>This runs pretty fast! I compiled it with <code>gcc -Ofast</code> (to make it
FASTER!) and it added up all the bytes in</p>

<ul>
<li>2.5 seconds (the first time I ran the program)</li>
<li>0.6 seconds (the second time I ran the program, because it&rsquo;s already
loaded into RAM)</li>
</ul>

<p>I take this to mean that it takes 2s to read the file into memory (I
have a SSD in my computer, so 500MB/s makes sense), and then 0.6s to
do the actual adding-up-of-the bytes. Awesome! We now know that I can
read from my hard drive at 500MB/s.</p>

<h3 id="step-2-try-to-use-mmap-to-make-it-faster">Step 2: try to use <code>mmap</code> to make it faster</h3>

<p>This is a pretty boring step. We made it use <code>mmap</code> instead (see
<a href="https://github.com/jvns/howcomputer/blob/master/bytesum_mmap.c">bytesum_mmap.c</a>),
in the hopes that it would make it faster. It took exactly the same
amount of time. NEXT.</p>

<h3 id="step-3-use-vector-intrinsics">Step 3: use vector intrinsics!!!</h3>

<p>Then I went and talked to <a href="http://jamesporter.me/">James Porter</a>, and
he told me that CPUs have special instructions for doing multiple
additions at once, and that I could maybe use them to optimize my
program! So I googled &ldquo;vector intrinsics&rdquo;, copied some code from Stack
Overflow, and ended up with a new version:
<a href="https://github.com/jvns/howcomputer/blob/master/bytesum_intrinsics.c">bytesum_intrinsics.c</a>.
I timed it, and it took <strong>0.25 seconds</strong>!!!</p>

<p>So our program now runs <strong>twice as fast</strong>, and we know a whole bunch
of new words (SSE! SIMD! vector intrinsics!)</p>

<h3 id="step-4-make-it-slow">Step 4: Make it slow.</h3>

<p>Now that we&rsquo;ve written a super fast program, I wanted to understand
the CPU caches better. What if we engineered a whole bunch of cache
misses? I wrote a new version of <code>bytesum_mmap.c</code> that added up all
the bytes in an irregular way &ndash; instead of going through all the
bytes in order, it would skip from byte 1 to 2001 to 3001 to 4001 and
then loop around and access 2, 2002, 3002, &hellip;, 100002. As you might
imagine, this isn&rsquo;t very efficient.</p>

<p>You can see the code for this in
<a href="https://github.com/jvns/howcomputer/blob/master/bytesum_stride.c">bytesum_stride.c</a>.
I ran it with <code>./bytesum_stride *.mp4 60000</code>, and it took about 20
seconds. So we&rsquo;ve learned that <strong>cache misses can make your code 40
times slower</strong>.</p>

<h3 id="step-5-where-do-the-0-25-seconds-come-from">Step 5: where do the 0.25 seconds come from???</h3>

<p>I still didn&rsquo;t totally understand exactly how my super fast vector
intrinsic program&rsquo;s performance broke down, though: how much of that
0.25 seconds was spent doing memory accesses, and how much in
numerical computation? James suggested using
<a href="http://marss86.org/~marss86/index.php/Home">Marss</a> which will
apparently give you unlimited amounts of information, but I spent a
few minutes trying to get it to work and failed.</p>

<p>So instead I used <code>perf</code>, which is a <em>totally magical</em> performance
measurement tool for Linux. I needed to upgrade my kernel first, which
was a bit nervewracking. But I did it! And it was beautiful. There are
colours, and we got it to annotate the assembly code with performance
statistics. Here&rsquo;s what I ran to do it:</p>

<pre>
perf record ./bytesum_intrinsics The\ Newsroom\ S01E04.mp4
perf annotate --no-source
</pre>

<p>And here&rsquo;s the result:</p>

<p><img src="/images/perf.png"></p>

<p>The <code>movdqa</code> instructions have to do with accessing memory, and it
spends 32% of its time on those instructions. So I <em>think</em> that means
that it spends 32% of its time accessing RAM, and the other 68% of its
time doing calculations. Super neat!</p>

<p>There are still a lot of things I don&rsquo;t understand here &ndash; are my
conclusions about this program correct? Are there further things I
could be doing to optimize this?</p>

<p>I&rsquo;m also kind of amazed by how fast C is. I&rsquo;m used to writing in
dynamic programming languages, which definitely do not process 1GB
files in 0.25 seconds. Fun!</p>
</div>
<footer>
<div class="sharing">
<a href="http://twitter.com/share" class="twitter-share-button" data-url="https://jvns.ca/blog/2014/05/12/computers-are-fast/" data-via="b0rk" data-counturl="https://jvns.ca/blog/2014/05/12/computers-are-fast/">Tweet</a>
</div>
<p class="meta">
   
    <a class="basic-alignment left" href="https://jvns.ca/blog/2014/05/13/profiling-with-perf/" title="Previous Post: I can spy on my CPU cycles with perf!">I can spy on my CPU cycles with perf!</a>
  
   
    <a class="basic-alignment right" href="https://jvns.ca/blog/2014/04/27/stopping-to-think/" title="Previous Post: Stopping to think">Stopping to think</a>
  
</p>
</footer>
</article>
</div>

</div>
</div>
<nav role="navigation" class="footer-nav"> <a href="/">Archives</a>
</nav>
<footer role="contentinfo"><span class="credit">&copy; 2016 Polina Soshnin.
</footer>
</div>
</body>
</html>

