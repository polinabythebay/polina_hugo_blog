
<!DOCTYPE html>


<html class="no-js" lang="en">
<head>
<meta charset="utf-8">
<title>Recovering files using /proc (and spying, too!) - Polina Soshnin</title>
<meta name="author" content="Julia Evans">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="description" content="Recovering files using /proc (and spying, too!)">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="canonical" href="https://jvns.ca/blog/2014/03/23/recovering-files-using-slash-proc-and-other-useful-facts/">
<link href="/favicon.ico" rel="icon">
<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
<link href="/atom.xml" rel="alternate" title="Julia Evans" type="application/atom+xml">
 
<link href="https://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='https://fonts.googleapis.com/css?family=Montserrat:700,400' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Alegreya:400,900,700' rel='stylesheet' type='text/css'>
</head>
<body>
<div id="wrap">
<header role="banner">
<hgroup>
<h1><a href="/">Polina Soshnin</a></h1>
</hgroup>
<ul class="header-links">
<span><li><a href="/about">About</a></li>
<li><a href="/projects">Projects</a></li></span>
    <li><a href="https://github.com/polinadotio">Github</a></li></span>
    <li><a href="https://www.linkedin.com/in/polinasoshnin">LinkedIn</a></li></span>
</ul>
</header>
<nav role="navigation" class="header-nav"><ul class="main-navigation">
<li><a href="/categories/favorite/">Favorites</a></li>
<li><a href="/zines">Zines</a></li>
</ul>
</nav>
<div id="main">
<div id="content">

<div>
<article class="hentry" role="article">
<header>
<h1 class="entry-title">Recovering files using /proc (and spying, too!)</h1>

<div class="post-tags">
  
  •
  
    <a class="post-tag" href="/categories/kernel">kernel</a> 	•
  
    <a class="post-tag" href="/categories/spytools">spytools</a> 	•
  
  
</div>
<p class="meta">
<time datetime="2014-03-23T11:16:24" pubdate data-updated="true"></time>
</p>
</header>
<div class="entry-content">
     <p>I&rsquo;ve had a vague idea for years that /proc was a way the Linux kernel
exposed its internals, and that I could look there to find things.</p>

<p>Then I learned this:</p>

<blockquote class="twitter-tweet" lang="en"><p>TIL!!! If you
accidentally delete a file that a process still has open, you can
recover it with cat /proc/$pid/fd/$file_descriptor. so
easy!</p>&mdash; Julia Evans (@b0rk) <a
href="https://twitter.com/b0rk/statuses/446291944575352833">March 19,
2014</a></blockquote>

<p>Suddenly it was like <code>/proc</code> was turned into a magical unicorn! I can
use it to recover my files?! ★★Amazing★★.</p>

<p>Let&rsquo;s explain why this works. When a process opens a file (including
sockets), it gets a <em>file descriptor</em> for that file, which is a number
starting at 0.</p>

<p></p>

<h3 id="file-descriptors-and-investigations-on-std-in-out-err">File descriptors and investigations on std{in,out,err}</h3>

<p>0, 1, and 2 are always the stdin, stdout, and stderr of the process.
For example, if I look at the file descriptors for a Google Chrome
process I have, I see:</p>

<pre>
$ ls /proc/4076/fd
0  10  12  14  16  18  2   21  23  26  28  3   31  34  36  38  4   41  43  5   6  72  8
1  11  13  15  17  19  20  22  25  27  29  30  32  35  37  39  40  42  44  53  7  74  9
</pre>

<p>That&rsquo;s pretty opaque! Let&rsquo;s take a closer look.</p>

<pre>
$ ls -l /proc/4076/fd/{0,1,2}
lr-x------ 1 bork bork 64 Mar 22 22:38 /proc/4076/fd/0 -> /dev/null
l-wx------ 1 bork bork 64 Mar 22 22:38 /proc/4076/fd/1 -> /dev/null
l-wx------ 1 bork bork 64 Mar 22 22:38 /proc/4076/fd/2 -> /home/bork/.xsession-errors
</pre>

<p>Neat, the numbers 0, 1, and 2 are just symbolic links! It looks like
Chrome doesn&rsquo;t have any stdin or stdout, which makes sense, but the
stderr is <code>/home/bork/.xsession-errors</code>. I didn&rsquo;t know that! It turns
out this is also a great way to find out where a process that you
didn&rsquo;t start is redirecting its output.</p>

<p>Where else do my programs redirect their stderr? Let&rsquo;s see! I looked
at everything&rsquo;s stderr, got awk to pull out just the file, and ran
<code>uniq</code> to get the counts.</p>

<pre>
$ ls -l /proc/*/fd/2 | awk '{print $11}' | sort | uniq -c
      42 /dev/null
      2 /dev/pts/0
      1 /dev/pts/1
      3 /dev/pts/2
      2 /dev/pts/3
      2 /dev/pts/4
      5 /dev/pts/5
      1 /dev/pts/7
     25 /home/bork/.xsession-errors
</pre>

<p>So mostly /dev/null, some of them are running on terminals
(<code>/dev/pts/*</code>), and the rest to <code>~/.xsession-errors</code>. No huge
surprises here.</p>

<p>What else could we use these file descriptors for? Someone on Twitter
suggested this:</p>

<blockquote class="twitter-tweet" data-conversation="none"
lang="en"><p><a href="https://twitter.com/b0rk">@b0rk</a> When I was
making my first Tarsnap backup, I used `readlink
/proc/&lt;TARSNAP&gt;/fd/7` in a loop to find out what file it was
on.</p> &mdash; Matthew Frazier (@LeafStorm) <a
href="https://twitter.com/LeafStorm/statuses/447564888198885376">March
23, 2014</a></blockquote>

<p>This works because when you open different files again and again in a
loop, it will usually end up with the same file descriptor. You could
also do the same thing by running <code>strace -etrace=open -p$TARSNAP_PID</code>
to see which files Tarsnap is opening.</p>

<p>Okay, now we know that we can use /proc to learn about our processes&rsquo;
files! What else?</p>

<h3 id="spy-on-your-processes-with-proc-pid-status">Spy on your processes with /proc/$pid/status</h3>

<p>If you look at the file <code>/proc/$pid/status</code>, you can find out all
sorts of information about your processes! You can look at this for
any process.</p>

<p>Here&rsquo;s a sample of what&rsquo;s in that file:</p>

<pre>
Name:   chrome
Groups: 4 20 24 27 30 46 104 109 124 1000 
VmPeak:   853984 kB
VmSize:   670392 kB
VmData:   323264 kB
VmExe:     96100 kB
Threads:        3
Cpus_allowed_list:      0-7
</pre>

<p>So we can see there&rsquo;s some information about the memory, its name, its
groups, its threads, and which CPUs it&rsquo;s allowed to run on.</p>

<p>But wait! We could have found out a lot of this information with <code>ps
aux</code>. How does <code>ps</code> do it? Let&rsquo;s find out!</p>

<pre>
$ strace -f -etrace=open ps aux
...
open("/proc/30219/stat", O_RDONLY)      = 6
open("/proc/30219/status", O_RDONLY)    = 6
open("/proc/30219/cmdline", O_RDONLY)   = 6
...
</pre>

<p>So <code>ps</code> gets its information from <code>/proc</code>! Neat.</p>

<h3 id="i-m-sold-what-else-is-there">I&rsquo;m sold. What else is there?!!</h3>

<p>I tweeted asking for suggestions of things to find in <code>/proc/</code>, and
someone replied linking to the
<a href="http://linux.die.net/man/5/proc">/proc man page</a>. I thought they were
trolling me, but then I clicked on it and it was actually useful!</p>

<p>A few more things I need to investigate:</p>

<ul>
<li>the <code>procps</code> and <code>sysstat</code> utilities</li>
<li>a ton of wonderful suggestions by Keegan McAllister on the
<a href="https://blogs.oracle.com/ksplice/entry/solving_problems_with_proc">Ksplice blog</a>
(including how to force a program to take stdin if it doesn&rsquo;t take
stdin)</li>
<li><code>/sys</code> replaces part of <code>/proc</code>&rsquo;s functionality.</li>
<li>Plan 9 / Inferno took this &ldquo;everything is a file&rdquo; business even more
seriously than Linux does</li>
<li><a href="https://en.wikipedia.org/wiki/Debugfs">debugfs</a> / ftrace.
<a href="http://thread.gmane.org/gmane.linux.kernel.mmc/4248/focus=4400">An example someone linked to.</a></li>
</ul>

<p>I still feel like there are concrete uses for <code>/proc/</code> that I don&rsquo;t
know about, though. What are they?</p>

<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
</div>
<footer>
<div class="sharing">
<a href="http://twitter.com/share" class="twitter-share-button" data-url="https://jvns.ca/blog/2014/03/23/recovering-files-using-slash-proc-and-other-useful-facts/" data-via="b0rk" data-counturl="https://jvns.ca/blog/2014/03/23/recovering-files-using-slash-proc-and-other-useful-facts/">Tweet</a>
</div>
<p class="meta">
   
    <a class="basic-alignment left" href="https://jvns.ca/blog/2014/03/29/reports-from-remote-land-remote-pairing-works-great/" title="Previous Post: Reports from remote-land: remote pairing works great!">Reports from remote-land: remote pairing works great!</a>
  
   
    <a class="basic-alignment right" href="https://jvns.ca/blog/2014/03/21/my-rust-os-will-never-be-finished/" title="Previous Post: My Rust OS will never be finished (and it&#39;s a success!)">My Rust OS will never be finished (and it&#39;s a success!)</a>
  
</p>
</footer>
</article>
</div>

</div>
</div>
<nav role="navigation" class="footer-nav"> <a href="/">Archives</a>
</nav>
<footer role="contentinfo"><span class="credit">&copy; 2016 Polina Soshnin.
</footer>
</div>
</body>
</html>

