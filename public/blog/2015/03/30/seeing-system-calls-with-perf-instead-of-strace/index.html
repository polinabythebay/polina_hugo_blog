
<!DOCTYPE html>


<html class="no-js" lang="en">
<head>
<meta charset="utf-8">
<title>Seeing system calls with perf instead of strace - Polina Soshnin</title>
<meta name="author" content="Julia Evans">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="description" content="Seeing system calls with perf instead of strace">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="canonical" href="https://jvns.ca/blog/2015/03/30/seeing-system-calls-with-perf-instead-of-strace/">
<link href="/favicon.ico" rel="icon">
<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
<link href="/atom.xml" rel="alternate" title="Julia Evans" type="application/atom+xml">
 
<link href="https://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='https://fonts.googleapis.com/css?family=Montserrat:700,400' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Alegreya:400,900,700' rel='stylesheet' type='text/css'>
</head>
<body>
<div id="wrap">
<header role="banner">
<hgroup>
<h1><a href="/">Polina Soshnin</a></h1>
</hgroup>
<ul class="header-links">
<span><li><a href="/about">About</a></li>
<li><a href="/projects">Projects</a></li></span>
    <li><a href="https://github.com/polinadotio">Github</a></li></span>
    <li><a href="https://www.linkedin.com/in/polinasoshnin">LinkedIn</a></li></span>
</ul>
</header>
<nav role="navigation" class="header-nav"><ul class="main-navigation">
<li><a href="/categories/favorite/">Favorites</a></li>
<li><a href="/zines">Zines</a></li>
</ul>
</nav>
<div id="main">
<div id="content">

<div>
<article class="hentry" role="article">
<header>
<h1 class="entry-title">Seeing system calls with perf instead of strace</h1>

<div class="post-tags">
  
  •
  
    <a class="post-tag" href="/categories/perf">perf</a> 	•
  
  
</div>
<p class="meta">
<time datetime="2015-03-30T21:42:36" pubdate data-updated="true"></time>
</p>
</header>
<div class="entry-content">
     

<p>I&rsquo;m at a local hackerspace this evening, and I decided to get <code>perf</code>
working on my computer again. You all know by now that I&rsquo;m pretty into
strace, but &ndash; strace is not always a good choice! If your program runs
too many system calls, strace will slow it down. A lot.</p>

<p>Let&rsquo;s try it and see:</p>

<pre><code>$ time du -sh ~/work
0.04 seconds
$ time strace -o out du -sh ~/work
2.66 seconds
</code></pre>

<p>That&rsquo;s 65 times slower! This is because <code>du</code> needed to use 260,000
system calls, which is uh a lot. If you strace a program with less
system calls it won&rsquo;t be that big of a deal. But what if we still want
to know what <code>du</code> is doing, and <code>du</code> is actually a Really Important
Program like a database or something?</p>

<h3 id="we-re-going-to-use-perf-d-d">WE&rsquo;RE GOING TO USE PERF =D =D.</h3>

<p>I&rsquo;ve been eyeing Brendan Gregg&rsquo;s
<a href="http://www.brendangregg.com/perf.html">page on perf</a>
and the <a href="https://perf.wiki.kernel.org/index.php/Tutorial">kernel.org tutorial</a>
for almost a year now, and we learned in May last year that
<a href="http://jvns.ca/blog/2014/05/13/profiling-with-perf/">perf lets you count CPU cycles</a>, which is
cool! But perf is capable of way more stuff.</p>

<p>Here&rsquo;s how we record what system calls <code>du</code> is using:</p>

<pre><code>sudo perf record -e 'syscalls:sys_enter_*' du -sh ~/work
</code></pre>

<p>This finishes right away, except that perf takes a little extra time to
write its recorded data to desk. Then we can see the system calls with
<code>sudo perf script</code>, which shows us something like this:</p>

<pre><code>du 25156 [003] 142769.540801: syscalls:sys_enter_newfstatat:
       dfd: 0x00000006, filename: 0x021b0b58, statbuf: 0x021b0ac8, flag: 0x0
du 25156 [003] 142769.540802: syscalls:sys_enter_close:
       fd: 0x00000006
du 25156 [003] 142769.540804: syscalls:sys_enter_newfstatat: 
       dfd: 0x00000005, filename: 0x021b4708, statbuf: 0x021b4678, flag: 0x0
</code></pre>

<p>This is showing us system calls! You can see the file descriptors &ndash;
<code>fd: 0x00000006</code>. But it doesn&rsquo;t give us the filename, just&hellip; the
address of the filename? I don&rsquo;t know how to get the actual filename out
and that makes me sad.</p>

<p>It&rsquo;s called <code>perf script</code> because you can write scripts with the output
(like this <a href="http://www.brendangregg.com/FlameGraphs/cpuflamegraphs.html">flamegraph script</a>!).
Like maybe you could pretty it up and have a script that&rsquo;s like strace
but doesn&rsquo;t slow your program down so much. Apparently <code>perf script -g python</code>
will automatically generate boilerplate for a perf script in Python for
me! But it doesn&rsquo;t work because I need to recompile perf. So we&rsquo;ll see
about that :)</p>

<p>That&rsquo;s all I have to say for now! Mostly I&rsquo;m writing this up in the
hopes that someone will either a) tell me how to get perf to give me the
actual filename or b) tell me why it&rsquo;s unreasonable to expect perf to do
that.</p>

</div>
<footer>
<div class="sharing">
<a href="http://twitter.com/share" class="twitter-share-button" data-url="https://jvns.ca/blog/2015/03/30/seeing-system-calls-with-perf-instead-of-strace/" data-via="b0rk" data-counturl="https://jvns.ca/blog/2015/03/30/seeing-system-calls-with-perf-instead-of-strace/">Tweet</a>
</div>
<p class="meta">
   
    <a class="basic-alignment left" href="https://jvns.ca/blog/2015/04/06/a-few-spy-tools-for-your-operating-system-other-than-strace/" title="Previous Post: A few spy tools for your operating system (other than strace!)">A few spy tools for your operating system (other than strace!)</a>
  
   
    <a class="basic-alignment right" href="https://jvns.ca/blog/2015/03/28/senior-engineering-and-fantasy-heroes/" title="Previous Post: Senior engineering &amp; fantasy heroes">Senior engineering &amp; fantasy heroes</a>
  
</p>
</footer>
</article>
</div>

</div>
</div>
<nav role="navigation" class="footer-nav"> <a href="/">Archives</a>
</nav>
<footer role="contentinfo"><span class="credit">&copy; 2016 Polina Soshnin.
</footer>
</div>
</body>
</html>

