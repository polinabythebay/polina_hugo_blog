
<!DOCTYPE html>


<html class="no-js" lang="en">
<head>
<meta charset="utf-8">
<title>Why you should understand (a little) about TCP - Polina Soshnin</title>
<meta name="author" content="Julia Evans">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="description" content="Why you should understand (a little) about TCP">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="canonical" href="https://jvns.ca/blog/2015/11/21/why-you-should-understand-a-little-about-tcp/">
<link href="/favicon.ico" rel="icon">
<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
<link href="/atom.xml" rel="alternate" title="Julia Evans" type="application/atom+xml">
 
<link href="https://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='https://fonts.googleapis.com/css?family=Montserrat:700,400' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Alegreya:400,900,700' rel='stylesheet' type='text/css'>
</head>
<body>
<div id="wrap">
<header role="banner">
<hgroup>
<h1><a href="/">Polina Soshnin</a></h1>
</hgroup>
<ul class="header-links">
<span><li><a href="/about">About</a></li>
<li><a href="/projects">Projects</a></li></span>
    <li><a href="https://github.com/polinadotio">Github</a></li></span>
    <li><a href="https://www.linkedin.com/in/polinasoshnin">LinkedIn</a></li></span>
</ul>
</header>
<nav role="navigation" class="header-nav"><ul class="main-navigation">
<li><a href="/categories/favorite/">Favorites</a></li>
<li><a href="/zines">Zines</a></li>
</ul>
</nav>
<div id="main">
<div id="content">

<div>
<article class="hentry" role="article">
<header>
<h1 class="entry-title">Why you should understand (a little) about TCP</h1>

<div class="post-tags">
  
  •
  
    <a class="post-tag" href="/categories/performance">performance</a> 	•
  
    <a class="post-tag" href="/categories/favorite">favorite</a> 	•
  
    <a class="post-tag" href="/categories/how-things-work">how-things-work</a> 	•
  
  
</div>
<p class="meta">
<time datetime="2015-11-21T09:13:44" pubdate data-updated="true"></time>
</p>
</header>
<div class="entry-content">
     

<p>This isn&rsquo;t about understanding <em>everything</em> about TCP or reading through <a href="http://www.amazon.com/TCP-Illustrated-Vol-Addison-Wesley-Professional/dp/0201633469">TCP/IP Illustrated</a>. It&rsquo;s about how a little bit of TCP knowledge is essential. Here&rsquo;s why.</p>

<p>When I was at the <a href="http://recurse.com">Recurse Center</a>, I wrote a TCP stack in Python (<a href="http://jvns.ca/blog/2014/08/12/what-happens-if-you-write-a-tcp-stack-in-python/">and wrote about what happens if you write a TCP stack in Python</a>). This was a fun learning experience, and I thought that was all.</p>

<p>A year later, at work, someone mentioned on Slack &ldquo;hey I&rsquo;m publishing messages to NSQ and it&rsquo;s taking 40ms each time&rdquo;. I&rsquo;d already been thinking about this problem on and off for a week, and hadn&rsquo;t gotten anywhere.</p>

<p>A little background: NSQ is a queue that you send to messages to. The way you publish a message is to make an HTTP request on localhost. It really should not take <strong>40 milliseconds</strong> to send a HTTP request to localhost. Something was terribly wrong. The NSQ daemon wasn&rsquo;t under high CPU load, it wasn&rsquo;t using a lot of memory, it didn&rsquo;t seem to be a garbage collection pause. Help.</p>

<p>Then I remembered an article I&rsquo;d read a week before called <a href="https://gocardless.com/blog/in-search-of-performance-how-we-shaved-200ms-off-every-post-request/">In search of performance - how we shaved 200ms off every POST request</a>. In that article, they talk about why every one of their POST requests were taking 200 extra milliseconds. That&rsquo;s.. weird. Here&rsquo;s the key paragraph from the post</p>

<h3 id="delayed-acks-tcp-nodelay">Delayed ACKs &amp; TCP_NODELAY</h3>

<blockquote>
<p>Ruby&rsquo;s Net::HTTP splits POST requests across two TCP packets - one for the
headers, and another for the body. curl, by contrast, combines the two if
they&rsquo;ll fit in a single packet. To make things worse, Net::HTTP doesn&rsquo;t set
TCP_NODELAY on the TCP socket it opens, so it waits for acknowledgement of the
first packet before sending the second. This behaviour is a consequence of
Nagle&rsquo;s algorithm.</p>

<p>Moving to the other end of the connection, HAProxy has to choose how to
acknowledge those two packets. In version 1.4.18 (the one we were using), it
opted to use TCP delayed acknowledgement. Delayed acknowledgement interacts
badly with Nagle&rsquo;s algorithm, and causes the request to pause until the server
reaches its delayed acknowledgement timeout..</p>
</blockquote>

<p>Let&rsquo;s unpack what this paragraph is saying.</p>

<ul>
<li>TCP is an algorithm where you send data in <strong>packets</strong></li>
<li>Their HTTP library was sending POST requests in 2 small packets</li>
</ul>

<p>Here&rsquo;s what the rest of the TCP exchange looked like after that:</p>

<blockquote>
<p>application: hi! Here&rsquo;s packet 1. <br>
HAProxy: &lt;silence, waiting for the second packet&gt;<br>
HAProxy: &lt;well I&rsquo;ll ack eventually but nbd&gt;<br>
application: &lt;silence&gt;<br>
application: &lt;well I&rsquo;m waiting for an ACK maybe there&rsquo;s network congestion&gt;<br>
HAProxy: ok i&rsquo;m bored. here&rsquo;s an ack<br>
application: great here&rsquo;s the second packet!!!!<br>
HAProxy: sweet. we&rsquo;re done here<br></p>
</blockquote>

<p>That period where the application and HAProxy are both passive-aggressively
waiting for the other to send information? That&rsquo;s the extra 200ms. The application is doing it because of Nagle&rsquo;s algorithm, and HAProxy because of delayed ACKs.</p>

<p>Delayed ACKs happen, as far as I understand, by default on <em>every</em> Linux system.
So this isn&rsquo;t an edge case or an anomaly &ndash; if you send your data in more than 1
TCP packet, it can happen to you.</p>

<h3 id="in-which-we-become-wizards">in which we become wizards</h3>

<p>So I read this article, and forgot about it. But I was stewing about my extra 40ms, and then I remembered.</p>

<p>And I thought &ndash; that can&rsquo;t be my problem, can it? can it??? And I sent an email to my team saying &ldquo;I think I might be crazy but this might be a TCP problem&rdquo;.</p>

<p>So I committed a change turning on <code>TCP_NODELAY</code> for our application, and BOOM.</p>

<p>All of the 40ms delays <strong>instantly disappeared</strong>. Everything was fixed. I was a wizard.</p>

<h3 id="should-we-stop-using-delayed-acks-entirely">should we stop using delayed ACKs entirely</h3>

<p>A quick sidebar &ndash; I just read <a href="https://news.ycombinator.com/item?id=9048947">this comment on Hacker News</a> from John Nagle (of Nagle&rsquo;s algorithm) via <a href="https://twitter.com/alicemazzy/status/667799010317574145">this awesome tweet</a> by @alicemazzy.</p>

<blockquote>
<p>The real problem is ACK delays. The 200ms &ldquo;ACK delay&rdquo; timer is a bad idea that
someone at Berkeley stuck into BSD around 1985 because they didn&rsquo;t really
understand the problem. A delayed ACK is a bet that there will be a reply from
the application level within 200ms. TCP continues to use delayed ACKs even if
it&rsquo;s losing that bet every time.</p>
</blockquote>

<p>He goes on to comment that ACKs are small and inexpensive, and that the problems
caused in practice by delayed ACKs are probably much worse than the problems
they solve.</p>

<h3 id="you-can-t-fix-tcp-problems-without-understanding-tcp">you can&rsquo;t fix TCP problems without understanding TCP</h3>

<p>I used to think that TCP was really low-level and that I did not need to understand it. Which is mostly true! But sometimes in real life you have a bug and that bug is because of something in the TCP algorithm. So it turns out that understanding TCP is important. (as we frequently discuss on this blog, this turns out to be true for a lot of things, like, system calls &amp; operating systems :) :))</p>

<p>This delayed ACKs / TCP_NODELAY interaction is particularly bad &ndash; it could affect anyone writing code that makes HTTP requests, in any programming language. You don&rsquo;t have to be a systems programming wizard to run into this. Understanding a tiny bit about how TCP worked really helped me work through this and recognize that that thing the blog post was describing also might be my problem. I also used strace, though. strace forever.</p>

</div>
<footer>
<div class="sharing">
<a href="http://twitter.com/share" class="twitter-share-button" data-url="https://jvns.ca/blog/2015/11/21/why-you-should-understand-a-little-about-tcp/" data-via="b0rk" data-counturl="https://jvns.ca/blog/2015/11/21/why-you-should-understand-a-little-about-tcp/">Tweet</a>
</div>
<p class="meta">
   
    <a class="basic-alignment left" href="https://jvns.ca/blog/2015/11/22/how-i-got-better-at-debugging/" title="Previous Post: How I got better at debugging">How I got better at debugging</a>
  
   
    <a class="basic-alignment right" href="https://jvns.ca/blog/2015/11/09/docker-is-amazing/" title="Previous Post: Docker is amazing">Docker is amazing</a>
  
</p>
</footer>
</article>
</div>

</div>
</div>
<nav role="navigation" class="footer-nav"> <a href="/">Archives</a>
</nav>
<footer role="contentinfo"><span class="credit">&copy; 2016 Polina Soshnin.
</footer>
</div>
</body>
</html>

