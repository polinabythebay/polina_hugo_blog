
<!DOCTYPE html>


<html class="no-js" lang="en">
<head>
<meta charset="utf-8">
<title>Day 15: How a .gz file is structured, redux - Polina Soshnin</title>
<meta name="author" content="Julia Evans">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="description" content="Day 15: How a .gz file is structured, redux">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="canonical" href="https://jvns.ca/blog/2013/10/23/day-15-how-gzip-works/">
<link href="/favicon.ico" rel="icon">
<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
<link href="/atom.xml" rel="alternate" title="Julia Evans" type="application/atom+xml">
 
<link href="https://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='https://fonts.googleapis.com/css?family=Montserrat:700,400' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Alegreya:400,900,700' rel='stylesheet' type='text/css'>
</head>
<body>
<div id="wrap">
<header role="banner">
<hgroup>
<h1><a href="/">Polina Soshnin</a></h1>
</hgroup>
<ul class="header-links">
<span><li><a href="/about">About</a></li>
<li><a href="/projects">Projects</a></li></span>
    <li><a href="https://github.com/polinadotio">Github</a></li></span>
    <li><a href="https://www.linkedin.com/in/polinasoshnin">LinkedIn</a></li></span>
</ul>
</header>
<nav role="navigation" class="header-nav"><ul class="main-navigation">
<li><a href="/categories/favorite/">Favorites</a></li>
<li><a href="/zines">Zines</a></li>
</ul>
</nav>
<div id="main">
<div id="content">

<div>
<article class="hentry" role="article">
<header>
<h1 class="entry-title">Day 15: How a .gz file is structured, redux</h1>

<div class="post-tags">
  
  •
  
    <a class="post-tag" href="/categories/hackerschool">hackerschool</a> 	•
  
  
</div>
<p class="meta">
<time datetime="2013-10-23T00:00:00" pubdate data-updated="true"></time>
</p>
</header>
<div class="entry-content">
     <p>So I&rsquo;ve finished implementing gunzip in Julia! I paired with a lot of
wonderful people along the way, so I ended up trying to explain how the file
format works a lot of times, probably often in a fairly confused way (sorry!).
Here is another disorganized attempt at explaining gzip, mainly for my own
benefit.</p>

<p>The basic idea behind gzip (aka the DEFLATE algorithm) is that there are 2 passes:</p>

<ol>
<li>LL87 pass: Replace repeated sequences with pointers to where they appeared
previously in the text. There is a good diagram of this at the beginning of
<a href="http://www.infinitepartitions.com/art001.html">this page</a></li>
<li>Huffman coding pass: Use Huffman coding to represent the text and pointers in an efficient way</li>
</ol>

<p>There is a pretty good explanation of what Huffman coding is on the
<a href="http://www.infinitepartitions.com/art001.html">aforementioned page</a>, so I&rsquo;m
just going to go ahead and talk about the gzip file format. Probably this will
make no sense if you have not been absorbed in gzip for the last 5 days.</p>

<p>That said, here is how a gzip file is laid out, and some of the code I wrote to
decode it. The github repository is here: <a href="http://github.com/jvns/gzip.jl">github.com/jvns/gzip.jl</a></p>

<p></p>

<h2 id="gzip-headers-and-metadata-20-bytes-or-so">Gzip headers and metadata (20 bytes or so)</h2>

<p>This part of the file isn&rsquo;t that interesting. Every gzip file has to start
with the magic bits <code>1F86</code>. There is a 9 byte header, followed by some
variable length metadata, which includes the filename and some other stuff.
I am not sure why the filename is included in the metadata!</p>

<p>Apparently gunzip also knows how to deflate some other legacy compression
format, but for our purposes <code>compression_method</code> is always <code>8</code>.</p>

<p>Here are the Julia data structures I used to store the header &amp; metadata:</p>

<pre><code>type GzipHeader
  id::Vector{Uint8} # length 2
  compression_method::Uint8
  flags::GzipFlags
  mtime::Vector{Uint8} # length 4
  extra_flags::Uint8
  os::Uint8
end
</code></pre>

<pre><code>type GzipMetadata
  header::GzipHeader
  xlen::Uint16
  extra::ASCIIString
  fname::ASCIIString
  fcomment::ASCIIString
  crc16::Uint16
end
</code></pre>

<h2 id="blocks">Blocks!</h2>

<p>The rest of the gzip file after the headers and metadata is a series of
blocks, to be read in order. As far as I can tell it is impossible to
decompress gzip files in parallel &ndash; there&rsquo;s no way to know when a block
has ended without fully decompressing it.</p>

<h3 id="block-header-3-bits">Block header (3 bits)</h3>

<p>Each block starts with 3 bits indicating</p>

<ul>
<li>Whether this block is the last block (1 bit)</li>
<li>How the block is compressed (2 bits). My gunzip only supports one compression method,
though one of the options is &ldquo;not compressed&rdquo;, so that would be easy to add.</li>
</ul>

<h3 id="header-for-the-huffman-codes-14-bits">Header for the Huffman codes (14 bits)</h3>

<p>There is a recursive thing going on where there is a Huffman tree encoded with
another Huffman tree. This header is the metadata that helps you get started
with reading all these trees.</p>

<ul>
<li><code>hclen</code> is the number of codes in the first tree (minus four)</li>
<li><code>hlit</code>: the number of &lsquo;literal codes&rsquo; in the second tree</li>
<li><code>hdist</code>: the number of &lsquo;distance codes&rsquo; (minus one) in the second tree</li>
</ul>

<p>This minus four and minus one business basically drove me insane. But they are
easy to represent at least:</p>

<pre><code>type HuffmanHeader
    hlit::Uint8
    hdist::Uint8
    hclen::Uint8
end
</code></pre>

<h3 id="code-lengths-for-first-huffman-tree-hclen-4-3-bits">Code lengths for first Huffman tree (<code>(hclen + 4) * 3</code> bits)</h3>

<p>Next, there is a series of numbers from 0 to 7 which you can use to put
together a Huffman tree. I read these in <code>read_first_tree()</code>.</p>

<h3 id="code-lengths-for-second-huffman-tree-unknown-number-of-bits">Code lengths for second Huffman tree (unknown number of bits)</h3>

<p>The second Huffman tree&rsquo;s code lengths are encoded using the first Huffman tree.</p>

<p>So you have to read <code>(258 + hlit + hdist)</code> code lengths, using the first
Huffman tree as your guide. I read these in <code>read_second_tree_codes()</code></p>

<p>You actually end up with two Huffman trees here &ndash; they&rsquo;re called
<code>literal_tree</code> and <code>distance_tree</code>.  <code>literal_tree</code> is made from the first
<code>257 + hlit</code> codes, and <code>distance_tree</code> is made from the next <code>hdist + 1</code>
codes. This was really not obvious and took me forever to figure out.</p>

<h3 id="the-compressed-data-unknown-number-of-bits">The compressed data! (unknown number of bits)</h3>

<p>To read the compressed data, you have to</p>

<ol>
<li>Read a code

<ol>
<li>If it&rsquo;s the stop code, stop!</li>
<li>If it represents a literal character (like &lsquo;a&rsquo; or &lsquo;2&rsquo;), just add it to the decoded text</li>
<li>If it instead represents a pointer to some previous text, figure out the length and the relative distance and copy the text.</li>
</ol></li>
</ol>

<p>Here is the actual code I wrote to do this!</p>

<pre><code>function inflate_block!(decoded_text, bs::BitStream, literal_tree::HuffmanTree, distance_tree::HuffmanTree)
    while true
    	# Read a code from the file
        code = read_huffman_bits(bs, literal_tree)
        if code == 256 # Stop code; end of block!
            break
        end
        if code &lt;= 255 # ASCII character
            append!(decoded_text, [convert(Uint8, code)])
        else # Pointer to previous text
            len = read_length_code(bs, code)
            distance = read_distance_code(bs, distance_tree)
            # Copy the previous text into our decoded text
            copy_text!(decoded_text, distance, len)
        end
    end
    return decoded_text
end
</code></pre>

<h3 id="main-function-for-reading-a-block">Main function for reading a block!</h3>

<p>And here&rsquo;s the main block-reading function! It does a lot of things, but it
came out in (I thought) a fairly readable way.</p>

<p>It modifies <code>decoded_text</code> in place because it turns out that blocks can refer
to text in previous blocks. So there needs to be some shared state.</p>

<pre><code>function inflate_block!(decoded_text, bs::BitStream)
    head = read(bs, HuffmanHeader)
    
    # Read the first Huffman tree
    first_tree = read_first_tree(bs, head.hclen)

    # Read the codes for the second Huffman tree
    codes = read_second_tree_codes(bs, head, first_tree)
    
    # Put together the tree of literals (0 - 255), stop code (256), and length codes (257-285ish)
    literal_codes = codes[1:257 + head.hlit]
    lit_code_table = create_code_table(literal_codes, [0:length(literal_codes)-1])
    literal_tree = create_huffman_tree(lit_code_table)
    
    # Put together the tree of distance codes (0-17)
    distance_codes = codes[end-head.hdist:end]
    dist_code_table = create_code_table(distance_codes, [0:length(distance_codes)-1])
    distance_tree = create_huffman_tree(dist_code_table)
    
    return inflate_block!(decoded_text, bs, literal_tree, distance_tree)
end
</code></pre>
</div>
<footer>
<div class="sharing">
<a href="http://twitter.com/share" class="twitter-share-button" data-url="https://jvns.ca/blog/2013/10/23/day-15-how-gzip-works/" data-via="b0rk" data-counturl="https://jvns.ca/blog/2013/10/23/day-15-how-gzip-works/">Tweet</a>
</div>
<p class="meta">
   
    <a class="basic-alignment left" href="https://jvns.ca/blog/2013/10/24/do-rails-programmers-use-node-visualizing-correlations-in-command-usage/" title="Previous Post: Do Rails programmers use node.js? Visualizing correlations in command usage">Do Rails programmers use node.js? Visualizing correlations in command usage</a>
  
   
    <a class="basic-alignment right" href="https://jvns.ca/blog/2013/10/22/day-14-apparently-i-should-write-tests/" title="Previous Post: Day 14: When it&#39;s hard to write tests, that&#39;s when I should be testing">Day 14: When it&#39;s hard to write tests, that&#39;s when I should be testing</a>
  
</p>
</footer>
</article>
</div>

</div>
</div>
<nav role="navigation" class="footer-nav"> <a href="/">Archives</a>
</nav>
<footer role="contentinfo"><span class="credit">&copy; 2016 Polina Soshnin.
</footer>
</div>
</body>
</html>

