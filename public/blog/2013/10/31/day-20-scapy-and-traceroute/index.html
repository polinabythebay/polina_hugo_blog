
<!DOCTYPE html>


<html class="no-js" lang="en">
<head>
<meta charset="utf-8">
<title>Day 20: Traceroute in 15 lines of code using Scapy - Polina Soshnin</title>
<meta name="author" content="Julia Evans">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="description" content="Day 20: Traceroute in 15 lines of code using Scapy">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="canonical" href="https://jvns.ca/blog/2013/10/31/day-20-scapy-and-traceroute/">
<link href="/favicon.ico" rel="icon">
<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
<link href="/atom.xml" rel="alternate" title="Julia Evans" type="application/atom+xml">
 
<link href="https://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='https://fonts.googleapis.com/css?family=Montserrat:700,400' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Alegreya:400,900,700' rel='stylesheet' type='text/css'>
</head>
<body>
<div id="wrap">
<header role="banner">
<hgroup>
<h1><a href="/">Polina Soshnin</a></h1>
</hgroup>
<ul class="header-links">
<span><li><a href="/about">About</a></li>
<li><a href="/projects">Projects</a></li></span>
    <li><a href="https://github.com/polinadotio">Github</a></li></span>
    <li><a href="https://www.linkedin.com/in/polinasoshnin">LinkedIn</a></li></span>
</ul>
</header>
<nav role="navigation" class="header-nav"><ul class="main-navigation">
<li><a href="/categories/favorite/">Favorites</a></li>
<li><a href="/zines">Zines</a></li>
</ul>
</nav>
<div id="main">
<div id="content">

<div>
<article class="hentry" role="article">
<header>
<h1 class="entry-title">Day 20: Traceroute in 15 lines of code using Scapy</h1>

<div class="post-tags">
  
  •
  
    <a class="post-tag" href="/categories/hackerschool">hackerschool</a> 	•
  
    <a class="post-tag" href="/categories/favorite">favorite</a> 	•
  
    <a class="post-tag" href="/categories/how-things-work">how-things-work</a> 	•
  
    <a class="post-tag" href="/categories/networking">networking</a> 	•
  
  
</div>
<p class="meta">
<time datetime="2013-10-31T00:00:00" pubdate data-updated="true"></time>
</p>
</header>
<div class="entry-content">
     <p>Today Jari and Brian explained a whole bunch of things to me about networks!
It was fantastic. It&rsquo;s amazing to have people with so much experience to ask
questions.</p>

<p>At the end they mentioned that I should look up how <code>traceroute</code> works and
that it&rsquo;s a pretty popular networking-job-interview question. And I&rsquo;d just
discovered this super cool Python networking library called
<a href="http://www.secdev.org/projects/scapy/">Scapy</a> which lets you construct
packets really easily. So I thought I&rsquo;d implement traceroute using scapy!</p>

<p>I thought it would take a long time, but turns out that (a basic version) is
really easy.</p>

<p>So using scapy, you can create IP and UDP packets like this:</p>

<pre><code>from scapy.all import *
ip_packet = IP(dst=&quot;hackerschool.com&quot;, ttl=10)
udp_packet = UDP(dport=40000)
full_packet = IP(dst=&quot;hackerschool.com&quot;, ttl=10) / UDP(dport=40000)
</code></pre>

<p>Then you can send a packet like this:</p>

<p><code>
send(full_packet)
</code></p>

<p>So IP packets have a <code>ttl</code> attribute, which stands for &ldquo;Time-To-Live&rdquo;. Every
time a machine receives an IP packet, it decreases the <code>ttl</code> by 1 and passes
it on. Basically this is a super smart way to make sure that packets don&rsquo;t get
into infinite loops.</p>

<p>If a packet&rsquo;s <code>ttl</code> runs out before it replies, the last machine sends back an
ICMP packet saying &ldquo;sorry, failed!&rdquo;.</p>

<p>To implement traceroute, we send out a UDP packet with <code>ttl=i</code> for <code>i =
1,2,3,...</code>. Then we look at the reply packet and see if it&rsquo;s a &ldquo;Time ran out&rdquo;
or &ldquo;That port doesn&rsquo;t exist&rdquo; error message. In the first case, we keep going,
and in the second case we&rsquo;re done.</p>

<p>Here&rsquo;s the code! It&rsquo;s 16 lines including comments and everything.</p>

<pre><code>from scapy.all import *
hostname = &quot;google.com&quot;
for i in range(1, 28):
    pkt = IP(dst=hostname, ttl=i) / UDP(dport=33434)
    # Send the packet and get a reply
    reply = sr1(pkt, verbose=0)
    if reply is None:
        # No reply =(
        break
    elif reply.type == 3:
        # We've reached our destination
        print &quot;Done!&quot;, reply.src
        break
    else:
        # We're in the middle somewhere
        print &quot;%d hops away: &quot; % i , reply.src
</code></pre>

<p>The output looks like:</p>

<pre>
<code>
1 hops away:  192.168.1.1
2 hops away:  24.103.20.129
3 hops away:  184.152.112.73
4 hops away:  184.152.112.73
5 hops away:  107.14.19.22
...
</code>
</pre>

<p>So it turns out traceroute is kind of easy! Apparently the difference between
traceroute on Windows and Unix is that Unix generally sends UDP packets and
Windows sends ICMP packets.</p>

<p>There&rsquo;s also <code>tcptraceroute</code> which, well, sends TCP packets.</p>

</div>
<footer>
<div class="sharing">
<a href="http://twitter.com/share" class="twitter-share-button" data-url="https://jvns.ca/blog/2013/10/31/day-20-scapy-and-traceroute/" data-via="b0rk" data-counturl="https://jvns.ca/blog/2013/10/31/day-20-scapy-and-traceroute/">Tweet</a>
</div>
<p class="meta">
   
    <a class="basic-alignment left" href="https://jvns.ca/blog/2013/10/31/day-19-i-might-understand-why-networking-is-hard/" title="Previous Post: Day 19: A few reasons why networking is hard">Day 19: A few reasons why networking is hard</a>
  
   
    <a class="basic-alignment right" href="https://jvns.ca/blog/2013/10/29/day-18-in-ur-connection/" title="Previous Post: Day 18: ARP cache poisoning (or: In ur connection, sniffing ur packets)">Day 18: ARP cache poisoning (or: In ur connection, sniffing ur packets)</a>
  
</p>
</footer>
</article>
</div>

</div>
</div>
<nav role="navigation" class="footer-nav"> <a href="/">Archives</a>
</nav>
<footer role="contentinfo"><span class="credit">&copy; 2016 Polina Soshnin.
</footer>
</div>
</body>
</html>

