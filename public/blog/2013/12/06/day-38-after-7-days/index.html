
<!DOCTYPE html>


<html class="no-js" lang="en">
<head>
<meta charset="utf-8">
<title>Day 38: After 6 days, I have problems that I can&#39;t understand at all - Polina Soshnin</title>
<meta name="author" content="Julia Evans">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="description" content="Day 38: After 6 days, I have problems that I can&#39;t understand at all">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="canonical" href="https://jvns.ca/blog/2013/12/06/day-38-after-7-days/">
<link href="/favicon.ico" rel="icon">
<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
<link href="/atom.xml" rel="alternate" title="Julia Evans" type="application/atom+xml">
 
<link href="https://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='https://fonts.googleapis.com/css?family=Montserrat:700,400' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Alegreya:400,900,700' rel='stylesheet' type='text/css'>
</head>
<body>
<div id="wrap">
<header role="banner">
<hgroup>
<h1><a href="/">Polina Soshnin</a></h1>
</hgroup>
<ul class="header-links">
<span><li><a href="/about">About</a></li>
<li><a href="/projects">Projects</a></li></span>
    <li><a href="https://github.com/polinadotio">Github</a></li></span>
    <li><a href="https://www.linkedin.com/in/polinasoshnin">LinkedIn</a></li></span>
</ul>
</header>
<nav role="navigation" class="header-nav"><ul class="main-navigation">
<li><a href="/categories/favorite/">Favorites</a></li>
<li><a href="/zines">Zines</a></li>
</ul>
</nav>
<div id="main">
<div id="content">

<div>
<article class="hentry" role="article">
<header>
<h1 class="entry-title">Day 38: After 6 days, I have problems that I can&#39;t understand at all</h1>

<div class="post-tags">
  
  •
  
    <a class="post-tag" href="/categories/kernel">kernel</a> 	•
  
    <a class="post-tag" href="/categories/rust">rust</a> 	•
  
    <a class="post-tag" href="/categories/hackerschool">hackerschool</a> 	•
  
  
</div>
<p class="meta">
<time datetime="2013-12-06T00:00:00" pubdate data-updated="true"></time>
</p>
</header>
<div class="entry-content">
     <p>tl;dr: I expect <code>NUMS[2]</code> to equal <code>NUMS[keycode]</code> when <code>keycode ==
2</code>. This doesn&rsquo;t appear to be the case, and I don&rsquo;t understand how
this is possible.</p>

<p>I&rsquo;m trying to set up keycode handling in my kernel, and I&rsquo;m having a
strange problem with array indexing that I can&rsquo;t really fathom at all
(except &ldquo;something is wrong&rdquo;).</p>

<p>When I run this code, and press <code>1</code> several times, it prints <code>|2C |2C |2C |2C |2C |2C |2C |2C |2C</code>.</p>

<p>I am expecting it to print <code>|2C2|2C2|2C2|2C2|2C2|2C2|2C2|2C2|2C2|</code>.</p>

<p>Here is the code:</p>

<pre><code>// some imports removed
static NUMS: &amp;'static [u8] = bytes!(&quot;01234567890&quot;);

#[no_mangle]
pub unsafe fn _interrupt_handler_kbd() {
    let keycode: u8 = inb(0x60);
    if (keycode == 2 || keycode == 3) {
        stdio::putc(NUMS[2]); // should be '2'. It is.
        stdio::putc(65 + keycode); // should be 'C' (keycode = 2), because 'A' is 65 
        stdio::putc(NUMS[keycode]); // should be '2', BUT IT ISN'T. IT IS SOMETHING ELSE. HOW IS THIS HAPPENING. 
        stdio::putc(124); /// this is '|', just as a delimiter.
    }
    outb(0x20, 0x20); // Tell the interrupt handler that we're done.
}
</code></pre>

<p>To summarize:</p>

<ul>
<li>the <code>2</code> is printed by <code>putc(NUMS[2])</code></li>
<li>the <code>C</code> is printed by <code>putc(65 + keycode)</code>. This implies that <code>keycode == 2</code>, since 65 is &lsquo;A&rsquo;</li>
<li>the blank space is printed by <code>putc(NUMS[keycode])</code>. I would expect this to print <code>2</code>. But no.</li>
</ul>

<p>For bonus points, if I replace <code>if (keycode == 2 || keycode == 3) {</code>
with <code>if(keycode == 2) {</code>, then it prints
<code>|2C2|2C2|2C2|2C2|2C2|2C2|2C2|2C2|2C2|</code>, which is right. I think this
is because of a compiler optimization replacing <code>keycode</code> with <code>2</code>.</p>

<p>If you have <code>qemu</code> and a nightly build of <code>rust</code> installed, you can
run this code by doing</p>

<pre><code>git clone git@github.com:jvns/rustboot.git
cd rustboot
git checkout origin/compiler-nonsense
git submodule init
git submodule update
make run
</code></pre>

<p>Some hypotheses:</p>

<ul>
<li>There&rsquo;s something wrong with the Rust compiler</li>
<li>There&rsquo;s something wrong with the stack and how I&rsquo;m calling
<code>_interrupt_handler_kbd</code></li>
<li>?????????</li>
</ul>

<p>I also can&rsquo;t yet find the address of <code>_interrupt_handler_kbd</code> to look
at the assembly to debug. It&rsquo;s in the symbol table of the original
object file (<code>main.o</code>), but after linking it&rsquo;s not in <code>main.bin</code>, so I
can&rsquo;t set a breakpoint in gdb.</p>

<p>Ack.</p>

<p><strong>Edit:</strong> <a href="http://brian.mastenbrook.net/">Brian Mastenbrook</a> suggested
to link using ELF and then use objcopy to create a binary, and that
somehow magically fixed the problem
(<a href="https://github.com/jvns/rustboot/commit/2dab3a8ca693a1754b498f05472670e15343bb07">this commit</a>).
If anyone can explain why, I would be Extremely Interested.</p>

</div>
<footer>
<div class="sharing">
<a href="http://twitter.com/share" class="twitter-share-button" data-url="https://jvns.ca/blog/2013/12/06/day-38-after-7-days/" data-via="b0rk" data-counturl="https://jvns.ca/blog/2013/12/06/day-38-after-7-days/">Tweet</a>
</div>
<p class="meta">
   
    <a class="basic-alignment left" href="https://jvns.ca/blog/2013/12/10/day-40-learning-about-linkers/" title="Previous Post: Day 40: Linkers are amazing.">Day 40: Linkers are amazing.</a>
  
   
    <a class="basic-alignment right" href="https://jvns.ca/blog/2013/12/04/day-37-how-a-keyboard-works/" title="Previous Post: Day 37: After 5 days, my OS doesn&#39;t crash when I press a key">Day 37: After 5 days, my OS doesn&#39;t crash when I press a key</a>
  
</p>
</footer>
</article>
</div>

</div>
</div>
<nav role="navigation" class="footer-nav"> <a href="/">Archives</a>
</nav>
<footer role="contentinfo"><span class="credit">&copy; 2016 Polina Soshnin.
</footer>
</div>
</body>
</html>

