
<!DOCTYPE html>


<html class="no-js" lang="en">
<head>
<meta charset="utf-8">
<title>Day 36: On programming without malloc - Polina Soshnin</title>
<meta name="author" content="Julia Evans">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="description" content="Day 36: On programming without malloc">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="canonical" href="https://jvns.ca/blog/2013/12/03/day-36-programming-without-malloc/">
<link href="/favicon.ico" rel="icon">
<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
<link href="/atom.xml" rel="alternate" title="Julia Evans" type="application/atom+xml">
 
<link href="https://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='https://fonts.googleapis.com/css?family=Montserrat:700,400' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Alegreya:400,900,700' rel='stylesheet' type='text/css'>
</head>
<body>
<div id="wrap">
<header role="banner">
<hgroup>
<h1><a href="/">Polina Soshnin</a></h1>
</hgroup>
<ul class="header-links">
<span><li><a href="/about">About</a></li>
<li><a href="/projects">Projects</a></li></span>
    <li><a href="https://github.com/polinadotio">Github</a></li></span>
    <li><a href="https://www.linkedin.com/in/polinasoshnin">LinkedIn</a></li></span>
</ul>
</header>
<nav role="navigation" class="header-nav"><ul class="main-navigation">
<li><a href="/categories/favorite/">Favorites</a></li>
<li><a href="/zines">Zines</a></li>
</ul>
</nav>
<div id="main">
<div id="content">

<div>
<article class="hentry" role="article">
<header>
<h1 class="entry-title">Day 36: On programming without malloc</h1>

<div class="post-tags">
  
  •
  
    <a class="post-tag" href="/categories/kernel">kernel</a> 	•
  
    <a class="post-tag" href="/categories/favorite">favorite</a> 	•
  
    <a class="post-tag" href="/categories/rust">rust</a> 	•
  
    <a class="post-tag" href="/categories/hackerschool">hackerschool</a> 	•
  
  
</div>
<p class="meta">
<time datetime="2013-12-03T00:00:00" pubdate data-updated="true"></time>
</p>
</header>
<div class="entry-content">
     <p>So right now I&rsquo;m working on writing a kernel in Rust. My current goal
is to press keys on the keyboard and have them echoed to the screen.
This is going okay! I anticipate being able to type by the end of the
week.</p>

<p>One thing that&rsquo;s interesting is that my expectations around what
programs should be able to do is really different right now. Normally
I write Python or other high-level languages, so my programs don&rsquo;t run
too quickly, but have tons of resources available to them (the
Internet, a standard library, memory allocation, garbage collection,
&hellip;).</p>

<p>Writing operating systems is totally different. This is kind of
obvious, but actually doing it is really fascinating. My OS literally
can&rsquo;t allocate memory, and there&rsquo;s no standard way to print (I have to
write to the VGA buffer manually). I can still write loops, though, and
in general writing Rust doesn&rsquo;t feel too unfamiliar. But I expect my
code to run super fast, because it has no excuse not to :). Right now
I definitely don&rsquo;t have timers or anything, so I&rsquo;m looping 80,000,000
times to sleep.</p>

<p>A few things that I can&rsquo;t do that I&rsquo;m used to being able to do:</p>

<ul>
<li>allocate memory</li>
<li>print (I can sort of do this)</li>
<li><code>sleep</code></li>
<li>run other processes (there are no other programs)</li>
<li>read from stdin (I don&rsquo;t have a keyboard driver yet. There is no stdin.)</li>
<li>open files (there are no files)</li>
<li>list files (there are no files)</li>
</ul>

<p>(thanks to <a href="http://instamatique.com/lea/">Lea</a> for &ldquo;there are no
files&rdquo; =D)</p>

<p>The only real problem with not having <code>malloc</code> is that all the memory
I use has to either be</p>

<ul>
<li>in the program at compile time, or</li>
<li>allocated on the stack</li>
</ul>

<p>This is less difficult than I expected it to be! We&rsquo;ll see how it
continues. It does mean that I use a lot of global variables, and it&rsquo;s
given me an appreciation for why there is so much use of global
variables in the Linux kernel &ndash; if just need 1 struct, it makes so
much more sense to just have 1 global struct than to keep <code>malloc</code>ing
and <code>free</code>ing it all the time.</p>

<p>Here&rsquo;s an example of some code I have in the kernel! <code>main()</code> prints
all the ASCII characters in a loop.</p>

<pre><code>pub unsafe fn putchar(x: u16, y: u16, c: u8) {
    let idx : uint =  (y * VGA_WIDTH * 2 + x * 2) as uint;
    // 0xb8000 is the VGA buffer
    *((0xb8000 + idx) as *mut u16) = make_vgaentry(c, Black, Yellow);
}

fn make_vgaentry(c: u8, fg: Color, bg: Color) -&gt; u16 {
    // VGA entries are 2 bytes. The first byte is the character, the
    second is the colour
    let color = fg as u16 | (bg as u16 &lt;&lt; 4);
    return c as u16 | (color &lt;&lt; 8);
}

pub unsafe fn main() {
    let mut i: u32 = 0;
    let mut c: u8 = 65; // 'A'
    let N: u32 = 80000000; // big enough number so that it goes slowly
    loop {
        i += 1;
        if (i % N == 0) {
            c += 1;
            putchar(2, 4, c);
        }
    }
}
</code></pre>

<p><small>
Note for pedants: I actually do have a <code>malloc</code> function because my
Rust standard library needs to link against it, but it&rsquo;s defined like
this:</p>

<pre><code>malloc:
    jmp $
</code></pre>

<p>That&rsquo;s assembly-speak for &ldquo;loop forever&rdquo;. If I get around to
implementing <code>malloc</code> it will be the Most Exciting Thing
~~~
</small></p>

</div>
<footer>
<div class="sharing">
<a href="http://twitter.com/share" class="twitter-share-button" data-url="https://jvns.ca/blog/2013/12/03/day-36-programming-without-malloc/" data-via="b0rk" data-counturl="https://jvns.ca/blog/2013/12/03/day-36-programming-without-malloc/">Tweet</a>
</div>
<p class="meta">
   
    <a class="basic-alignment left" href="https://jvns.ca/blog/2013/12/04/day-37-how-a-keyboard-works/" title="Previous Post: Day 37: After 5 days, my OS doesn&#39;t crash when I press a key">Day 37: After 5 days, my OS doesn&#39;t crash when I press a key</a>
  
   
    <a class="basic-alignment right" href="https://jvns.ca/blog/2013/12/02/types-in-rust/" title="Previous Post: Day 35: Types in Rust, for beginners">Day 35: Types in Rust, for beginners</a>
  
</p>
</footer>
</article>
</div>

</div>
</div>
<nav role="navigation" class="footer-nav"> <a href="/">Archives</a>
</nav>
<footer role="contentinfo"><span class="credit">&copy; 2016 Polina Soshnin.
</footer>
</div>
</body>
</html>

