
<!DOCTYPE html>


<html class="no-js" lang="en">
<head>
<meta charset="utf-8">
<title>What happens when you run &#39;Hello, world&#39; - Polina Soshnin</title>
<meta name="author" content="Julia Evans">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="description" content="What happens when you run &#39;Hello, world&#39;">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="canonical" href="https://jvns.ca/blog/2013/11/29/what-happens-when-you-run-a-unix-program/">
<link href="/favicon.ico" rel="icon">
<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
<link href="/atom.xml" rel="alternate" title="Julia Evans" type="application/atom+xml">
 
<link href="https://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='https://fonts.googleapis.com/css?family=Montserrat:700,400' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Alegreya:400,900,700' rel='stylesheet' type='text/css'>
</head>
<body>
<div id="wrap">
<header role="banner">
<hgroup>
<h1><a href="/">Polina Soshnin</a></h1>
</hgroup>
<ul class="header-links">
<span><li><a href="/about">About</a></li>
<li><a href="/projects">Projects</a></li></span>
    <li><a href="https://github.com/polinadotio">Github</a></li></span>
    <li><a href="https://www.linkedin.com/in/polinasoshnin">LinkedIn</a></li></span>
</ul>
</header>
<nav role="navigation" class="header-nav"><ul class="main-navigation">
<li><a href="/categories/favorite/">Favorites</a></li>
<li><a href="/zines">Zines</a></li>
</ul>
</nav>
<div id="main">
<div id="content">

<div>
<article class="hentry" role="article">
<header>
<h1 class="entry-title">What happens when you run &#39;Hello, world&#39;</h1>

<div class="post-tags">
  
  •
  
    <a class="post-tag" href="/categories/hackerschool">hackerschool</a> 	•
  
    <a class="post-tag" href="/categories/kernel">kernel</a> 	•
  
    <a class="post-tag" href="/categories/favorite">favorite</a> 	•
  
  
</div>
<p class="meta">
<time datetime="2013-11-29T00:00:00" pubdate data-updated="true"></time>
</p>
</header>
<div class="entry-content">
     

<p>So today I experimented with a new way of learning &ndash; I wanted to
understand what happens when I run a &ldquo;hello world&rdquo; program, but I
wasn&rsquo;t at Hacker School. So I wrote down my current understanding and
a bunch of questions and asked Twitter!</p>

<p><blockquote class="twitter-tweet" lang="en"><p>if anyone has too much time and operating system knowledge, I&#39;d love comments and &quot;well, actually&quot;s on <a href="https://t.co/YqSyV5ap4Q">https://t.co/YqSyV5ap4Q</a></p>&mdash; Julia Evans (@b0rk) <a href="https://twitter.com/b0rk/statuses/406082448288522240">November 28, 2013</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script></p>

<p>People left me tons of helpful comments in
<a href="https://gist.github.com/jvns/7688286/">the gist</a>, which made me
really happy.</p>

<p>I&rsquo;m not going to reprise all of the discussion here, but here&rsquo;s an
incomplete summary of what needs to happen when a kernel runs an
executable. If you&rsquo;re interested, definitely check out
<a href="https://gist.github.com/jvns/7688286/">the gist</a>.</p>

<h2 id="the-question-if-i-were-an-os-what-would-i-need-to-do-to-run-hello-world">The question: If I were an OS, what would I need to do to run &ldquo;Hello, world?&rdquo;</h2>

<p>The original program was</p>

<pre><code>#include &lt;stdio.h&gt;
int main() {
    printf(&quot;Hello!\n&quot;);
}
</code></pre>

<p>and I statically compiled it by running <code>gcc -static -o hello hello.c</code>.
So we don&rsquo;t have to worry about dynamic linking or anything. (I very
much enjoyed
<a href="http://www.lurklurk.org/linkers/linkers.html">this guide to linkers</a>,
tangentially)</p>

<h3 id="step-0-simplify-the-program-a-bit">Step 0: Simplify the program a bit</h3>

<p>The first suggestion I got was to make it a bit easier by using
<code>write()</code> instead of <code>printf()</code>.</p>

<p>Running <code>strace ./hello</code> tells me all the system calls that happen,
including the <code>write()</code> system call:</p>

<pre><code>write(1, &quot;Hello world!\n&quot;, 13)
</code></pre>

<p>So we can simplify this program down to</p>

<pre><code>int main() {
  write(1, &quot;Hello world!\n&quot;, 13);
}
</code></pre>

<p>which removes the <code>#include</code> and some of the system calls. <code>printf()</code>
is a pretty complicated function, so it&rsquo;s better to not use it.</p>

<p>Now we can get down to the actual business of describing what happens
when the program executes! These are not in any particular order.</p>

<h3 id="load-the-code-text-http-en-wikipedia-org-wiki-code-segment-into-memory">Load the <a href="http://en.wikipedia.org/wiki/Code_segment">code (&ldquo;text&rdquo;)</a> into memory</h3>

<p>In the binary there are a bunch of assembler instructions. These need
to be loaded into memory.</p>

<h3 id="load-the-data-segment-http-en-wikipedia-org-wiki-data-segment-into-memory">Load the <a href="http://en.wikipedia.org/wiki/Data_segment">data segment</a> into memory</h3>

<p>A program might also have initialized and uninitialized global
variables. These need a place in memory.</p>

<p>I&rsquo;d need to zero out the <a href="http://en.wikipedia.org/wiki/.bss">BSS</a> out
here for sure.</p>

<h3 id="set-up-the-heap-and-stack">Set up the heap and stack</h3>

<p>Programs need a heap and a stack.</p>

<p>Once these three things are done, we have the program&rsquo;s &ldquo;address
space&rdquo; in memory. This looks something like this (thanks to
<a href="http://github.com/danellis">@danellis</a> for the diagram!)</p>

<pre>
+---------------+
|    Stack      |
|      |        |
|      v        |
+---------------+
:               :
+---------------+
|      ^        |
|      |        |
|     Heap      |
+---------------+
|     Data      |
+---------------+
|     Code      |
+---------------+
</pre>

<p>I&rsquo;m still really not sure about the details of what this set up looks
like &ndash; people talk a lot about virtual memory and I don&rsquo;t know how I
would implement that at all or if I would have to implement it.</p>

<h3 id="handle-system-calls">Handle system calls</h3>

<p>User space programs interact with the kernel through &ldquo;system calls&rdquo;.</p>

<p>If I run <code>strace -o hello.out ./hello</code>, I get this list of all the
system calls that happen when running <code>./hello</code>:</p>

<pre><code>execve(&quot;./hello2&quot;, [&quot;./hello2&quot;], [/* 59 vars */]) = 0
uname({sys=&quot;Linux&quot;, node=&quot;kiwi&quot;, ...})  = 0
brk(0)                                  = 0xca9000
brk(0xcaa1c0)                           = 0xcaa1c0
arch_prctl(ARCH_SET_FS, 0xca9880)       = 0
brk(0xccb1c0)                           = 0xccb1c0
brk(0xccc000)                           = 0xccc000
write(1, &quot;Hello world!\n&quot;, 13)          = 13
exit_group(13)                          = ?
</code></pre>

<p>I don&rsquo;t think I have to worry about the first two system calls, since
the first one is definitely called by my shell.</p>

<p>The <code>brk</code> system call is about moving the &ldquo;program break&rdquo; to allocate
memory. I&rsquo;m not totally sure why it needs to allocate memory, but it
does.</p>

<p>The <code>write</code> system call I definitely feel like I could handle &ndash; I
found an <a href="http://wiki.osdev.org/Bare_Bones">example on the OSDev wiki</a>
of how to write to a VGA buffer, so that could work.</p>

<p>I&rsquo;m guessing <code>exit_group</code> is about quitting the program, so I&rsquo;d have
to do some cleanup or something. I have no idea what <code>arch_prctl</code> is.</p>

<p>I&rsquo;m hoping to actually do some of this in the coming week at Hacker
School. I&rsquo;ve been pointed to the
<a href="http://wiki.osdev.org/Main_Page">OSDev wiki</a> which has all kinds of
fantastic explanations and tutorials.</p>

</div>
<footer>
<div class="sharing">
<a href="http://twitter.com/share" class="twitter-share-button" data-url="https://jvns.ca/blog/2013/11/29/what-happens-when-you-run-a-unix-program/" data-via="b0rk" data-counturl="https://jvns.ca/blog/2013/11/29/what-happens-when-you-run-a-unix-program/">Tweet</a>
</div>
<p class="meta">
   
    <a class="basic-alignment left" href="https://jvns.ca/blog/2013/11/30/videos-from-pydata-nyc-are-up/" title="Previous Post: Videos from PyData NYC are up!">Videos from PyData NYC are up!</a>
  
   
    <a class="basic-alignment right" href="https://jvns.ca/blog/2013/11/29/writing-an-os-using-rustboot-and-rust-core/" title="Previous Post: Writing a kernel using rustboot &amp; rust-core">Writing a kernel using rustboot &amp; rust-core</a>
  
</p>
</footer>
</article>
</div>

</div>
</div>
<nav role="navigation" class="footer-nav"> <a href="/">Archives</a>
</nav>
<footer role="contentinfo"><span class="credit">&copy; 2016 Polina Soshnin.
</footer>
</div>
</body>
</html>

