
<!DOCTYPE html>


<html class="no-js" lang="en">
<head>
<meta charset="utf-8">
<title>Writing a kernel using rustboot &amp; rust-core - Polina Soshnin</title>
<meta name="author" content="Julia Evans">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="description" content="Writing a kernel using rustboot &amp; rust-core">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="canonical" href="https://jvns.ca/blog/2013/11/29/writing-an-os-using-rustboot-and-rust-core/">
<link href="/favicon.ico" rel="icon">
<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
<link href="/atom.xml" rel="alternate" title="Julia Evans" type="application/atom+xml">
 
<link href="https://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='https://fonts.googleapis.com/css?family=Montserrat:700,400' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Alegreya:400,900,700' rel='stylesheet' type='text/css'>
</head>
<body>
<div id="wrap">
<header role="banner">
<hgroup>
<h1><a href="/">Polina Soshnin</a></h1>
</hgroup>
<ul class="header-links">
<span><li><a href="/about">About</a></li>
<li><a href="/projects">Projects</a></li></span>
    <li><a href="https://github.com/polinadotio">Github</a></li></span>
    <li><a href="https://www.linkedin.com/in/polinasoshnin">LinkedIn</a></li></span>
</ul>
</header>
<nav role="navigation" class="header-nav"><ul class="main-navigation">
<li><a href="/categories/favorite/">Favorites</a></li>
<li><a href="/zines">Zines</a></li>
</ul>
</nav>
<div id="main">
<div id="content">

<div>
<article class="hentry" role="article">
<header>
<h1 class="entry-title">Writing a kernel using rustboot &amp; rust-core</h1>

<div class="post-tags">
  
  •
  
    <a class="post-tag" href="/categories/kernel">kernel</a> 	•
  
    <a class="post-tag" href="/categories/hackerschool">hackerschool</a> 	•
  
    <a class="post-tag" href="/categories/rust">rust</a> 	•
  
  
</div>
<p class="meta">
<time datetime="2013-11-29T00:00:00" pubdate data-updated="true"></time>
</p>
</header>
<div class="entry-content">
     <p>Here I am again using the word &ldquo;kernel&rdquo; in a fairly broad sense :)</p>

<p>So today <a href="http://www.cs.indiana.edu/~lkuper/">Lindsey Kuper</a>, one of
the residents for next week, came by Hacker School! I spent some time
a while ago trying to learn some Rust, but got discouraged by the
scary pointers and ran away.</p>

<p>But today she pointed out that Rust is for systems programming, and
right now I <em>am</em> trying to write an operating system, and this would
be the perfect time to pick it up again!</p>

<p>So I started playing with
<a href="https://github.com/charliesome/rustboot">rustboot</a>, which is a 32-bit
kernel which turns the screen red and hangs. So far I&rsquo;ve made some
minor changes &ndash; it now turns the screen <em>green</em> and hangs.</p>

<p>But slightly more seriously, I also added a function to print
characters to the screen!</p>

<p><img src="/images/rustboot1.png"></p>

<p>Here&rsquo;s the new code I added to do that:</p>

<pre><code>unsafe fn putchar(x: u16, y: u16, c: u8) {
    let idx : uint = (y * VGA_WIDTH * 2 + x) as uint;
    // 0xb8000 is the VGA buffer
    *((0xb8000 + idx) as *mut u16) = make_vgaentry(c, Black, Yellow);
}

fn make_vgaentry(c: u8, fg: Color, bg: Color) -&gt; u16 {
    // Details of how VGA colours are stored
    let color = fg as u16 | (bg as u16 &lt;&lt; 4);
    return c as u16 | (color &lt;&lt; 8);
}

unsafe fn write(s: &amp;str, x: u16, y: u16) {
    let bytes : &amp;[u8] = to_bytes(s);
    let mut ix = x;
    let mut iy = y;
    let mut i = 0;
    for b in core::slice::iter(bytes) {
        putchar(ix, iy, *b);
        if (ix &gt; VGA_WIDTH * 2) {
            // line wrap
            ix = ix - VGA_WIDTH * 2;
            iy += 1;
        }
        i += 1;
        ix += 2;
    }
}


#[no_mangle]
pub unsafe fn main() {
    clear_screen(Green);
    write(&quot;Hello!aaa&quot;, 2, 3);
}
</code></pre>

<p>I like that I can write a loop like <code>for b in core::slice::iter(bytes)
{</code>. I still don&rsquo;t know how string length is determined &ndash; it seems
like instead of having null-terminated strings, Rust stores the size
separately. I think.</p>

<p>It&rsquo;s nice that I can write code like this without having an OS in the
background. As I mentioned before, there were quite a few gotchas &ndash;
for example, when I was trying to get the iterator to work, I got the
cryptic error message <code>error: unreachable pattern</code>, which meant that I
needed to add <code>use core::option::None</code>.</p>

<p>In all to get iterators to work I need to add:</p>

<pre><code>use core::mem::transmute; // for to_bytes()
use core::slice::iter; // for the iterator
use core::iter::Iterator; // for the loop
use core::option::{Some, Option, None}; // for the loop
mod core;
</code></pre>

<p>This small amount of accomplishment wouldn&rsquo;t have been remotely
possible without the help of the lovely people on the #rust IRC
channel &ndash; I had tons of issues using freestanding rust and rust-core,
and the <a href="https://github.com/thestinger">rust-core maintainer</a> answered
every single one of my questions. &lt;3.</p>

<p>If you wanted to do this yourself, you could do something like:</p>

<pre>
sudo apt-get install qemu nasm
git clone https://github.com/jvns/rustboot.git
cd rustboot
git checkout 1e0f2b02f45096e5300faf9e
git clone https://github.com/thestinger/rust-core.git ~/rust-core
ln -s ~/rust-core/core .
make run
</pre>

<p>Oh! Also! That code prints 9 characters to the VGA buffer correctly,
but if I try printing 10 characters, it doesn&rsquo;t work. I have no idea
why. That will be for tomorrow.</p>

</div>
<footer>
<div class="sharing">
<a href="http://twitter.com/share" class="twitter-share-button" data-url="https://jvns.ca/blog/2013/11/29/writing-an-os-using-rustboot-and-rust-core/" data-via="b0rk" data-counturl="https://jvns.ca/blog/2013/11/29/writing-an-os-using-rustboot-and-rust-core/">Tweet</a>
</div>
<p class="meta">
   
    <a class="basic-alignment left" href="https://jvns.ca/blog/2013/11/29/what-happens-when-you-run-a-unix-program/" title="Previous Post: What happens when you run &#39;Hello, world&#39;">What happens when you run &#39;Hello, world&#39;</a>
  
   
    <a class="basic-alignment right" href="https://jvns.ca/blog/2013/11/27/day-34b-wrapping-up-the-tcp-stack/" title="Previous Post: Day 34b: Writing curl using my TCP stack">Day 34b: Writing curl using my TCP stack</a>
  
</p>
</footer>
</article>
</div>

</div>
</div>
<nav role="navigation" class="footer-nav"> <a href="/">Archives</a>
</nav>
<footer role="contentinfo"><span class="credit">&copy; 2016 Polina Soshnin.
</footer>
</div>
</body>
</html>

