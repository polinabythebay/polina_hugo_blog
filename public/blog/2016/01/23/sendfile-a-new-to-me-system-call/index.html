
<!DOCTYPE html>


<html class="no-js" lang="en">
<head>
<meta charset="utf-8">
<title>Sendfile (a system call for web developers to know about!) - Polina Soshnin</title>
<meta name="author" content="Julia Evans">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="description" content="Sendfile (a system call for web developers to know about!)">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="canonical" href="https://jvns.ca/blog/2016/01/23/sendfile-a-new-to-me-system-call/">
<link href="/favicon.ico" rel="icon">
<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
<link href="/atom.xml" rel="alternate" title="Julia Evans" type="application/atom+xml">
 
<link href="https://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='https://fonts.googleapis.com/css?family=Montserrat:700,400' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Alegreya:400,900,700' rel='stylesheet' type='text/css'>
</head>
<body>
<div id="wrap">
<header role="banner">
<hgroup>
<h1><a href="/">Polina Soshnin</a></h1>
</hgroup>
<ul class="header-links">
<span><li><a href="/about">About</a></li>
<li><a href="/projects">Projects</a></li></span>
    <li><a href="https://github.com/polinadotio">Github</a></li></span>
    <li><a href="https://www.linkedin.com/in/polinasoshnin">LinkedIn</a></li></span>
</ul>
</header>
<nav role="navigation" class="header-nav"><ul class="main-navigation">
<li><a href="/categories/favorite/">Favorites</a></li>
<li><a href="/zines">Zines</a></li>
</ul>
</nav>
<div id="main">
<div id="content">

<div>
<article class="hentry" role="article">
<header>
<h1 class="entry-title">Sendfile (a system call for web developers to know about!)</h1>

<div class="post-tags">
  
  •
  
    <a class="post-tag" href="/categories/strace">strace,</a> 	•
  
    <a class="post-tag" href="/categories/kernel">kernel</a> 	•
  
  
</div>
<p class="meta">
<time datetime="2016-01-23T09:17:14" pubdate data-updated="true"></time>
</p>
</header>
<div class="entry-content">
     

<p>The other day I learned about a new (to me) exciting Linux system call! (for newcomers, a system call is an operation you can ask the operating system to do). This one seems really important to know about if you&rsquo;re configuring a webserver! So let&rsquo;s learn about it.</p>

<p>Before this, I knew about basic system calls like <code>open</code> and <code>read</code> for files, and <code>sendto</code> and <code>recvfrom</code> for networking. And a few fancier things like <code>futex</code> and <code>select</code> for mutexes and waiting.</p>

<h3 id="why-sendfile-was-invented">why sendfile was invented</h3>

<p>Suppose I want to send you a big file over a network connection. Normally I&rsquo;d just read the file incrementally, and then write the contents to the socket. So, at a minimum, we need to</p>

<ul>
<li>use <code>read</code> (requires a context switch into kernel code)</li>
<li>(implicitly, copy the data from kernel memory into user memory)</li>
<li>use <code>sendto</code> or <code>write</code> (another context switch)</li>
</ul>

<p>This means we need to copy data (bad) and use two system calls instead of one (also bad).</p>

<p>So the idea is &ndash; this pattern of reading a file and writing to a socket is really common! So they made a system call to just do that! Then the kernel can do all the work of reading and writing, and save you CPU time. And you don&rsquo;t need to copy any data around! AMAZING.</p>

<h3 id="the-performance-implications">the performance implications</h3>

<p>I found this <a href="https://code.google.com/p/pyftpdlib/issues/detail?id=152">google code discussion on a Python FTP library</a>. One person says that by using the <code>sendfile</code> system call, they could transfer 1.5GB/s instead of 800MB/s! That&rsquo;s pretty awesome for a small change.</p>

<p><a href="https://people.freebsd.org/~rrs/asiabsd_2015_tls.pdf">This paper from Netflix</a> describes using sendfile on FreeBSD to go from 6Gbps to 40Gbps of network throughput. They also talk about implementing (part of?) TLS in the kernel to improve TLS performance.</p>

<h3 id="the-disasters">the disasters</h3>

<p>I then read <a href="https://blog.phusion.nl/2015/06/04/the-brokenness-of-the-sendfile-system-call/">&ldquo;The brokenness of the sendfile() system call&rdquo;</a>. Wait?! But I thought sendfile was awesome and we should always use it? Not so!</p>

<p>That post describes how on OS X, <code>sendfile</code> wouldn&rsquo;t send <strong>any</strong> data until the socket was closed, causing up to 5 second delays. That&rsquo;s TERRIBLE. So sendfile isn&rsquo;t some kind of universal panacea, and that&rsquo;s why webservers let you turn it on and off.</p>

<h3 id="some-other-reading-on-sendfile">some other reading on sendfile</h3>

<p><a href="https://groups.google.com/forum/#!msg/golang-nuts/gdp1q6T0DNY/sFaRetnWPWIJ">Rob Pike (one of the creators of Go) thinks sendfile is &ldquo;bizarre&rdquo;</a>. I find his argument in that post pretty difficult to follow (if the kernel provides a way to do something, and that way gives you better performance in practice, why not use it?). But I thought it was interesting.</p>

<p><a href="http://tia.mat.br/posts/2014/10/06/life_of_a_http_request.html">Life of a HTTP request, as seen by my toy web server</a> is interesting, and describes how the author uses <code>sendfile</code> for large files, but not for small files. You don&rsquo;t need to write your own webserver to take advantage of this &ndash; you can configure apache and nginx to use sendfile!</p>

<p><a href="http://man7.org/linux/man-pages/man2/sendfile.2.html">The sendfile man page</a> is actually quite readable, and it tells you something very important! It recommends using the <code>TCP_CORK</code> TCP option for better network performance. We learned about how understanding TCP is important in <a href="http://jvns.ca/blog/2015/11/21/why-you-should-understand-a-little-about-tcp/">Why you should understand (a little) about TCP</a>, and that&rsquo;s pretty important here as well. In this case you need to decide whether to use <code>TCP_CORK</code> and <code>TCP_NODELAY</code>. One thing I read recommended using both.</p>

<p>You can also use sendfile to copy files quickly! (like, think about how <code>cp</code> is implemented!) <a href="http://blog.plenz.com/2014-04/so-you-want-to-write-to-a-file-real-fast.html">So you want to write to a file real fast&hellip;</a> walks through some optimizations to file copying and gets a 25% improvement by using <code>sendfile</code> and other tricks. I straced <code>cp</code> on my machine just now, and it seems like it does not use <code>sendfile</code>. It&rsquo;s super interesting to me how much abstractions break down when you&rsquo;re trying to really optimize performance.</p>

<h3 id="next-step-splice-tee">next step: <code>splice</code> &amp; <code>tee</code></h3>

<p>These days <code>sendfile</code> is a wrapper around the <code>splice</code> system call, which seems to be the same thing &ndash; copy data from one file/pipe/socket to another &ndash; but with some extra options.</p>

<p>There&rsquo;s <a href="https://web.archive.org/web/20130521163124/http://kerneltrap.org/node/6505">a neat thread on the Linux Kernel Mailing List from 2006</a>, just after those system calls came into existence, where Linus explains what they&rsquo;re for and how to think about them.</p>

<p>I found this paragraph helpful:</p>

<blockquote>
<p>Anyway, when would you actually <em>use</em> a kernel buffer? Normally you&rsquo;d use it
it you want to copy things from one source into another, and you don&rsquo;t
actually want to see the data you are copying, so using a kernel buffer allows
you to possibly do it more efficiently, and you can avoid allocating user VM
space for it</p>
</blockquote>

<p>That post also makes it clear that <code>sendfile</code> used to be a separate system call and is now just a wrapper around <code>splice</code>.</p>

<p>There&rsquo;s also <code>vmsplice</code>, which I think is related and important. But right now my brain is full. Maybe we&rsquo;ll learn about vmsplice later.</p>

<h3 id="why-this-is-amazing">why this is amazing</h3>

<p>It makes me really happy when learning a new system call helps me understand how to do something really practical. Now I know that if I&rsquo;m building something that serves large files and I care about the performance, I should make sure I understand if it&rsquo;s using sendfile!</p>

</div>
<footer>
<div class="sharing">
<a href="http://twitter.com/share" class="twitter-share-button" data-url="https://jvns.ca/blog/2016/01/23/sendfile-a-new-to-me-system-call/" data-via="b0rk" data-counturl="https://jvns.ca/blog/2016/01/23/sendfile-a-new-to-me-system-call/">Tweet</a>
</div>
<p class="meta">
   
    <a class="basic-alignment left" href="https://jvns.ca/blog/2016/01/23/fast-integer-sets-with-roaring-bitmaps/" title="Previous Post: Fast integer sets with Roaring Bitmaps (and, making friends with your modern CPU)">Fast integer sets with Roaring Bitmaps (and, making friends with your modern CPU)</a>
  
   
    <a class="basic-alignment right" href="https://jvns.ca/blog/2016/01/18/guessing-linux-kernel-registers/" title="Previous Post: Guessing Linux kernel registers">Guessing Linux kernel registers</a>
  
</p>
</footer>
</article>
</div>

</div>
</div>
<nav role="navigation" class="footer-nav"> <a href="/">Archives</a>
</nav>
<footer role="contentinfo"><span class="credit">&copy; 2016 Polina Soshnin.
</footer>
</div>
</body>
</html>

