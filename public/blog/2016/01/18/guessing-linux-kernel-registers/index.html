
<!DOCTYPE html>


<html class="no-js" lang="en">
<head>
<meta charset="utf-8">
<title>Guessing Linux kernel registers - Polina Soshnin</title>
<meta name="author" content="Julia Evans">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="description" content="Guessing Linux kernel registers">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="canonical" href="https://jvns.ca/blog/2016/01/18/guessing-linux-kernel-registers/">
<link href="/favicon.ico" rel="icon">
<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
<link href="/atom.xml" rel="alternate" title="Julia Evans" type="application/atom+xml">
 
<link href="https://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='https://fonts.googleapis.com/css?family=Montserrat:700,400' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Alegreya:400,900,700' rel='stylesheet' type='text/css'>
</head>
<body>
<div id="wrap">
<header role="banner">
<hgroup>
<h1><a href="/">Polina Soshnin</a></h1>
</hgroup>
<ul class="header-links">
<span><li><a href="/about">About</a></li>
<li><a href="/projects">Projects</a></li></span>
    <li><a href="https://github.com/polinadotio">Github</a></li></span>
    <li><a href="https://www.linkedin.com/in/polinasoshnin">LinkedIn</a></li></span>
</ul>
</header>
<nav role="navigation" class="header-nav"><ul class="main-navigation">
<li><a href="/categories/favorite/">Favorites</a></li>
<li><a href="/zines">Zines</a></li>
</ul>
</nav>
<div id="main">
<div id="content">

<div>
<article class="hentry" role="article">
<header>
<h1 class="entry-title">Guessing Linux kernel registers</h1>

<div class="post-tags">
  
  •
  
    <a class="post-tag" href="/categories/kernel">kernel</a> 	•
  
  
</div>
<p class="meta">
<time datetime="2016-01-18T12:05:27" pubdate data-updated="true"></time>
</p>
</header>
<div class="entry-content">
     

<p>I have a long-standing project to try to learn to use ftrace, a Linux kernel tracing tool. As usual when I want to learn more, I turned to one of <a href="http://brendangregg.com">Brendan Gregg</a>&rsquo;s tools &ndash; the <a href="https://github.com/brendangregg/perf-tools/">perf-tools</a> repo on Github. There&rsquo;s a whole delightful directory of <a href="https://github.com/brendangregg/perf-tools/blob/master/examples/">examples</a>. It&rsquo;s the best.</p>

<p>He has a lot of tools that are ready to use and easy to understand &ndash; for instance, you can use execsnoop to see every program that&rsquo;s being executed. Those are awesome.</p>

<p>Then there are some that require&hellip; more work. I was interested in ftrace, and I was using his kprobe script to trace system calls and their arguments.</p>

<p>I started out by running <code>sudo kernel/kprobe 'p:SyS_read'</code> to tell me every time the <code>read</code> system call happened. This gives me output like</p>

<pre><code> Chrome_ChildIOT-8978  [000] d...  7402.349880: SyS_read: (SyS_read+0x0/0xa0)
 Chrome_ChildIOT-4102  [002] d...  7402.349922: SyS_read: (SyS_read+0x0/0xa0)
            Xorg-1853  [001] d...  7402.349962: SyS_read: (SyS_read+0x0/0xa0)
            Xorg-1853  [001] d...  7402.349969: SyS_read: (SyS_read+0x0/0xa0)
 Chrome_IOThread-4092  [003] d...  7402.349974: SyS_read: (SyS_read+0x0/0xa0)
</code></pre>

<p>But WHAT FILE DID IT READ? This is not good at all.</p>

<p>In the <a href="https://github.com/brendangregg/perf-tools/blob/master/examples/kprobe_example.txt#L108-L127">example</a>, he says, on the open system call.</p>

<blockquote>
<p>Here I guessed that the mode was in register %cx, and cast it as a 16-bit
unsigned integer (&rdquo;:u16&rdquo;). Your platform and kernel may be different, and the
mode may be in a different register. If fiddling with such registers becomes
too painful or unreliable for you, consider installing kernel debuginfo and
using the named variables with perf_events &ldquo;perf probe&rdquo;.</p>
</blockquote>

<p>This was wizardry. How could he <em>guess</em> that the mode of a file was in the register <code>%cx</code>? What even are the registers? This makes no sense.</p>

<p>I partly figured this out and got more information about the <code>read</code> system calls, so I will now tell you!</p>

<h3 id="what-even-is-a-register">what even is a register</h3>

<p>I know that registers are what the CPU uses to store data in when calculating things. But how many even are there? How do I guess which one is right?</p>

<p>First, I found <a href="http://www.eecg.toronto.edu/~amza/www.mindsec.com/files/x86regs.html">this page describing x86 registers</a>. It tells me that there are</p>

<pre><code>General registers
EAX EBX ECX EDX

Segment registers
CS DS ES FS GS SS

Index and pointers
ESI EDI EBP EIP ESP
</code></pre>

<p>From the description, the segment registers seem safe to ignore! Awesome. The instruction pointer and the stack pointer tell me what instruction is running right now and where the stack is. I also don&rsquo;t care about that. So that leaves me with only 7 registers to worry about (eax, ebx, ecx, edx, esi, edi, and ebp). That&rsquo;s way better.</p>

<h3 id="printing-the-registers">printing the registers</h3>

<p>So before we were running <code>sudo kernel/kprobe 'p:SyS_read'</code>. We can also print the registers for the read system call! Here goes. For some reason we need to take off the <code>e</code>.</p>

<pre><code>sudo kernel/kprobe 'p:SyS_read ax=%ax bx=%bx cx=%cx dx=%dx si=%si di=%di' | grep chrome-4095
          chrome-4095  [001] d...  7665.279404: SyS_read: (SyS_read+0x0/0xa0) ax=0 bx=2cb4726adec0 cx=0 dx=2 si=7fff1282f70e di=9
          chrome-4095  [001] d...  7665.279562: SyS_read: (SyS_read+0x0/0xa0) ax=0 bx=2cb4726adec0 cx=0 dx=2 si=7fff1282f70e di=9
          chrome-4095  [002] d...  7665.400594: SyS_read: (SyS_read+0x0/0xa0) ax=0 bx=2cb4726adec0 cx=0 dx=2 si=7fff1282f70e di=9
</code></pre>

<p>Let&rsquo;s compare this to the output of strace:</p>

<pre><code>sudo strace -e read -p 4095
Process 4095 attached - interrupt to quit
read(9, &quot;!&quot;, 2)                         = 1
read(9, &quot;!&quot;, 2)                         = 1
read(9, &quot;!&quot;, 2)                         = 1
</code></pre>

<p>Ok, awesome! In the output of <code>strace</code>. I know that <code>9</code> is the file descriptor, 2 is the length to read, and the middle value is the string. This must mean that <code>%di</code> is the file descriptor, and <code>%dx</code> is the amount of data to read!</p>

<p>I can label those now and be a register-guessing-wizard like Brendan Gregg!</p>

<pre><code>sudo kernel/kprobe 'p:julia_smart_read SyS_read fd=%di:u16 bytes_to_read=%dx' | grep chrome-4095
          chrome-4095  [003] d...  7854.905089: julia_smart_read: (SyS_read+0x0/0xa0) fd=9 bytes_to_read=2
          chrome-4095  [003] d...  7854.945585: julia_smart_read: (SyS_read+0x0/0xa0) fd=9 bytes_to_read=2
          chrome-4095  [002] d...  7854.945852: julia_smart_read: (SyS_read+0x0/0xa0) fd=9 bytes_to_read=2
</code></pre>

<p>So now I know which file descriptors are being read!</p>

<p>The advantage of using ftrace instead of strace is that the overhead is way lower: when I strace <code>find</code> it makes it 20x slower, but with ftrace it&rsquo;s totally okay. I&rsquo;m still not sure where the string that we read is (I think it&rsquo;s in <code>%si</code>, though!)</p>

<p>Now I am one step closer to being able to trace system calls with less overhead. Guessing registers is really tedious but it seems to be totally possible!</p>

<p><strong>update</strong>: turns out you don&rsquo;t have to guess at all! the registers used for system calls are always the same :D. <a href="http://blog.rchapman.org/post/36801038863/linux-system-call-table-for-x86-64">here is a table with all the answers ❤</a></p>

</div>
<footer>
<div class="sharing">
<a href="http://twitter.com/share" class="twitter-share-button" data-url="https://jvns.ca/blog/2016/01/18/guessing-linux-kernel-registers/" data-via="b0rk" data-counturl="https://jvns.ca/blog/2016/01/18/guessing-linux-kernel-registers/">Tweet</a>
</div>
<p class="meta">
   
    <a class="basic-alignment left" href="https://jvns.ca/blog/2016/01/23/sendfile-a-new-to-me-system-call/" title="Previous Post: Sendfile (a system call for web developers to know about!)">Sendfile (a system call for web developers to know about!)</a>
  
   
    <a class="basic-alignment right" href="https://jvns.ca/blog/2016/01/18/calling-c-from-rust/" title="Previous Post: Calling C from Rust">Calling C from Rust</a>
  
</p>
</footer>
</article>
</div>

</div>
</div>
<nav role="navigation" class="footer-nav"> <a href="/">Archives</a>
</nav>
<footer role="contentinfo"><span class="credit">&copy; 2016 Polina Soshnin.
</footer>
</div>
</body>
</html>

