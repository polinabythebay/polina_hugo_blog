
<!DOCTYPE html>


<html class="no-js" lang="en">
<head>
<meta charset="utf-8">
<title>Investigating Erlang by reading its system calls - Polina Soshnin</title>
<meta name="author" content="Julia Evans">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="description" content="Investigating Erlang by reading its system calls">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="canonical" href="https://jvns.ca/blog/2016/05/13/erlang-seems-really-complicated/">
<link href="/favicon.ico" rel="icon">
<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
<link href="/atom.xml" rel="alternate" title="Julia Evans" type="application/atom+xml">
 
<link href="https://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='https://fonts.googleapis.com/css?family=Montserrat:700,400' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Alegreya:400,900,700' rel='stylesheet' type='text/css'>
</head>
<body>
<div id="wrap">
<header role="banner">
<hgroup>
<h1><a href="/">Polina Soshnin</a></h1>
</hgroup>
<ul class="header-links">
<span><li><a href="/about">About</a></li>
<li><a href="/projects">Projects</a></li></span>
    <li><a href="https://github.com/polinadotio">Github</a></li></span>
    <li><a href="https://www.linkedin.com/in/polinasoshnin">LinkedIn</a></li></span>
</ul>
</header>
<nav role="navigation" class="header-nav"><ul class="main-navigation">
<li><a href="/categories/favorite/">Favorites</a></li>
<li><a href="/zines">Zines</a></li>
</ul>
</nav>
<div id="main">
<div id="content">

<div>
<article class="hentry" role="article">
<header>
<h1 class="entry-title">Investigating Erlang by reading its system calls</h1>

<div class="post-tags">
  
</div>
<p class="meta">
<time datetime="2016-05-13T09:24:19" pubdate data-updated="true"></time>
</p>
</header>
<div class="entry-content">
     

<p>I was helping debug a performance problem (this <a href="https://gist.github.com/jvns/c7e277c7a44e22ce5a6e5707febcfbf3">networking puzzle</a>) in an Erlang program yesterday. I learned that Erlang is complicated, and that we can learn maybe 2 things about it by just looking at what system calls it&rsquo;s running.</p>

<p>Now &ndash; I have never written an Erlang program and don&rsquo;t really know anything about Erlang, so &ldquo;Erlang seems complicated&rdquo; isn&rsquo;t meant as a criticism so much as an observation and something I don&rsquo;t really understand. When I&rsquo;m debugging a program, whether I know the programming language it&rsquo;s written in or not, I often use strace to see what system calls it runs. In my few experiments so far, the Erlang virtual machine runs a TON of system calls and I&rsquo;m not sure exactly what it&rsquo;s doing. Here are some experimental results.</p>

<p>I write 4 programs: hello.c, hello,java, hello.erl, and hello.py. Here they are.</p>

<pre><code>#include &lt;stdio.h&gt;
int main() {
    printf(&quot;hello!\n&quot;);
}
</code></pre>

<pre><code>class Hello {
    public static void main(String[] args)  {
        System.out.println(&quot;hello!&quot;);
    }
}
</code></pre>

<pre><code>-module(hello).
-export([hello_world/0]).

hello_world() -&gt;
    io:fwrite(&quot;Hello, world!\n&quot;).‚èé 
</code></pre>

<pre><code>print &quot;hello&quot;
</code></pre>

<p>Here are the number of system calls each of these programs made: (you can see the <a href="https://gist.github.com/jvns/a5a5a39c6b79445279a7d3d03ba0c153">full strace output here</a>). You can generate this yourself with, for instance, <code>strace -f -o python.strace python hello.py</code></p>

<pre><code>wc -l *.strace
     38 c.strace
   1550 python.strace
   2699 java.strace
  15043 erlang.strace
</code></pre>

<p>Unsurprisingly, C comes in at the least. I was surprised that the Erlang VM runs <strong>6 times</strong> as many system calls as Java &ndash; I think of Java as already being pretty heavyweight. Maybe this is because Erlang starts up processes on all my cores? The variety of system calls is also interesting to see: <a href="https://gist.github.com/jvns/4b179aa7bd3e507a361f21de94e721d5">I put the system call frequencies in a gist too</a>.</p>

<p>When you look at the system call frequencies, you can see that Erlang is running significantly different <strong>kinds</strong> of system calls than Java and Python and C. Those 3 languages are mostly doing <code>open</code>, <code>read</code>, <code>lseek</code>, <code>stat</code>, <code>mmap</code>, <code>mprotect</code>, <code>fstat</code> &ndash; all activities around reading a bunch of files &amp; allocating memory, which is what I think of as normal behavior when starting a program.</p>

<p>The top 2 syscalls for the Erlang process are <code>futex</code> and <code>sched_yield</code>. So there&rsquo;s a lot of synchronization happening (the futex), and the operating system threads Erlang starts up keep scheduling themselves off the CPU &ldquo;ok, I&rsquo;m done, you go!&rdquo;. There are also a lot of mysterious-to-me <code>ppoll</code> system calls. So Erlang seems like a programming language with really significantly different primitives.</p>

<p>This highly concurrent behavior is consistent with what Wikipedia article says:</p>

<blockquote>
<p>Erlang&rsquo;s main strength is support for concurrency. It has a small but powerful
set of primitives to create processes and communicate among them.</p>
</blockquote>

<p>Let&rsquo;s look a little more carefully at these <code>ppoll</code> system calls for a second. The story starts with</p>

<pre><code>8682  openat(AT_FDCWD, &quot;/sys/devices/system/node/node0&quot;, O_RDONLY|O_NONBLOCK|O_DIRECTORY|O_CLOEXEC) = 4
8703  ppoll([{fd=4, events=POLLIN|POLLRDNORM}, {fd=0, events=POLLIN|POLLRDNORM}], 2, {0, 0}, NULL, 8) = 0 (Timeout)
</code></pre>

<p>I have no idea what <code>/sys/devices/system/node/node0</code> is, but it seems to be a directory and what <code>ppoll</code> is looking for changes to? I don&rsquo;t really get this at all.</p>

<p>One last thing &ndash; erlang runs <code>bind</code> once when it starts. Why does it need to listen on a TCP socket to run hello world? I was very confused about this and unable to figure it out. Some people on twitter thought it might have something to do with <code>epmd</code>, but <code>epmd</code> seems to be a separate process. So I don&rsquo;t know what&rsquo;s going on.</p>

<h3 id="3-operating-systems">&lt;3 operating systems</h3>

<p>I wanted to write this down because, as you all very well know, I think it&rsquo;s interesting to take an operating systems-level approach to understanding what a program is doing and I thought this was a cool example of that.</p>

<p>I had this interesting experience yesterday where I was looking at this Erlang problem with Victor and David and they had OS X machines and I was like &ldquo;dude I can&rsquo;t debug anything on OS X&rdquo;. So we got it working on my laptop and then I could make a lot more progress. Because now I&rsquo;m pretty good at OS-level debugging tools, and I&rsquo;ve spent a lot of time learning about Linux, and so I&rsquo;m not super comfortable on non-Linux systems. (I know, I know, dtrace is amazing, I&rsquo;m going to learn it one day soon, I promise :) )</p>

</div>
<footer>
<div class="sharing">
<a href="http://twitter.com/share" class="twitter-share-button" data-url="https://jvns.ca/blog/2016/05/13/erlang-seems-really-complicated/" data-via="b0rk" data-counturl="https://jvns.ca/blog/2016/05/13/erlang-seems-really-complicated/">Tweet</a>
</div>
<p class="meta">
   
    <a class="basic-alignment left" href="https://jvns.ca/blog/2016/05/19/a-few-reasons-to-be-skeptical-of-machine-learning-results/" title="Previous Post: A few reasons to be skeptical of machine learning">A few reasons to be skeptical of machine learning</a>
  
   
    <a class="basic-alignment right" href="https://jvns.ca/blog/2016/05/13/homu-plus-highfive-making-less-work-for-open-source-maintainers/" title="Previous Post: homu &#43; highfive: awesome bots that make open source projects easier">homu &#43; highfive: awesome bots that make open source projects easier</a>
  
</p>
</footer>
</article>
</div>

</div>
</div>
<nav role="navigation" class="footer-nav"> <a href="/">Archives</a>
</nav>
<footer role="contentinfo"><span class="credit">&copy; 2016 Polina Soshnin.
</footer>
</div>
</body>
</html>

