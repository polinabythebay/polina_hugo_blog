
<!DOCTYPE html>


<html class="no-js" lang="en">
<head>
<meta charset="utf-8">
<title>Why do we use the Linux kernel&#39;s TCP stack? - Polina Soshnin</title>
<meta name="author" content="Julia Evans">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="description" content="Why do we use the Linux kernel&#39;s TCP stack?">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="canonical" href="https://jvns.ca/blog/2016/06/30/why-do-we-use-the-linux-kernels-tcp-stack/">
<link href="/favicon.ico" rel="icon">
<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
<link href="/atom.xml" rel="alternate" title="Julia Evans" type="application/atom+xml">
 
<link href="https://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='https://fonts.googleapis.com/css?family=Montserrat:700,400' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Alegreya:400,900,700' rel='stylesheet' type='text/css'>
</head>
<body>
<div id="wrap">
<header role="banner">
<hgroup>
<h1><a href="/">Polina Soshnin</a></h1>
</hgroup>
<ul class="header-links">
<span><li><a href="/about">About</a></li>
<li><a href="/projects">Projects</a></li></span>
    <li><a href="https://github.com/polinadotio">Github</a></li></span>
    <li><a href="https://www.linkedin.com/in/polinasoshnin">LinkedIn</a></li></span>
</ul>
</header>
<nav role="navigation" class="header-nav"><ul class="main-navigation">
<li><a href="/categories/favorite/">Favorites</a></li>
<li><a href="/zines">Zines</a></li>
</ul>
</nav>
<div id="main">
<div id="content">

<div>
<article class="hentry" role="article">
<header>
<h1 class="entry-title">Why do we use the Linux kernel&#39;s TCP stack?</h1>

<div class="post-tags">
  
  •
  
    <a class="post-tag" href="/categories/favorite">favorite</a> 	•
  
  
</div>
<p class="meta">
<time datetime="2016-06-30T23:54:45" pubdate data-updated="true"></time>
</p>
</header>
<div class="entry-content">
     

<p>I&rsquo;m at PolyConf in Poland today, and I watched this super interesting talk by Leandro Pereira about <a href="https://lwan.ws/">Lwan</a>, an ~8000 line of code web server. He talked about a bunch of the optimizations they&rsquo;d done (improve CPU cache performance! be really careful about locking!). You can read more about the performance on the website &amp; the links there.</p>

<p>It&rsquo;s a super cool project because it started out as a hobby project, and now he says it&rsquo;s getting to a state where it kinda actually really works and people are using it for real things. This web server is extremely fast &ndash; it can do, in some benchmarks, 2 million requests per second.</p>

<p>Before I start talking about this &ndash; of course practically nobody needs to do 2 million requests per second. I sure don&rsquo;t. But thinking about high performance computing is a really awesome way to understand the limits of computers better!</p>

<p>I tracked him down to ask him questions later, and he mentioned that most of the time is spent talking to the Linux kernel and copying things back and forth.</p>

<h3 id="writing-your-own-tcp-stack-is-way-faster">writing your own tcp stack is way faster</h3>

<p>Then he said something really surprising: that in the <a href="http://www.seastar-project.org/">Seastar</a> HTTP framework, they <strong>wrote their own TCP stack</strong>, and it made everything several times times faster. What?!</p>

<p>So &ndash; this made me wonder. When we do high performance networking &ndash; why do we bother using the Linux kernel&rsquo;s TCP stack at all, if it&rsquo;s so expensive? Why not just do all the networking in userspace? I had no idea where to start with this question, so I <a href="https://twitter.com/b0rk/status/748649763118133248">asked on Twitter</a>. As often happens, you all came through with ONE BILLION INTERESTING LINKS AND ANSWERS.</p>

<h3 id="embedded-devices">embedded devices</h3>

<p>If you&rsquo;re working on a very small computer without an operating system, you sometimes need to do networking anyway! In this case it seems pretty common to use a separate TCP stack. A ton of people mentioned that they either used <a href="http://savannah.nongnu.org/projects/lwip/">lwIP</a> or wrote their own TCP stack to meet their own specific requirements.</p>

<p>I asked a few people whether anyone uses lwIP on a Real Server, but it seems like it&rsquo;s optimized for small devices, and not for doing huge amounts of network traffic on big servers.</p>

<h3 id="high-frequency-trading">high frequency trading</h3>

<p>Who cares about doing a ton of very fast network requests? People who do high frequency trading! Luke Gorrie on Twitter (who works on the extremely cool <a href="https://snabb.co/">Snabb Switch</a> open source Ethernet stack) said:</p>

<blockquote>
<p>Solarflare sell a userspace TCP stack to HFT market (OpenOnload) for use with
their NICs. Code is GPL actually.</p>
</blockquote>

<p>So, this makes a lot of sense. If you want to do super high performance networking, you can probably afford to buy special network cards and special software to make those network cards perform super well. Cool. But what if you want to do higher performance networking on commodity hardware, with any random network card? Is that a thing?</p>

<h3 id="what-about-google">what about Google?</h3>

<p>Who else does a ton of networking? Google! Happily Google sometimes writes papers so we know a little bit about what they do there.</p>

<p>Tons of people told me about <a href="http://research.google.com/pubs/pub44824.html">Maglev</a>, which is Google&rsquo;s load balancer, and they do all of their networking for that in userspace! I think they operate at a lower level than TCP so they don&rsquo;t have a TCP stack, but it is an example of extremely fast networking without using the Linux kernel.</p>

<p>I haven&rsquo;t read the Maglev paper yet but it seems like a good starting point.</p>

<p>There&rsquo;s also <a href="https://cloudplatform.googleblog.com/2015/06/A-Look-Inside-Googles-Data-Center-Networks.html?m=1">this blog post</a> and <a href="http://conferences.sigcomm.org/sigcomm/2015/pdf/papers/p183.pdf">paper</a> about software-defined networking at Google. A useful keyword here seems to be &ldquo;Jupiter&rdquo; or &ldquo;Jupiter fabrics&rdquo; but I&rsquo;m not sure what that is. <a href="http://www.nextplatform.com/2015/06/19/inside-a-decade-of-google-homegrown-datacenter-networks/">Here&rsquo;s another article though</a>.</p>

<h3 id="is-the-real-reason-to-write-your-own-tcp-stack-for-performance">is the real reason to write your own TCP stack for performance?</h3>

<p><a href="https://twitter.com/tgraf__">@tgraf__</a> made a super interesting point &ndash; I thought the reason you would make your own TCP stack was to make it fast. But maybe not always!!</p>

<blockquote>
<p>Google can&rsquo;t force Android vendors to rebase kernels but requires new TCP
functionality such as TCP fast open.</p>
</blockquote>

<p>The TCP standard is evolving, and if you have to always use your kernel&rsquo;s TCP stack, that means you can NEVER EVOLVE.</p>

<h3 id="why-is-tcp-in-the-kernel-slow">why is TCP in the kernel slow?</h3>

<p>This <a href="https://lwn.net/Articles/169961/">article from LWN</a> &ldquo;Van Jacobsen&rsquo;s network channels&rdquo; says that dealing with TCP in kernel space means locks and contention. thanks for @tef_ebooks for linking this article and explaining it to me :)</p>

<blockquote>
<p>The key to better networking scalability, says Van, is to get rid of locking and shared data as much as possible, and to make sure that as much processing work as possible is done on the CPU where the application is running. It is, he says, simply the end-to-end principle in action yet again. This principle, which says that all of the intelligence in the network belongs at the ends of the connections, doesn&rsquo;t stop at the kernel. It should continue, pushing as much work as possible out of the core kernel and toward the actual applications.</p>
</blockquote>

<h3 id="how-does-seastar-work">how does Seastar work?</h3>

<p>That fast networking framework Seastar from before is written using something from Intel called <a href="http://dpdk.org/">DPDK</a>. The deal with DPDK seems to be that it&rsquo;s a network card driver and some libraries, but instead of it giving you packets through interrupts (asynchronously), instead it polls the network card and say &ldquo;do you have a packet yet? now? now? now?&rdquo;.</p>

<p>This makes sense to me because in general if you always have new events to process, then polling is faster (because you basically don&rsquo;t have to wait). Here&rsquo;s some documentation about the <a href="http://dpdk.org/doc/guides-16.04/prog_guide/poll_mode_drv.html">poll mode driver</a> and an [example of a DPDK] application.</p>

<p>I think with DPDK you can write networking applications that work entirely in userspace with no system calls.  <a href="https://twitter.com/Lukasaoz/status/748853883703820293">Cory Benfield</a> explained a bunch of these things to me.</p>

<h3 id="open-source-stuff-right-now-pretty-specific">open source stuff right now: pretty specific</h3>

<p>As far as I can tell, there aren&rsquo;t any available general purpose open source userspace TCP/IP stacks available. There are a few specialized ones, but this does not seem to exist right now. But people seem to be interested in the topic!</p>

<h3 id="some-more-links">some more links</h3>

<p>Here are some more links that do networking in userspace! This is mostly a link dump so that I can click on them later but maybe you will like them too.</p>

<p><a href="https://zmap.io/paper.pdf">zmap</a> is a TCP port scanner.</p>

<p><a href="https://github.com/robertdavidgraham/masscan">masscan</a> is another TCP port scanner. It says it can scan the entire internet in 5 minutes. What? Outlandish! I will need to read more about this!</p>

<p><a href="https://github.com/lkl/linux">LKL</a> is an attempt to make the Linux kernel networking code (as well as other Linux code) into a library (!!) so that we can use it in userspace. This sounds like a monumental effort and also extremely interesting. <a href="https://twitter.com/thehajime/status/748657015702986752">@thehakime said about this</a>:. <a href="http://www.slideshare.net/hajimetazaki/library-operating-system-for-linux-netdev01">Here&rsquo;s a talk about LKL.</a></p>

<blockquote>
<p>there are so many uspace network stacks (mtcp, lwip, seastar, sandstrom) but all are so specialized. I think it can be generalized.</p>
</blockquote>

<p><a href="https://github.com/pkelsey/libuinet">libuinet</a> is a library version of FreeBSD&rsquo;s TCP stack. I guess there&rsquo;s a theme here.</p>

<p><a href="https://github.com/eunyoung14/mtcp">mtcp</a> is a userspace TCP stack. I don&rsquo;t know anything about it. There&rsquo;s also <a href="https://github.com/adamdunkels/uip">uip</a> and <a href="http://savannah.nongnu.org/projects/lwip/">lwIP</a>.</p>

<h3 id="phew">phew.</h3>

<p>Okay, that was a lot of new facts and ideas to come out of the comment &ldquo;a lot of the overhead of a HTTP server is communicating with the kernel&rdquo;.</p>

<p>I like how if you ask the right questions Twitter will just hurl super interesting information at you until you&rsquo;re like OK OK OK MY BRAIN IS FULL. And then they keep telling you awesome stuff anyway :)</p>

<p>There seems to be a lot of work going on here! There are like 100 interesting rabbit holes which I have zero time to investigate right now! Awesome.</p>

<p><small>
This is unusual for me to say, but the <a href="https://news.ycombinator.com/item?id=12021195">Hacker News comments</a> on this post are mostly quite informative and a few people talk about their experiences, positive and negative, implementing network stacks. I enjoyed reading them.
</small></p>

</div>
<footer>
<div class="sharing">
<a href="http://twitter.com/share" class="twitter-share-button" data-url="https://jvns.ca/blog/2016/06/30/why-do-we-use-the-linux-kernels-tcp-stack/" data-via="b0rk" data-counturl="https://jvns.ca/blog/2016/06/30/why-do-we-use-the-linux-kernels-tcp-stack/">Tweet</a>
</div>
<p class="meta">
   
    <a class="basic-alignment left" href="https://jvns.ca/blog/2016/07/03/polyconf-2016/" title="Previous Post: PolyConf 2016">PolyConf 2016</a>
  
   
    <a class="basic-alignment right" href="https://jvns.ca/blog/2016/06/15/using-ltrace-to-debug-a-memory-leak/" title="Previous Post: Using ltrace to debug a memory leak">Using ltrace to debug a memory leak</a>
  
</p>
</footer>
</article>
</div>

</div>
</div>
<nav role="navigation" class="footer-nav"> <a href="/">Archives</a>
</nav>
<footer role="contentinfo"><span class="credit">&copy; 2016 Polina Soshnin.
</footer>
</div>
</body>
</html>

