
<!DOCTYPE html>


<html class="no-js" lang="en">
<head>
<meta charset="utf-8">
<title>How do HTTP requests get sent to the right place? - Polina Soshnin</title>
<meta name="author" content="Julia Evans">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="description" content="How do HTTP requests get sent to the right place?">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="canonical" href="https://jvns.ca/blog/2016/07/14/whats-sni/">
<link href="/favicon.ico" rel="icon">
<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
<link href="/atom.xml" rel="alternate" title="Julia Evans" type="application/atom+xml">
 
<link href="https://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='https://fonts.googleapis.com/css?family=Montserrat:700,400' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Alegreya:400,900,700' rel='stylesheet' type='text/css'>
</head>
<body>
<div id="wrap">
<header role="banner">
<hgroup>
<h1><a href="/">Polina Soshnin</a></h1>
</hgroup>
<ul class="header-links">
<span><li><a href="/about">About</a></li>
<li><a href="/projects">Projects</a></li></span>
    <li><a href="https://github.com/polinadotio">Github</a></li></span>
    <li><a href="https://www.linkedin.com/in/polinasoshnin">LinkedIn</a></li></span>
</ul>
</header>
<nav role="navigation" class="header-nav"><ul class="main-navigation">
<li><a href="/categories/favorite/">Favorites</a></li>
<li><a href="/zines">Zines</a></li>
</ul>
</nav>
<div id="main">
<div id="content">

<div>
<article class="hentry" role="article">
<header>
<h1 class="entry-title">How do HTTP requests get sent to the right place?</h1>

<div class="post-tags">
  
</div>
<p class="meta">
<time datetime="2016-07-14T08:01:17" pubdate data-updated="true"></time>
</p>
</header>
<div class="entry-content">
     

<p>10 years ago I configured the Apache webserver for the first time. I remember having to set up a &ldquo;virtual host&rdquo; to have more than one site running on the same machine, and I remember that I totally got it to work, but did not understand <em>at all</em> what was happening.</p>

<p>Fast forward 8 years. One day I was reading <a href="https://www.amazon.com/High-Performance-Browser-Networking-performance/dp/1449344763">High Performance Browser Networking</a>, which is an great book and you should read it. (in particular, there&rsquo;s a really clear and fascinating explanation of WebRTC).</p>

<p>And then I was talking to someone about it and they were like &ldquo;hmm, so how do apache virtual hosts work?&rdquo; and I was like &ldquo;hmmmmmm.&rdquo; AND SUDDENLY I KNEW AND IT WAS OBVIOUS.</p>

<h3 id="how-to-make-a-http-request-from-scratch">how to make a HTTP request from scratch</h3>

<p>The difference between 17-year old Julia and 25-year-old Julia is that 25-year-old Julia knew how HTTP works.</p>

<p>When I&rsquo;m experimenting with HTTP, sometimes I like to make HTTP requests manually (without using any tools like curl). It turns out this is easy!</p>

<p>First, run <code>curl -v http://ask.metafilter.com &gt; /dev/null</code> This will tell you at the beginning what request it sent. Then you put that into a file (the blank lines at the end are important):</p>

<pre><code>$ cat request.txt
GET / HTTP/1.1
Host: ask.metafilter.com
User-Agent: curl/7.47.0


</code></pre>

<p>Then you use netcat to send the request to ask.metafilter.com!</p>

<pre><code>cat request.txt | netcat ask.metafilter.com 80
# This also works: this is the IP for ask.metafilter.com
cat request.txt | netcat 54.186.13.33 80
</code></pre>

<p>If you remove the Host: part from this request, it does not work. Zero. Apache is all &ldquo;400 Bad request&rdquo;. 400 means it is your fault.</p>

<h3 id="the-host-header">the Host header</h3>

<p>So! Suppose you&rsquo;re a web server, and you have some configuration like</p>

<pre><code>server {
    name 'julia.com';
    ... awesome perl site configuration ...
}

server {
    name 'bork.com';
    ... awesome python site configuration ...
}
</code></pre>

<p>Then an HTTP request comes into the box! Perhaps like this</p>

<pre><code>curl -v http://julia.com
&gt; GET / HTTP/1.1
&gt; Host: julia.com
&gt; User-Agent: curl/7.47.0
&gt; Accept: */*
</code></pre>

<p>So there&rsquo;s this string in the request &ndash; &ldquo;Host: julia.com&rdquo;. This is what the web server uses to decide whether your request is for julia.com or bork.com or what. That&rsquo;s it!</p>

<p>I like this because once you know what a HTTP request looks like &ndash; it becomes kind of obvious how a web server would decide where to send the request. There are only 4 things in it and only one of them is julia.com!</p>

<h3 id="next-level-sni">next level: SNI</h3>

<p>Once last year someone told me they were working on setting up SNI at work. I was like &ndash; what&rsquo;s that? I had literally no idea what those letters meant.</p>

<p>We used to live in a world where SSL was uncommon and difficult and a huge production and expensive. But now we have <a href="https://letsencrypt.org/">let&rsquo;s encrypt</a> and we want it to be easy and cheap and on by default. I&rsquo;m going to use SSL and TLS interchangeably through this discussion.</p>

<p>We still want to put many secure websites on the same server. How do we do it? At first this seems easy &ndash; just use the Host header again, right? But!</p>

<ol>
<li>The contents of an HTTP request for julia.com (including the host header) are <strong>encrypted</strong>.</li>
<li>With a certificate.</li>
<li>Which certificate? The certificate for julia.com!</li>
<li>How did I know to pick the certificate for julia.com?</li>
</ol>

<p>So the problem is that you need to choose which certificate you&rsquo;re going to use <strong>before</strong> you see the Host header. There are basically 2 ways to deal with this:</p>

<ol>
<li>Just put every site on your server on the same certificate (make a certificate for all of julia.com bork.com cookies.com awesome.com pandas.com)</li>
<li>Use SNI. (&ldquo;Server Name Indication&rdquo;)</li>
</ol>

<p>SNI is a standard where, when getting a website, you say &ldquo;hey I&rsquo;m gonna want julia.com&rdquo; and the server is like &ldquo;ok encryption time! I will use the cert for julia.com!&rdquo; and then you say, secretly: &ldquo;Host: julia.com. here&rsquo;s more about that.&rdquo;</p>

<p>More technically speaking the very first packet in a TLS negotiation is called the &ldquo;Client Hello&rdquo; packet. This packet has a hostname like julia.com in it! So you can get the hostname out of that packet and then continue the negotiation with the right certificate.</p>

<p>Paul Tagliamonte, who is great, wrote <a href="https://github.com/paultag/sniff/blob/master/parser/parser.go">a parser</a> that will let you extract the SNI hostname from a TLS packet! This is neat because you can see that it is only 150 lines of code or so.</p>

<h3 id="a-story-about-nginx-sni">a story about nginx &amp; SNI</h3>

<p>nginx is another web server! Let&rsquo;s imagine you configure it this way. This is an experiment my awesome coworker Ray ran when we were trying to understand how nginx works.</p>

<pre><code># this is not exactly how nginx is configured but it's close
server {
    listen 443 ssl;
    server_name 'julia.com';
    ssl_certificate julia.com;
    return 200 &quot;I'm julia.com&quot;;
}

server {
    listen 443 ssl;
    name 'bork.com';
    ssl_certificate bork.com;
    return 200 &quot;I'm bork.com&quot;;
}
</code></pre>

<p>So, what happens if you set an SNI of julia.com, but then a Host header of bork.com? You can do this with <code>curl https://julia.com -H &quot;Host: bork.com&quot;</code></p>

<p>Then you will get</p>

<ul>
<li>an SSL certificate for julia.com</li>
<li>and it will say &ldquo;I&rsquo;m bork.com&rdquo;</li>
</ul>

<p>Really. Now this makes some sense &ndash; if I open up a TCP connection to the server, I might make a lot of different HTTP requests inside for different websites (like julia.com, bork.com, cookies.com), and it needs to deal with that somehow! It can&rsquo;t change SSL certificates in the middle.</p>

<p>You might wonder &ldquo;wait, is that secure to send requests for bork.com to julia.com?&rdquo;. It&rsquo;s okay! If you have a secure connection set up with a computer (you believe that computer is who you think it is), then it seems reasonable to send many requests to that computer (for instance for both images.google.com and google.com).</p>

<p>But it&rsquo;s a little weird, right? I wanted to make extra sure that I understood how this worked, so I went and read some of the nginx source code. It turns out that there is a big file called <a href="https://github.com/nginx/nginx/blob/master/src/http/ngx_http_request.c">ngx_http_request.c</a>, and in it there is a function called <code>ngx_http_find_virtual_server</code>, <a href="https://github.com/nginx/nginx/blob/46336296e4d695cf34c55ced54e21f7647a53fdc/src/http/ngx_http_request.c#L2095">defined here</a>.</p>

<p>In that file, you&rsquo;ll see that <code>ngx_http_find_virtual_server</code> is called <strong>twice</strong> per TLS request. Once to find the server block matching the SNI host (julia.com), to pick the right certificate. Then it&rsquo;s called a second time when you get a Host header, to pick which server block to actually serve the response from..</p>

<p>So that&rsquo;s how we get a response saying bork.com but a certificate for julia.com!</p>

<h3 id="3-fundamentals">&lt;3 fundamentals</h3>

<p>Learning how HTTP works was an a+ move. It would be totally impossible for me to configure webservers at work if I didn&rsquo;t know how it worked!</p>

</div>
<footer>
<div class="sharing">
<a href="http://twitter.com/share" class="twitter-share-button" data-url="https://jvns.ca/blog/2016/07/14/whats-sni/" data-via="b0rk" data-counturl="https://jvns.ca/blog/2016/07/14/whats-sni/">Tweet</a>
</div>
<p class="meta">
   
    <a class="basic-alignment left" href="https://jvns.ca/blog/2016/07/23/rigorous-benchmarking-in-reasonable-time/" title="Previous Post: Benchmarking correctly is hard (and techniques for doing it better)">Benchmarking correctly is hard (and techniques for doing it better)</a>
  
   
    <a class="basic-alignment right" href="https://jvns.ca/blog/2016/07/03/debugging-tools-i-love/" title="Previous Post: Linux debugging tools I love">Linux debugging tools I love</a>
  
</p>
</footer>
</article>
</div>

</div>
</div>
<nav role="navigation" class="footer-nav"> <a href="/">Archives</a>
</nav>
<footer role="contentinfo"><span class="credit">&copy; 2016 Polina Soshnin.
</footer>
</div>
</body>
</html>

