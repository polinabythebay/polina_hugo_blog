
<!DOCTYPE html>


<html class="no-js" lang="en">
<head>
<meta charset="utf-8">
<title>Java garbage collection can be really slow - Polina Soshnin</title>
<meta name="author" content="Julia Evans">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="description" content="Java garbage collection can be really slow">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="canonical" href="https://jvns.ca/blog/2016/04/22/java-garbage-collection-can-be-really-slow/">
<link href="/favicon.ico" rel="icon">
<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
<link href="/atom.xml" rel="alternate" title="Julia Evans" type="application/atom+xml">
 
<link href="https://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='https://fonts.googleapis.com/css?family=Montserrat:700,400' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Alegreya:400,900,700' rel='stylesheet' type='text/css'>
</head>
<body>
<div id="wrap">
<header role="banner">
<hgroup>
<h1><a href="/">Polina Soshnin</a></h1>
</hgroup>
<ul class="header-links">
<span><li><a href="/about">About</a></li>
<li><a href="/projects">Projects</a></li></span>
    <li><a href="https://github.com/polinadotio">Github</a></li></span>
    <li><a href="https://www.linkedin.com/in/polinasoshnin">LinkedIn</a></li></span>
</ul>
</header>
<nav role="navigation" class="header-nav"><ul class="main-navigation">
<li><a href="/categories/favorite/">Favorites</a></li>
<li><a href="/zines">Zines</a></li>
</ul>
</nav>
<div id="main">
<div id="content">

<div>
<article class="hentry" role="article">
<header>
<h1 class="entry-title">Java garbage collection can be really slow</h1>

<div class="post-tags">
  
</div>
<p class="meta">
<time datetime="2016-04-22T23:15:17" pubdate data-updated="true"></time>
</p>
</header>
<div class="entry-content">
     

<p>Yes, friends, I know this is news to absolutely nobody. But today I had up-close-and-personal problems with Java garbage collection for the first time so I am going to tell you about it.</p>

<p>So! I was running a program. I set the Java memory limit to 4 gigabytes (<code>-Xmx4G</code>). I ran it on a file with one million lines. Done. no problem. Next: 8 million lines. It took&hellip; well.. more than 8 times longer. Way longer. Then it crashed with an out of memory error.</p>

<p>I was fine with it crashing (if you&rsquo;re out of memory, you&rsquo;re out of memory! I get it!) But why did it take so long to run? I asked <a href="https://twitter.com/d6">Erik</a> for some help, because he is the best and knows a lot about Java performance.</p>

<p>He suggested this JVM flag: <code>-XX:+PrintGCDetails</code>. This is my new favorite JVM flag.</p>

<p>I started the program. It started out by printing out some stuff like this:</p>

<pre><code>[GC
    [PSYoungGen: 142816K-&gt;10752K(142848K)] 246648K-&gt;243136K(375296K),
    0,0935090 secs
]
[Times: user=0,55 sys=0,10, real=0,09 secs]
</code></pre>

<p>These are &ldquo;young gen&rdquo; collections. I still don&rsquo;t totally understand how the young gen collections work. I know that they only collect new objects, and use a different algorithm from full collections. The most important thing to know is that young gen collections are fast. mine were taking 0.09 seconds and freeing many many megabytes of memory. Maybe a gigabyte? Fast.</p>

<p>Then, things got bad. The program slowed wayyyy down. It would do 0.2 seconds of work, and then some thing like:</p>

<pre><code>[Full GC
    [PSYoungGen: 10752K-&gt;9707K(142848K)]
    [ParOldGen: 232384K-&gt;232244K(485888K)] 243136K-&gt;241951K(628736K)
    [PSPermGen: 3162K-&gt;3161K(21504K)],
    1,5265450 secs
]
[Times: user=10,96 sys=0,06, real=1,53 secs]
</code></pre>

<ul>
<li>me: PROGRAM. You can&rsquo;t just stop for 1.5 seconds after working for 0.2 seconds! That makes no sense</li>
<li>program: uh, yeah i can.</li>
</ul>

<p>These are full collections that do mark-and-sweep over every object in memory and make sure we collect everything we can. Everything. This can be very very slow (2 seconds is a very long time to stop!).</p>

<p>I thought this was really interesting and surprising. I knew GC was important but did not know that it could bring a program to a screeching halt. But apparently it can!</p>

<p>The many objects in the old generation were still used every time it collected, so it had to constantly iterate over those objects and ask &ldquo;can I free you yet?&rdquo; &ldquo;nope.&rdquo; &ldquo;can I free you yet?&rdquo; &ldquo;nope.&rdquo; &ldquo;can I free you yet?&rdquo; &ldquo;nope.&rdquo;.</p>

<h3 id="memory-pressure">memory pressure</h3>

<p>Now I think I understand what memory pressure is on the JVM! If your application is using 3.5GB of memory normally, and has a limit of 4G, then it may constantly need to garbage collect and slow your program waaaaaay down. If you had a memory limit of 20GB, that same program (using the same amount of memory) would be able to run faster because it wouldn&rsquo;t need to constantly try to garbage collect the same objects all the time.</p>

<p>So this was bad. I do not have a story of redemption for you here yet (Presumably we can make it better by looking at what the objects are and using less objects. Did you know that you can get a histogram of which kinds of objects are taking up all the space with <code>jmap -histo $pid</code>? It&rsquo;s the best.)</p>

<p>But it was interesting! Now we know that garbage collection can ruin your program&rsquo;s day, what memory pressure is, and that memory pressure is bad.</p>

<p>I read this article about <a href="http://www.infoq.com/articles/Java_Garbage_Collection_Distilled">garbage collection</a> that I don&rsquo;t fully understand by Martin Thompson that concludes with</p>

<blockquote>
<p>GC tuning can become a highly skilled exercise that often requires application changes to reduce object allocation rates or object lifetimes.</p>
</blockquote>

<p>which is to say &ldquo;sometimes the only way is to make your program stop allocating so much memory&rdquo;</p>

</div>
<footer>
<div class="sharing">
<a href="http://twitter.com/share" class="twitter-share-button" data-url="https://jvns.ca/blog/2016/04/22/java-garbage-collection-can-be-really-slow/" data-via="b0rk" data-counturl="https://jvns.ca/blog/2016/04/22/java-garbage-collection-can-be-really-slow/">Tweet</a>
</div>
<p class="meta">
   
    <a class="basic-alignment left" href="https://jvns.ca/blog/2016/04/23/some-links-on-java-garbage-collection/" title="Previous Post: Some links on Java garbage collection">Some links on Java garbage collection</a>
  
   
    <a class="basic-alignment right" href="https://jvns.ca/blog/2016/04/10/why-i-dont-like-black-boxes/" title="Previous Post: Looking inside machine learning black boxes">Looking inside machine learning black boxes</a>
  
</p>
</footer>
</article>
</div>

</div>
</div>
<nav role="navigation" class="footer-nav"> <a href="/">Archives</a>
</nav>
<footer role="contentinfo"><span class="credit">&copy; 2016 Polina Soshnin.
</footer>
</div>
</body>
</html>

