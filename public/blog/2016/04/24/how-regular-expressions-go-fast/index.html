
<!DOCTYPE html>


<html class="no-js" lang="en">
<head>
<meta charset="utf-8">
<title>you can take the derivative of a regular expression?! - Polina Soshnin</title>
<meta name="author" content="Julia Evans">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="description" content="you can take the derivative of a regular expression?!">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="canonical" href="https://jvns.ca/blog/2016/04/24/how-regular-expressions-go-fast/">
<link href="/favicon.ico" rel="icon">
<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
<link href="/atom.xml" rel="alternate" title="Julia Evans" type="application/atom+xml">
 
<link href="https://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='https://fonts.googleapis.com/css?family=Montserrat:700,400' rel='stylesheet' type='text/css'>
<link href='https://fonts.googleapis.com/css?family=Alegreya:400,900,700' rel='stylesheet' type='text/css'>
</head>
<body>
<div id="wrap">
<header role="banner">
<hgroup>
<h1><a href="/">Polina Soshnin</a></h1>
</hgroup>
<ul class="header-links">
<span><li><a href="/about">About</a></li>
<li><a href="/projects">Projects</a></li></span>
    <li><a href="https://github.com/polinadotio">Github</a></li></span>
    <li><a href="https://www.linkedin.com/in/polinasoshnin">LinkedIn</a></li></span>
</ul>
</header>
<nav role="navigation" class="header-nav"><ul class="main-navigation">
<li><a href="/categories/favorite/">Favorites</a></li>
<li><a href="/zines">Zines</a></li>
</ul>
</nav>
<div id="main">
<div id="content">

<div>
<article class="hentry" role="article">
<header>
<h1 class="entry-title">you can take the derivative of a regular expression?!</h1>

<div class="post-tags">
  
</div>
<p class="meta">
<time datetime="2016-04-24T22:09:05" pubdate data-updated="true"></time>
</p>
</header>
<div class="entry-content">
     

<p>And it&rsquo;s actually useful?!</p>

<p>Paul Wankadia sent me an email yesterday about regular expressions and I thought it was so interesting I decided to write up some of what I learned from it. I thought I knew how regular expressions worked on computers because I took a class on them in university (hi prakash), but it turns out that no, I did not know.</p>

<p>The email was about a couple of regular expression libraries he works on: <a href="https://github.com/google/re2">RE2</a>, Google&rsquo;s regular expression library, and <a href="https://github.com/google/redgrep">redgrep</a>.</p>

<p>I did not know what RE2 was, and it is the older library, so let&rsquo;s start there.</p>

<h3 id="regular-expressions-the-university-class">regular expressions: the university class</h3>

<p>I took a class on regular expressions in university. In them, I learned that you have &ldquo;regular languages&rdquo;, which can be matched by deterministic finite automata, or DFAs. I&rsquo;m not going to explain what those are here because I do not have space but here is a DFA. It has two states, and its job is to detect strings with an even number of zeroes.</p>

<p><img src="/images/dfa.png"></p>

<p>So, if you&rsquo;re trying to see if the string &ldquo;00100&rdquo; matches, you&rsquo;ll go</p>

<pre><code>* start: S1
* see a 0: go to S2
* see a 0: go to S1
* see a 1: stay on S1
* see a 0: go to S2
* see a 0: go to S1
* S1 is an &quot;accept&quot; state because of the two circles around it!
that means that the string 0000 matches! Yay!
</code></pre>

<p>In any class like this, you&rsquo;ll prove that any regular expression can be represented as an NFA (nondeterministic finite automaton), which can in turn be translated into a DFA (like the picture above). if you never took this class this may be confusing and I apologize.</p>

<p>the important thing to know is: DFAs are simple and fast and very nice. they are state machines!</p>

<h3 id="how-do-you-do-regular-expressions-on-a-computer">how do you do regular expressions on a computer?</h3>

<p>So, now suppose that we have the regular expression <code>(1*01*0)*</code> to match any string with an even number of zeroes. That is the same as the DFA (above) and you might expect that it is actually implemented by&hellip; coding up a DFA as a state machine. Right? We said that DFAs are simple and beautiful and amazing and so the regular expression implementers probably used them.</p>

<p>Apparently this is not true! Our next stop is a series of <a href="https://swtch.com/~rsc/regexp/">posts on regular expressions by Russ Cox</a>, who originally wrote the RE2 library (<a href="http://google-opensource.blogspot.ca/2010/03/re2-principled-approach-to-regular.html">release blog post</a>). I think the best place to start is <a href="https://swtch.com/~rsc/regexp/regexp1.html">Regular Expression Matching Can Be Simple And Fast (but is slow in Java, Perl, PHP, Python, Ruby, &hellip;)</a>. This is a very good clickbait title, and lives up to its promise by also being an excellent article.</p>

<p>I&rsquo;m not going to try to explain the article (you should just read it! it is very clear.), but it basically says</p>

<ul>
<li>ken thompson wrote a great regular expression search algorithm in the 60s</li>
<li>perl &amp; friends use a different algorithm (backtracking) that has worse worst-case complexity (exponential)</li>
<li>at google they care about worst-case complexity because they would like their regular expressions to never explode exponentially in complexity.</li>
</ul>

<p>The ken thompson paper where he introduced this is called <a href="http://www.fing.edu.uy/inco/cursos/intropln/material/p419-thompson.pdf">Regular expression search algorithm</a>. I think this is more like using a DFA than like backtracking, but it does not create the DFA explicitly (because there can be an exponential blowup there for the same reasons, and you so you don&rsquo;t want to do it upfront).</p>

<p>RE2 uses an approach more like this ken thompson approach, so that no regular expression can explode and take forever.</p>

<p>Awesome. Let&rsquo;s move on.</p>

<h3 id="regular-expression-derivatives-and-redgrep">regular expression derivatives and redgrep</h3>

<p>everything up to here made sense to me. Apparently, though, there&rsquo;s more! in the next step of being a regular expressions nerd, we talk about &ldquo;regular expression derivatives&rdquo;. This idea comes from a paper <a href="http://dl.acm.org/citation.cfm?id=321249">&ldquo;Derivatives of Regular Expressions&rdquo;</a> by Janusz Brzozowski. (link where you have to pay to download the paper, but, sci-hub.io exists). <a href="https://en.wikipedia.org/wiki/Brzozowski_derivative">Here is the wikipedia article</a>.</p>

<p>But we can describe some of the ideas in words. Let&rsquo;s say we have a regular expression which is supposed to match the strings (&lsquo;a&rsquo;, &lsquo;abab&rsquo;, &lsquo;aaaabb&rsquo;, &lsquo;bbc&rsquo;).</p>

<p>The derivative of those strings with respect to <code>'a'</code> is (&ldquo;, &lsquo;bab&rsquo;, &lsquo;aaabb&rsquo;) &ndash; you strip off the <code>a</code> from every string.</p>

<p>It turns out (which is not totally obvious to me, but I think if you go through all the cases it&rsquo;s not too bad) that you can take the derivative of any regular expression in a pretty straightforward way &ndash; like if you have <code>(a+)|(b+)</code>, the derivative with repect to <code>a</code> is <code>(a+)</code>. These derivatives turn out to combine in nice ways which is I guess why they are called derivatives.</p>

<p>When Kamal told me about taking the derivative of a string I FREAKED OUT for like 10 seconds and I was like &ldquo;omg you can&rsquo;t take the derivative of a string! WHERE EVEN IS THE LIMIT. OMG.&rdquo; But now I have calmed down and it seems cool.</p>

<p>This library <a href="https://github.com/google/redgrep">redgrep</a>, I think, compiles regular expressions into LLVM bytecode by repeatedly taking the derivative of the regular expression to give you a DFA, when it then translates to LLVM. There&rsquo;s <a href="https://www.youtube.com/watch?v=CMhqlRBfVX4&amp;feature=youtu.be">a talk about it!</a>. There are some pretty compelling examples of how it can take a complicated regular expression and translate it in to a pretty simple DFA.</p>

<p>The redgrep library is all C++ and is actually only a few thousands of lines of code, including tests. So I think it&rsquo;s not actually that unapproachable to read the whole thing if you&rsquo;re interested &ndash; the talk gives you a walk through of the code.</p>

<h3 id="cool">cool!</h3>

<p>I wanted to write this up because I got this email, was like &ldquo;this will take me a while to read&rdquo;, and writing up my understanding has helped me understand it better! There is definitely a lot of interesting stuff to read in these <a href="https://swtch.com/~rsc/regexp/">Russ Cox articles</a>. Time to go to sleep, though!</p>

</div>
<footer>
<div class="sharing">
<a href="http://twitter.com/share" class="twitter-share-button" data-url="https://jvns.ca/blog/2016/04/24/how-regular-expressions-go-fast/" data-via="b0rk" data-counturl="https://jvns.ca/blog/2016/04/24/how-regular-expressions-go-fast/">Tweet</a>
</div>
<p class="meta">
   
    <a class="basic-alignment left" href="https://jvns.ca/blog/2016/04/29/cdns-arent-just-for-caching/" title="Previous Post: CDNs aren&#39;t just for caching">CDNs aren&#39;t just for caching</a>
  
   
    <a class="basic-alignment right" href="https://jvns.ca/blog/2016/04/23/some-links-on-java-garbage-collection/" title="Previous Post: Some links on Java garbage collection">Some links on Java garbage collection</a>
  
</p>
</footer>
</article>
</div>

</div>
</div>
<nav role="navigation" class="footer-nav"> <a href="/">Archives</a>
</nav>
<footer role="contentinfo"><span class="credit">&copy; 2016 Polina Soshnin.
</footer>
</div>
</body>
</html>

