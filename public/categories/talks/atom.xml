<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title><![CDATA[Julia Evans]]></title>
  <link href="http://jvns.ca/atom.xml" rel="self"/>
  <link href="https://jvns.ca/categories/talks/atom/index.xml"/>
  <updated>0001-01-01T00:00:00+00:00</updated>
  <id>http://jvns.ca</id>
  <author>
    <name><![CDATA[Julia Evans]]></name>
  </author>
  <generator uri="http://gohugo.io/">Hugo</generator>

  
  <entry>
    <title type="html"><![CDATA[A swiss army knife of debugging tools: talk &amp; transcript]]></title>
    <link href="https://jvns.ca/blog/2016/09/17/strange-loop-talk/"/>
    <updated>2016-09-17T15:32:50+00:00</updated>
    <id>https://jvns.ca/blog/2016/09/17/strange-loop-talk/</id>
    <content type="html"><![CDATA[

<style>

.container {
    display: flex;
}
.slide {
    width: 50%;
}
.content {
    width: 50%;
    align-items: center;
    padding: 20px;
}

@media (max-width: 480px) { /*breakpoint*/
    .container {
        display: block;
    }
    .slide {
        width: 100%;
    }
    .content {
        width: 100%;
}

</style>

<p>Yesterday I gave a talk at Strange Loop. I&rsquo;ll try to write more about the conference and my favorite things about it later, but for now here&rsquo;s the talk I gave.</p>

<h3 id="video">video</h3>

<iframe width="560" height="315" src="https://www.youtube.com/embed/HfD9IMZ9rKY" frameborder="0" allowfullscreen></iframe>

<h3 id="transcript">transcript</h3>

<p>I mean &ldquo;transcript&rdquo; in a very loose sense here &ndash; this is pretty approximate. I wrote it all down without watching the actual talk I gave at all.</p>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_02.png"><img src="/images/stl-talk/slide_02_small.png"></a>
</div>
<div class="content">
<p>
Hi! I'm Julia. I work at Stripe and today I'm going to tell you about some of my favorite debugging tools!
</p>
<p>
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_03.png"><img src="/images/stl-talk/slide_03_small.png"></a>
</div>
<div class="content">
<p>
an alternate title slide!
</p>
<p>
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_04.png"><img src="/images/stl-talk/slide_04_small.png"></a>
</div>
<div class="content">
<p>
At Strange Loop we often talk about programming languages! This talk isn't about programming languages at all. Instead, we're going to talk about debugging tools that you can use to debug programs in <i> any </i> programming language. 
</p>
<p>
When Haskell does networking, it uses TCP. Python uses TCP! Fortran! So if we debug programs using networking tools, we can debug programs in any language.
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_05.png"><img src="/images/stl-talk/slide_05_small.png"></a>
</div>
<div class="content">
<p>
When I log into a computer, sometimes something has gone TERRIBLY WRONG. And in these situations, sometimes you can feel helpless! We're going to talk about tools you can use to figure out what has happened.
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_06.png"><img src="/images/stl-talk/slide_06_small.png"></a>
</div>
<div class="content">
<p>
I used to think to debug things, I had to be really really smart. I thought I had to stare at the code, and think really hard, and magically intuit what the bug was.
</p>
<p>
It turns out that this isn't true at all! If you have the right tools, fixing bugs can be *really easy*. Sometimes with just a little more information, you can figure out what's happening without being a genius at all.
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_07.png"><img src="/images/stl-talk/slide_07_small.png"></a>
</div>
<div class="content">
<p>
The last thing I want to encourage you to do before we start this talk is -- we're going to be talking about a lot of systems tools. It's easy to think "oh, this is operating systems, it's too hard."
</p>
<p>
But if you're not scared, you can usually figure out almost anything!
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_08.png"><img src="/images/stl-talk/slide_08_small.png"></a>
</div>
<div class="content">
<p>
So, when we normally debug, we usuually read the code, add print statements, and you should probably know the programing language of the program you're writing, right?
</p>
</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_09.png"><img src="/images/stl-talk/slide_09_small.png"></a>
</div>
<div class="content">
<p>
Nope! This isn't true at all. You can totally debug programs without having their source code or even knowing what language they're written in at all. That's what we're going to do in this talk.
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_10.png"><img src="/images/stl-talk/slide_10_small.png"></a>
</div>
<div class="content">
<p>
Here are some of the tools we're going to discuss in this talk! strace, ngrep, wireshark, etc.
</p>
<p>
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_11.png"><img src="/images/stl-talk/slide_11_small.png"></a>
</div>
<div class="content">
<p>
And the way that most of these work is like the following -- you have a question ("what file did my program open"), you use a tool to interrogate your operating system about what the program is doing, and hopefully the answer you get back helps you fix your problem.
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_12.png"><img src="/images/stl-talk/slide_12_small.png"></a>
</div>
<div class="content">
<p>
I'm going to explain how these tools work through a series of mysteries (the case of the missing configuration file! the case of the slow program! the case of the French website!) and then I'm going to go a little more in depth into two more tools -- perf and tcpdump.
</p>
<p>
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_13.png"><img src="/images/stl-talk/slide_13_small.png"></a>
</div>
<div class="content">
<p>
</p>
<p>
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_14.png"><img src="/images/stl-talk/slide_14_small.png"></a>
</div>
<div class="content">
<p>
Who's written a configuration file and been confused about why it didn't work and realized they were editing the WRONG FILE? Yeah, me too. This is really annoying! 
</p>
<p>
Normally to figure out what the right configuration file is for your program, you might read the documentation or as a coworker. But what if the documentation is wrong, or your coworker doesn't know? What do you do if you want to be really sure?
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_15.png"><img src="/images/stl-talk/slide_15_small.png"></a>
</div>
<div class="content">
<p>
A really classic example of this is .bashrc vs .bash_profile -- when you start bash, which configuration file does it use? How can you tell? I actually know this through experience, but what if I didn't?
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_16.png"><img src="/images/stl-talk/slide_16_small.png"></a>
</div>
<div class="content">
<p>
To figure this out, we're going to use my absolute favorite program! STRACE. strace traces system calls.
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_17.png"><img src="/images/stl-talk/slide_17_small.png"></a>
</div>
<div class="content">
<p>
Let's talk about what a system call is. Your program does not itself know how to open files. To open a file, you need to understand how your hard drive works, and what filesystem is on that hard drive, and all kinds of complicated things.
</p>
<p>
Instead, your program asks the operating system to open a file. One that file is open, it can ask the OS to read and write to the file. The words I've underlined in red (open and read) are called **system calls**.
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_18.png"><img src="/images/stl-talk/slide_18_small.png"></a>
</div>
<div class="content">
<p>
strace will tell you every system call a program is running. To run strace on a program, you just say "strace" before it.
</p>
<p>
When I run strace on bash and ask it to look at just "open" system calls, I can see that it's opening .bashrc! Great! We win.
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_20.png"><img src="/images/stl-talk/slide_20_small.png"></a>
</div>
<div class="content">
<p>
So we answered our question! Awesome.
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_19.png"><img src="/images/stl-talk/slide_19_small.png"></a>
</div>
<div class="content">
<p>
Before we move on, I want to show you a quick demo of what it actually looks like to use strace. (do demo>
</p>
<p>
What you see is that strace prints approximately a billion lines of output, and you very very likely don't know what they all mean. This is okay!
</p>
<p>
When I use strace, I ignore practically everything, and just grep to find the one thing I'm interested in. This makes it a lot easier to understand :)
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_21.png"><img src="/images/stl-talk/slide_21_small.png"></a>
</div>
<div class="content">
<p>
An extremely important thing to know about strace is that if you run it on a program, it can make that program run up to 50x slower, depending on how many system calls that program uses.
</p>
<p>
So don't run it on your production database.
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_22.png"><img src="/images/stl-talk/slide_22_small.png"></a>
</div>
<div class="content">
<p>
Here are some of my favorite system calls! There are system calls for communicating over the network (what computers is my program talking to?), for reading and writing files, and executing programs.
</p>
<p>
execve is one of my favorites because -- sometimes I write scripts that run a bunch of other programs. If the script is doing the wrong thing, it can be really annoying to debug! Reading code is a lot of work.
</p>
<p>

But if you use strace, you can just see the commands that got run really quickly, see what is wrong, and then go back and track it down in your program to fix it.
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_23.png"><img src="/images/stl-talk/slide_23_small.png"></a>
</div>
<div class="content">
<p>
Some really important command line flags to strace! -f lets you strace the process and every subprocess it creates.  I basically always run strace with -f.
</p>
<p>
-y is an amazing flag in new versions of strace that shows you the filename of the file you're reading to and writing from. (instead of just the file descriptor)
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_24.png"><img src="/images/stl-talk/slide_24_small.png"></a>
</div>
<div class="content">
<p>
I was so excited when I learned about strace, and I couldn't believe that I'd been programming for 9 years without knowing about it. So I wrote a zine about my love for strace. You can find it at <a href="http://jvns.ca/zines">jvns.ca/zines</a>
</p>
<p>
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_25.png"><img src="/images/stl-talk/slide_25_small.png"></a>
</div>
<div class="content">
<p>
Okay, so I told you that strace is slow! What if you want something that is not slow? If you're on a Linux kernel version above 4.4 or so, you're in luck. There's a set of tools you can download from <a href="https://github.com/iovisor/bcc">https://github.com/iovisor/bcc</a>, which include something called "opensnoop".
</p>
<p>
(do opensnoop demo). Basically opensnoop can tell you which files your programs are opening, but without slowing down your programs! amazing!
</p>
<p>
In particular Ubuntu 16.04 is new enough for this tool.
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_26.png"><img src="/images/stl-talk/slide_26_small.png"></a>
</div>
<div class="content">
<p>
Opensnoop (and the other scripts in that repo I linked to) work using eBPF. <a href="http://www.brendangregg.com/"> Brendan Gregg</a> has been writing a lot about eBPF for a while. It seems super interesting.
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_27.png"><img src="/images/stl-talk/slide_27_small.png"></a>
</div>
<div class="content">
<p>
Okay, next mystery!
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_28.png"><img src="/images/stl-talk/slide_28_small.png"></a>
</div>
<div class="content">
<p>
Here I'm going to discuss 3 slow programs, which are all slow for different reasons. We're going to figure out why they're all slow, without reading the source code or anything. All the programs are written in Python.
</p>
<p>
They're slow because of CPU time, writing too much to disk, and because of waiting for a reply from a network connection.
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_29.png"><img src="/images/stl-talk/slide_29_small.png"></a>
</div>
<div class="content">
<p>
Here's the first one!
</p>
<p>
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_31.png"><img src="/images/stl-talk/slide_30_small.png"></a>
</div>
<div class="content">
<p>
I'm going to run `time` on all these programs. time is a nice program! It tells you how long the program took (2 seconds), but that's not all!
</p>
<p>
It also breaks down how the time was spent. This program spent 5% of its time on the CPU! So for the remaining 95% of the time it was waiting.
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_32.png"><img src="/images/stl-talk/slide_32_small.png"></a>
</div>
<div class="content">
<p>
The program could have been waiting for a lot of different things! Network, disk, just because it decided to hang out and wait?
</p>
<p>
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_33.png"><img src="/images/stl-talk/slide_33_small.png"></a>
</div>
<div class="content">
<p>
Luckily this is pretty easy to find out! We can peer into the Linux kernel's soul and figure out what it was doing when the program was waiting.
</p>
<p>
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_34.png"><img src="/images/stl-talk/slide_34_small.png"></a>
</div>
<div class="content">
<p>
For any program, we can take the program's PID (in this case 31728), and ask what the Linux kernel is doing for that program right now.
</p>
<p>
We get a call stack starting with the system call and ending up with the current function. Awesome!
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_35.png"><img src="/images/stl-talk/slide_35_small.png"></a>
</div>
<div class="content">
<p>
To help you see what's going on, I deleted almost everything. I know what tcp_recvmsg means! It means it's waiting to receive a message on a TCP connection!
</p>
<p>
That's networking! That was really easy! We don't need to be kernel debugging wizards to figure out what's going on.
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_36.png"><img src="/images/stl-talk/slide_36_small.png"></a>
</div>
<div class="content">
<p>
</p>
<p>
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_37.png"><img src="/images/stl-talk/slide_37_small.png"></a>
</div>
<div class="content">
<p>
This was the actual program that the server was running -- you can see that it sleeps for 2 seconds, and then returns a response of "hi!".
</p>
<p>
So it's obvious why the program was slow :) But you can apply the exact same technique to much more complicated programs.
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_38.png"><img src="/images/stl-talk/slide_38_small.png"></a>
</div>
<div class="content">
<p>
</p>
<p>
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_40.png"><img src="/images/stl-talk/slide_40_small.png"></a>
</div>
<div class="content">
<p>
When we run `time` on our next program, we see something really interesting right away! It's spending 99% of its time just using the CPU.
</p>
<p>
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_41.png"><img src="/images/stl-talk/slide_41_small.png"></a>
</div>
<div class="content">
<p>
At this point we're actually done -- since this is a Python program, the easiest thing to do is probably just to run a Python profiler to find out what it was doing.
</p>
<p>
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_42.png"><img src="/images/stl-talk/slide_42_small.png"></a>
</div>
<div class="content">
<p>
And what it was actually was adding up 14 million numbers. You can decide whether you think 2.74 seconds is how long you think it should take to add up 14 million numbers or not :)
</p>
<p>
(I made a whole game about this called <a href="http://computers-are-fast.github.io/">computers are fast </a>)
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_43.png"><img src="/images/stl-talk/slide_43_small.png"></a>
</div>
<div class="content">
<p>
</p>
<p>
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_44.png"><img src="/images/stl-talk/slide_44_small.png"></a>
</div>
<div class="content">
<p>
Okay, this one is spending 94% of its time on the CPU. So this is basically the same as before, right? Nope!
</p>
<p>
You'll notice that there are two kinds of CPU your program can use: <b> user</b> CPU and <b> system</b> CPU. This one is spending most of its time on CPU, but CPU in the kernel! So your program is still spending most of its time waiting.
</p>
<p>
</p>
</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_45.png"><img src="/images/stl-talk/slide_45_small.png"></a>
</div>
<div class="content">
<p>
If you have a program that's waiting, a nice way to try to figure out what's going on is to use <b> dstat </b>
</p>
<p>
dstat is a nice little program that prints our how much network, disk, and CPU your program is using 
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_46.png"><img src="/images/stl-talk/slide_46_small.png"></a>
</div>
<div class="content">
<p>
Here I do a demo where I run a program (python mystery_3.py), and run `dstat` while the program is running.
</p>
<p>
dstat is shows that while our program is running, 300MB/s get written to disk. When the program stops, the disk writes stop. Interesting!
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_47.png"><img src="/images/stl-talk/slide_47_small.png"></a>
</div>
<div class="content">
<p>
So we understand that something's going on with writes, but why is it using all this CPU? Surely disk writes don't use that much CPU?
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_48.png"><img src="/images/stl-talk/slide_48_small.png"></a>
</div>
<div class="content">
<p>
Who's used top? (everyone) htop? (a few less people) perf top? (almost nobody)
</p>
<p>
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_49.png"><img src="/images/stl-talk/slide_49_small.png"></a>
</div>
<div class="content">
<p>
So, top tells you which one of your programs is using all your CPU. That's great.
</p>
<p>
But it doesn't tell you which *functions* your programs are running. `perf top` does, though! Let's see what that looks like.
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_50.png"><img src="/images/stl-talk/slide_50_small.png"></a>
</div>
<div class="content">
<p>
I run `python mystery_3.py` again, and I quickly switch to another terminal tab and run `perf top`. perf top shows a bunch of functions and how much CPU time each one is using.
</p>
<p>
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_51.png"><img src="/images/stl-talk/slide_51_small.png"></a>
</div>
<div class="content">
<p>
There was a lot to look at one the screen, so let's zoom in. The top function is something called `_aesni_enc1`. What does AES tell us? ENCRYPTION! That's right!
</p>
<p>
So it turns out that this program is writing files to disk, and specifically it's writing to my home directory. But my home directory is encrypted! So it needs to spend a bunch of extra time encrypting all the data, and that's what all the CPU time is about. Awesome.
</p>
<p>
So we've solved our mystery!
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_52.png"><img src="/images/stl-talk/slide_52_small.png"></a>
</div>
<div class="content">
<p>
One really awesome thing about perf is -- normally perf only tells you about which *C functions* are running on your computer. But you might want to know about which functions in your programming language are running on your computer! In Java, you can use <a href="https://github.com/jrudolph/perf-map-agent">perf-map-agent</a> to get perf to tell you what Java functions are running on your computer!
</p>
<p>
And you can do the same thing <a href="http://www.brendangregg.com/blog/2014-09-17/node-flame-graphs-on-linux.html">with node.js</a>.
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_53.png"><img src="/images/stl-talk/slide_53_small.png"></a>
</div>
<div class="content">
<p>
Our last performance program we're going to look at is the case of the French website.
</p>
<p>
I live in Montreal, and it's a bilingual city, so when you open a city website, it might show up in either French or English. You never know! What determines that?
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_54.png"><img src="/images/stl-talk/slide_54_small.png"></a>
</div>
<div class="content">
<p>
This is a website I made for this conference. It just says "hello! welcome to strange loop!" Great.
</p>
<p>
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_55.png"><img src="/images/stl-talk/slide_55_small.png"></a>
</div>
<div class="content">
<p>
But when I get the very same website from my terminal, it replies in French, not in English! What's going on!
</p>
<p>
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_56.png"><img src="/images/stl-talk/slide_56_small.png"></a>
</div>
<div class="content">
<p>
Most of you probably use grep, which lets you search text files. ngrep is a program that lets you search your network traffic!
</p>
<p>
Here I do a demo where I use ngrep to show all TCP packets on localhost. We
see that with curl, there's a very very simple HTTP request, but Google Chrome
has a much longer request and a lot more to share with the server. In
particular, the request has the string "Accept-Language: en-US" in it. When we
add that header to our curl request, we get a response in English! Awesome.
</p>
<p>

Computer programs aren't always deterministic, but they're always logical. If
you're seeing a difference where you think there shouldn't be any, there's
always a reason. Looking at the inputs and outputs to your programs can help you figure out what's going on, and network traffic is a really nice place to do that.

</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_57.png"><img src="/images/stl-talk/slide_57_small.png"></a>
</div>
<div class="content">
<p>
Okay, so this is a totally new section of the top.
</p>
<p>
Here we're going to talk about two of my favorite things: perf and tcpdump.
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_58.png"><img src="/images/stl-talk/slide_58_small.png"></a>
</div>
<div class="content">
<p>
perf is a profiling tool for Linux that a lot of people don't know about, mostly because it's really sparsely documented. My goal today is to change that a little bit.
</p>
<p>
One really confusing thing about perf is that it actually has 3 almost totally unrelated tools in them: it can tell you about your hardware counters, do sampling profiling for CPU, and trace events. I'm going to talk about all these 3 things separately.
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_59.png"><img src="/images/stl-talk/slide_59_small.png"></a>
</div>
<div class="content">
<p>

Before we move on, I want to talk about sampling vs tracing for a little bit.
In a sampling profiler, you look at a small percentage of what's going on in
your program (what's the stack trace now? how about now?), and then use that information to generalize about what your program is doing.

</p>
<p>
This is great because it reduces overhead, and usually gives you a good idea of what your program is doing.
</p>
<p>
But what happens if you have an error that happens infrequently? like 1 in 1000 times. You might think this is not a big deal, and in fact for a lot of people that might not be a big deal.
</p>
<p>

But I write programs that do things millions or billions of times, and I want
those things to be really highly reliable, so even relatively rare events are
important to me. So I love tracing tools and log files that can tell me
**everything** about when a certain function is called. This makes it a lot easier to debug than just having a general statistical distribution! <br> This is a great <a href="http://danluu.com/perf-tracing/">post about tracing tools</a> by Dan Luu.
</p>


</div>

<p></div>
</div></p>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_60.png"><img src="/images/stl-talk/slide_60_small.png"></a>
</div>
<div class="content">
<p>
Let's start with hardware counters. The story with these is that your computer's hardware has a lot of events it can count and keep track of for you, if you just ask it to.
</p>
<p>
We're going to talk about one small thing you might like to count: L1 cache misses.
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_61.png"><img src="/images/stl-talk/slide_61_small.png"></a>
</div>
<div class="content">
<p>
Very very close to your CPU, there is a small data cache called the L1 cache. It's very fast to access the L1 cache, maybe 0.5 nanoseconds. But if you want to get data from RAM, it's slow! 200x slower. 
</p>
<p>
So if you're accessing data and working with on it on the CPU, and trying to do this in a high performance way, you care about whether your data is coming from a CPU cache or from RAM.
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_62.png"><img src="/images/stl-talk/slide_62_small.png"></a>
</div>
<div class="content">
<p>
There are a ton of these numbers that are interesting to know -- there's a famous gist file called "latency numbers every programmer should know"
</p>
<p>
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_63.png"><img src="/images/stl-talk/slide_63_small.png"></a>
</div>
<div class="content">
<p>
Here it is.
</p>
<p>
I don't actually have all these numbers memorized, but I do find this useful to remember a few things from it -- if I want something to happen in a microsecond, I know I absolutely cannot have a network request happening, for example.
</p>
<p>
But all of thse numbers seemed really abstract to me for a long time. How can you even know whether or not your program is using a L1 cache? That's like inside your computer! I can't see inside my computer!
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_64.png"><img src="/images/stl-talk/slide_64_small.png"></a>
</div>
<div class="content">
<p>

But you can! `perf stat` will let you look at all kinds of counters, and in
particular it can show you how many L1 cache misses you have. Here we have `ls` and we can see that there were about 40,000 cache misses. So this is something you can totally measure.

</p>
<p>
I wrote a blog post about this in <a href="http://jvns.ca/blog/2014/05/13/profiling-with-perf/">I can spy on my CPU cycles with perf!</a>

</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_65.png"><img src="/images/stl-talk/slide_65_small.png"></a>
</div>
<div class="content">
<p>
Next up, let's talk about sampling profilers! So there's a system in the Linux kernel called `perf_events`, where you can ask it "hey, keep track of what my program is doing for me, okay?". And it'll collect statistics and report them back to you. This is how the program `perf top` works that I showed you earlier.
</p>
<p>
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_66.png"><img src="/images/stl-talk/slide_66_small.png"></a>
</div>
<div class="content">
<p>
To ask Linux to start recording performance information for you, you run `perf record` on your program. The -g flag is really great because it lets you collect full stack traces for everything that's happening.
</p>
<p>
And then you can generate a nice report with `sudo perf report`!
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_67.png"><img src="/images/stl-talk/slide_67_small.png"></a>
</div>
<div class="content">
<p>
Here's what that report looks like. This is from recording how the program `find` spends its time.
</p>
<p>
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_68.png"><img src="/images/stl-talk/slide_68_small.png"></a>
</div>
<div class="content">
<p>
If we zoom in, we can see all these `getdents` functions. This makes sense because find spends all its time searching through directories, and `getdents` is how you list a directory on Linux.
</p>
<p>
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_69.png"><img src="/images/stl-talk/slide_69_small.png"></a>
</div>
<div class="content">
<p>
Now let's talk about an awesome way to look at these  performance reports: flame graphs. These are basically a way to visualize stack traces: `main` is at the bottom, and of course you spend all your time there, and as you go up you see how the time is split up between different inner functions.
</p>
<p>
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_70.png"><img src="/images/stl-talk/slide_70_small.png"></a>
</div>
<div class="content">
<p>
Here's an artisanal flame graph I drew to help explain what these flame graphs mean exactly! 
</p>
<p>
Basically we start out in main, and then 20% of the time we go to `panda` and 80% of the time we go to alligator. And so on.
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_71.png"><img src="/images/stl-talk/slide_71_small.png"></a>
</div>
<div class="content">
<p>
flamegraphs aren't just for perf: you can also generate them from other tools. The software I used to make this graph is on github, and by Brendan Gregg: <a href="https://github.com/brendangregg/FlameGraph">https://github.com/brendangregg/FlameGraph</a>
</p>
<p>
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_72.png"><img src="/images/stl-talk/slide_72_small.png"></a>
</div>
<div class="content">
<p>
So, let's talk about the last part of this: tracing. </p>
<p>
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_73.png"><img src="/images/stl-talk/slide_73_small.png"></a>
</div>
<div class="content">
<p>
We've already talked about two ways to trace events: strace traces system calls (but is slow), opensnoop and other eBPF-based tools do tracing (but aren't always available). The eBPF stuff is actually more powerful than `perf trace`, but I think `perf trace` might be a little more widely available.
</p>
<p>
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_74.png"><img src="/images/stl-talk/slide_74_small.png"></a>
</div>
<div class="content">
<p>
I can run `perf trace` on my laptop like this.
</p>
<p>
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_75.png"><img src="/images/stl-talk/slide_75_small.png"></a>
</div>
<div class="content">
<p>
And here's what the output looks like! We see a lot of system calls. This is kind of unfortunate, though -- it's actually dropping a lot of events. I think what's happening here is -- perf's kernel component writes events into a ring buffer in userspace, and I think that buffer's maybe filling up. So writing a tracing system that doesn't drop events apparently isn't trivial! Interesting.
</p>
<p>
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_76.png"><img src="/images/stl-talk/slide_76_small.png"></a>
</div>
<div class="content">
<p>
</p>
<p>
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_77.png"><img src="/images/stl-talk/slide_77_small.png"></a>
</div>
<div class="content">
<p>
Okay, so we learned about ngrep earlier and how we can use it to find out why a website is in French.
</p>
<p>
ngrep is an amazing starter tool (and it can actually do a lot!), but what if you want to do something that you can't do with ngrep? Let's talk about tcpdump and wireshark!
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_78.png"><img src="/images/stl-talk/slide_78_small.png"></a>
</div>
<div class="content">
<p>
It took me a long time to learn these two tools, but now I think they're pretty useful.
</p>
<p>
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_79.png"><img src="/images/stl-talk/slide_79_small.png"></a>
</div>
<div class="content">
<p>
(demo of running tcpdump)
</p>
<p>
When you run tcpdump, it's originally pretty scary -- you end up seeing all this stuff you don't understand. But it turns out that it's totally okay! You can actually just use tcpdump to record the network traffic you're interested in analyzing, and then put it on your laptop and analyze it with some more user-friendly tools. 
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_80.png"><img src="/images/stl-talk/slide_80_small.png"></a>
</div>
<div class="content">
<p>
When you run tcpdump, you can always use a filter. `perf 80` is called a "berkeley packet filter", which is a small language that gets compiled to a virtual machine that lets you really quickly filter network traffic.
</p>
<p>
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_82.png"><img src="/images/stl-talk/slide_82_small.png"></a>
</div>
<div class="content">
<p>
The BPF filter language (at least at a basic level) is pretty easy to learn -- you can filter by IP address and port, and those two things by themselves will already take you a long way. 
</p>
<p>
I don't really know more than that and that's good enough for me.
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_81.png"><img src="/images/stl-talk/slide_81_small.png"></a>
</div>
<div class="content">
<p>
When you write out network data with tcpdump, it goes into a "pcap file".
</p>
<p>
Basically every network analysis tool understand pcap files, so this is awesome.
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_83.png"><img src="/images/stl-talk/slide_83_small.png"></a>
</div>
<div class="content">
<p>
You can also just print out tcp packets to your screen with `tcpdump -A`. I do this sometimes when I'm like ARE THERE EVEN PACKETS COMING INTO THIS MACHINE. Usually this is when I find out I've gotten my firewall settings wrong.
</p>
<p>
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_84.png"><img src="/images/stl-talk/slide_84_small.png"></a>
</div>
<div class="content">
<p>
Okay, so you've recorded some network data with tcpdump, and you want to analyze it!
</p>
<p>
We're going to look at it with Wireshark!
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_85.png"><img src="/images/stl-talk/slide_85_small.png"></a>
</div>
<div class="content">
<p>
this is what it looks like when you open wireshark
</p>
<p>
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_86.png"><img src="/images/stl-talk/slide_86_small.png"></a>
</div>
<div class="content">
<p>
this can be scary to look at, kind of like tcpdump, because there is all this INFORMATION and what does it even MEAN
</p>
<p>
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_87.png"><img src="/images/stl-talk/slide_87_small.png"></a>
</div>
<div class="content">
<p>
But Wireshark is not actually impossible to use. It has a really good filtering language and a lot of things to click on. The UI is pretty reasonable, though you do have to ignore a lot of stuff you don't understand.
</p>
<p>
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_88.png"><img src="/images/stl-talk/slide_88_small.png"></a>
</div>
<div class="content">
<p>
For example! I wanted to filter this network traffic so I searched for all the GET requests. Not that hard!
</p>
<p>
here we see that there are only 5 packets here, I can see where they came from and where they went to, and what time they happened at. Neat! 
</p>
<p>
Wireshark also understand a ton of common network protocols, which is amazing. It understand simple stuff like HTTP, but also more complicated stuff like the MongoDB protocol!  So if you recorded Mongo traffic, which uses a binary protocol, Wireshark will know things like "This is the database table you were querying!"
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_89.png"><img src="/images/stl-talk/slide_89_small.png"></a>
</div>
<div class="content">
<p>
If you click on 'Statistics -> Conversations', you can also see how long each of the TCP conversations took, which is super awesome.
</p>
<p>
It's like.. Who are you? Are you a magician!?
Yes, I'm Wireshark! I'm a magical shark!
Good thing you're on my side!
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_90.png"><img src="/images/stl-talk/slide_90_small.png"></a>
</div>
<div class="content">
<p>
So all this is to say -- if you learn your operating systems, there are a ton of awesome tools available to you to understand your programs. 
</p>
<p>
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_91.png"><img src="/images/stl-talk/slide_91_small.png"></a>
</div>
<div class="content">
<p>
And a lot of these tools are totally possible to use! My favorite thing in the world is when people tell me "hi julia! I used this tool you told me about and now my boss thinks I'm a genius." This could be you!
</p>
<p>
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_92.png"><img src="/images/stl-talk/slide_92_small.png"></a>
</div>
<div class="content">
<p>
I think all this is really important and often poorly documented, so I wrote <a href="http://jvns.ca/zines/#linux-debugging-tools">a zine explaining a lot of these tools</a>, which gives simple summaries of what all of them do. You can read it and print it out and give it to your friends.
</p>
<p>
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/stl-talk/slide_93.png"><img src="/images/stl-talk/slide_93_small.png"></a>
</div>
<div class="content">
<p>
Thanks for listening.
</p>
<p>
</p>

</div>
</div>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Learning systems programming with Rust]]></title>
    <link href="https://jvns.ca/blog/2016/09/11/rustconf-keynote/"/>
    <updated>2016-09-11T10:45:47+00:00</updated>
    <id>https://jvns.ca/blog/2016/09/11/rustconf-keynote/</id>
    <content type="html"><![CDATA[

<style>

.container {
    display: flex;
}
.slide {
    width: 40%;
}
.content {
    width: 60%;
    align-items: center;
    padding: 20px;
}

@media (max-width: 480px) { /*breakpoint*/
    .container {
        display: block;
    }
    .slide {
        width: 100%;
    }
    .content {
        width: 100%;
}

</style>

<p>I did the closing keynote at the first RustConf yesterday, on Rust and systems
programming and accessibility and learning about concurrency and why I write
about programming and a bunch of other things.</p>

<p>I was really delighted to be invited because I&rsquo;m a huge fan of the Rust
community. They&rsquo;re working incredibly hard to make a language that is
extremely powerful, but also easy to use, and there was a huge focus on
usability and good error messages. The talks were really ambitious, friendly,
and inclusive. Their challenge is &ldquo;Fast, safe, productive &ndash; pick three&rdquo; :).</p>

<p>Here&rsquo;s a video &amp; transcript of that talk (where when I say &ldquo;transcript&rdquo; I mean &ldquo;more
less what I said, kinda&rdquo;).</p>

<h3 id="video">video</h3>

<iframe width="560" height="315" src="https://www.youtube.com/embed/ftQfpAeyxPo" frameborder="0" allowfullscreen></iframe>

<h3 id="transcript">transcript</h3>

<p>You can click on any of the slides to see a big version.</p>

<p>I drew the slides with <a href="https://www.amazon.com/Samsung-Galaxy-9-7-Inch-Tablet-Titanium/dp/B00V49LQZ4">this Samsung tablet</a>, and Powerpoint for android. These were the easiest slides I&rsquo;ve ever made.</p>

<div class="container">
<div class="slide">
<a href="/images/rust-talk/slide_01.png"><img src="/images/rust-talk/slide_01_small.png"></a>
</div>
<div class="content">

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/rust-talk/slide_02.png"><img src="/images/rust-talk/slide_02_small.png"></a>
</div>
<div class="content">

These are the 4 themes I want to talk about in this talk! Let's go.

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/rust-talk/slide_03.png"><img src="/images/rust-talk/slide_03_small.png"></a>
</div>
<div class="content">

A lot of people love Rust for these 3 reasons. And more! memory safety without garbage collection! These are great reasons to love Rust.

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/rust-talk/slide_04.png"><img src="/images/rust-talk/slide_04_small.png"></a>
</div>
<div class="content">
But that's not why I love Rust. I'm kind of a beginner Rust programmer, my understanding of the borrow checker is flaky, I've written maybe 1000 lines of Rust code, and I'm not writing any production Rust code.

<br><br>
I spend a lot of my time on a comet very far away from Rust. So why am I talking to you right now?
</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/rust-talk/slide_05.png"><img src="/images/rust-talk/slide_05_small.png"></a>
</div>
<div class="content">


I care a lot about learning about systems, and I've spent a lot of my time doing that. I love doing experiments with programming, and I think Rust is a super good platform for experiments. And the community has helped me out!

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/rust-talk/slide_06.png"><img src="/images/rust-talk/slide_06_small.png"></a>
</div>
<div class="content">

When Aaron invited me to give this talk (which was, like, the best day ever), he wrote

<p>
"We see the language as empowering for a wide variety of people who
might not otherwise consider themselves systems programmers."
</p>

And the person who doesn't consider themselves as a systems programmer! That has TOTALLY BEEN ME. So let's talk about experiments and empowement.

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/rust-talk/slide_07.png"><img src="/images/rust-talk/slide_07_small.png"></a>
</div>
<div class="content">

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/rust-talk/slide_08.png"><img src="/images/rust-talk/slide_08_small.png"></a>
</div>
<div class="content">

I do a lot of programming experiments to learn more about programming. My goal with these experiments usually isn't to produce anything of value. Instead I just want to learn something!

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/rust-talk/slide_09.png"><img src="/images/rust-talk/slide_09_small.png"></a>
</div>
<div class="content">

In 2013, I'd been working as a programmer for 2 years, I had 2 CS degrees, and I knew all kinds of things about computer science. But there was still SO MUCH I didn't know.

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/rust-talk/slide_10.png"><img src="/images/rust-talk/slide_10_small.png"></a>
</div>
<div class="content">

In particular, I didn't know anything really about how the Linux kernel worked, even though I'd been using Linux for 8 years. I think I'd never heard the words "system call".

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/rust-talk/slide_11.png"><img src="/images/rust-talk/slide_11_small.png"></a>
</div>
<div class="content">

<p>
</p>
So I went to the Recurse Center! RC is a 12-week programming retreat in New York where you go to learn whatever you want about programming. 

<p>
It's totally self-directed, and while I was there I ended up spending a lot of time learning about operating systems, because that was the most confusing thing I could find to work on.
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/rust-talk/slide_12.png"><img src="/images/rust-talk/slide_12_small.png"></a>
</div>
<div class="content">

On my <a href="http://jvns.ca/blog/2013/10/02/day-3-what-does-the-linux-kernel-even-do/">third day </a> at RC, I learned what the Linux kernel does! I found out what a system call is! 

<p>
It turns out it had a pretty simplex explanation -- your operating system knows how to do things like open files, you program does not, so your program asks your operating system to do things with system calls! Like `open`.
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/rust-talk/slide_13.png"><img src="/images/rust-talk/slide_13_small.png"></a>
</div>
<div class="content">

Three weeks before the end of my time there, I decided to write an operating system. Lindsey Kuper suggested I try Rust, which I was also a beginner at, so I tried that!

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/rust-talk/slide_14.png"><img src="/images/rust-talk/slide_14_small.png"></a>
</div>
<div class="content">
<p>
It turns out that writing an operating system in 3 weeks is actually impossible (at least for me!), so I reduced my scope a lot -- I decided to just write a keyboard driver from scratch. So my goal was, when I typed a key on my keyboard, that key would appear on my screen!
</p>
<p>
Turns out that this is not at all trivial.
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/rust-talk/slide_15.png"><img src="/images/rust-talk/slide_15_small.png"></a>
</div>
<div class="content">

<p>
So, one of the themes for this talk was "you can contribute without coding". I
really believe in this -- I think that code contributions are great, don't get
me wrong.
</p>

<p>
But I have basically never contributed code to an open source
project (even though I'm a programmer!) and I think I've contributed a lot to
open source communities.
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/rust-talk/slide_16.png"><img src="/images/rust-talk/slide_16_small.png"></a>
</div>
<div class="content">

<p>
When I started doing this I discovered a really surprising thing. At the time I was writing blog posts every day about what I'd learned that day.
</p>

<p>
And even though I was a beginner to both Rust and operating systems development, it turned out that some of these blog posts were really popular! People were learning from them!
</p>

<p>I wrote buzzfeed-style posts like "12 things I learned today about linkers", <a href="http://jvns.ca/blog/2013/12/04/day-37-how-a-keyboard-works/">After 5 days, my OS doesn't crash when I press a key</a>, <a href="http://jvns.ca/blog/2013/12/13/day-42-how-to-run-an-elf-executable-i-dont-know/">How to run a simple ELF executable, from scratch (I don't know)</a>, and a lot more.
</p>

<p>
So this is interesting, right! To teach people it turns out you don't have to be an expert at all. Maybe it's actually even better to be a beginner!
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/rust-talk/slide_17.png"><img src="/images/rust-talk/slide_17_small.png"></a>
</div>
<div class="content">

Niko made this comment "if it's not documented, it might as well not exist" in his keynote this morning. And I think this is really true. If there's an amazing program in the world, but you don't know about it.

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/rust-talk/slide_18.png"><img src="/images/rust-talk/slide_18_small.png"></a>
</div>
<div class="content">

<p>
My friend Maya jokes that I'm basically developer relations for strace.
</p>

<p>
This happened because in 2013, someone told me about strace, a program I love that traces system calls. And I was so shocked that I hadn't known about it before! So I started telling everyone.
</p>

<p>
And now all kinds of people know about strace because of me, and they have a new useful tool! So that basically makes me the inventor of strace for those people, right? :)
</p>

<p>
I like doing this in my spare time because I write code at work, so it's a really nice change of pace.
</p>
</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/rust-talk/slide_19.png"><img src="/images/rust-talk/slide_19_small.png"></a>
</div>
<div class="content">

<p>
Writing code is a lot of work. And when you write the code, if you want people to use it, it's a lot of work to tell people about it!
</p>

<p>
So I like to skip the whole first step of writing code, and just tell people about awesome things that already exist. I'm like the most productive software developer ever.
</p>
</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/rust-talk/slide_21.png"><img src="/images/rust-talk/slide_21_small.png"></a>
</div>
<div class="content">

<p>
Let's switch gears and talk about learning systems programming.
</p>
<p>
My coworker asked me the other day "I'm reading a book about Rust, what would be a good example program to write?". And this is a hard question to answer!
</p>
<p>
So here's a possible answer to that question. I think it's important to have a lot of answers like this, because there's so much to learn!
</p>
</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/rust-talk/slide_22.png"><img src="/images/rust-talk/slide_22_small.png"></a>
</div>
<div class="content">

<p>
So one evening, I was at home, and I wanted to know more about concurrency.
</p>
</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/rust-talk/slide_23.png"><img src="/images/rust-talk/slide_23_small.png"></a>
</div>
<div class="content">

<p>
But this isn't a very specific question! A better question is -- what are the systems primitives for concurrency?
</p>
<p>
I knew that a lot of concurrent programs used the same kind of functions and ideas and systems calls. So what were those things, and how did they work?
</p>
<p>
Many concurrent programs use operating systems threads, they need to control access to resources with mutexes, and sometimes they do these "atomic instruction" things.
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/rust-talk/slide_24.png"><img src="/images/rust-talk/slide_24_small.png"></a>
</div>
<div class="content">
<p>
My favorite way to start out exploring idea is to write a program that doesn't work.
</p>

<p>
It's easy to write unsafe programs in C, so I did it in C. I made 1000 threads that each incremented the same counter 1000 times. You should get 100000 at the end, right?
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/rust-talk/slide_25.png"><img src="/images/rust-talk/slide_25_small.png"></a>
</div>
<div class="content">
<p>
Nope! Instead we get a data race! The answer is way less than a million. This is great! I was very happy already because I'd made a race and it worked. 
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/rust-talk/slide_26.png"><img src="/images/rust-talk/slide_26_small.png"></a>
</div>
<div class="content">
<p>
So one of the first ways to work on concurrency is mutexes, or locks. You and all the other threads have one place where you go to control who's allowed to update the counter.
</p>
<p>
I like this as a simple example because you can just get it to work and move on, or, if you want, you can go a lot deeper.
</p>
<p>
For example! To use mutexes, underneath you often use a function called pthread_mutex_lock. And it turns out that sometimes that uses the futex system call, and sometimes it doesn't! So there's all kinds of hidden complexity.
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/rust-talk/slide_27.png"><img src="/images/rust-talk/slide_27_small.png"></a>
</div>
<div class="content">
<p>
The next thing I want to talk about is atomic instructions. Basically your CPU knows how to increment counters without races -- if you say "lock inc" then it will make sure that the counter gets incremented exactly once.
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/rust-talk/slide_28.png"><img src="/images/rust-talk/slide_28_small.png"></a>
</div>
<div class="content">
<p>
So now we have a nice small exercise! This is not really that hard to do in Rust, but it introduces a lot of new ideas.
</p>
<p>
And there are a lot of opportunities for questions, right? Like, are mutexes or atomics faster? How much? Why? I love problems that you can finish pretty easily, but take farther if you want.
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/rust-talk/slide_29.png"><img src="/images/rust-talk/slide_29_small.png"></a>
</div>
<div class="content">
<p>
Now we're onto the last part of the talk.
</p>
<p>
I originally wrote "impossible problems" here. But of course all programs are technically *possible* to write!
</p>
<p>
As we're going to learn shortly, though, right now I really do not know C, and I have a day job, and so my free time for programming is not unlimited. So even if a program is *possible* for me to write, if I have to write it in C/C++, probably in practice it's not going to happen.
</p>
<p>
I'm going to tell you about how Rust helped me write a program that I wanted to write, that would have been improbable otherwise.
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/rust-talk/slide_30.png"><img src="/images/rust-talk/slide_30_small.png"></a>
</div>
<div class="content">
<p>
This where we get back to EMPOWERMENT.
</p>
</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/rust-talk/slide_31.png"><img src="/images/rust-talk/slide_31_small.png"></a>
</div>
<div class="content">

<p>
So, here's the problem I was mad about. I'd run "top" on my computer, and it would tell me Ruby was using all the CPU, and I wouldn't know why.
</p>
</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/rust-talk/slide_32.png"><img src="/images/rust-talk/slide_32_small.png"></a>
</div>
<div class="content">
<p>
And the reason this made me mad, is that I could see what other programs like Chrome were doing with  <a href="http://jvns.ca/blog/2016/02/24/perf-top-my-new-best-friend/">perf top</a>
</p>
<p>
(cool demo of perf top goes here)
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/rust-talk/slide_33.png"><img src="/images/rust-talk/slide_33_small.png"></a>
</div>
<div class="content">
<p>
So I wanted to write a program that I could just give the PID of a Ruby process, and it would tell me the top Ruby functions that were running right now.
</p>
<p>
Is that possible? My friend Julian claimed this was totally possible and easy. So eventually I decided to try.
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/rust-talk/slide_34.png"><img src="/images/rust-talk/slide_34_small.png"></a>
</div>
<div class="content">
<p>
To do this from the outside, you have to basically spy on the internals of a running Ruby process.
</p>
<p>
The system call I used to spy is called process_vm_readv.
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/rust-talk/slide_35.png"><img src="/images/rust-talk/slide_35_small.png"></a>
</div>
<div class="content">
<p>
In the Ruby interpreter, you have the C stack. That has unhelpful things on it like "you're in vm_exec right now" which basically means "you're running a Ruby function"
</p>
<p>
BUT WHICH RUBY FUNCTION?!
</p>
<p>
But somewhere inside its memory, somewhere, you have the Ruby stack. That's what I wanted to get at.
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/rust-talk/slide_36.png"><img src="/images/rust-talk/slide_36_small.png"></a>
</div>
<div class="content">
<p>
I'm not going to go into the details of how this works because I don't have time, but I wrote a C demo of this program. I know how to write C! I can allocate memory in C! My demo kinda worked!
</p>
<p>
However, I do not really know how to *free* memory in C. Like, I technically know that there is a free function, but I don't have a lot of experience with it. So my program had some pretty serious memory issues almost right away.
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/rust-talk/slide_37.png"><img src="/images/rust-talk/slide_37_small.png"></a>
</div>
<div class="content">
<p>
At this point I asked my partner Kamal for some help translating my program to Rust.
</p>
<p>
At the time I used bindgen and it was awesome, it took maybe a day, and now I had a Rust program that did the same thing! Except I didn't have to know how to free memory anymore.
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/rust-talk/slide_38.png"><img src="/images/rust-talk/slide_38_small.png"></a>
</div>
<div class="content">
<p>
If you observe this highly scientific graph of "program workingness", you will see that my productivity went up.
</p>
<p>
I had to fight with the compiler a lot more, but I did not have to learn how to implement hashmaps from scratch. Win.
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/rust-talk/slide_39.png"><img src="/images/rust-talk/slide_39_small.png"></a>
</div>
<div class="content">
<p>
But I had one more problem. It turned out that I needed to know what the bytes in memory in my Ruby program *meant*. I wanted to know what the original struct definitions were so I could interpret all these 0s and 1s.
</p>
<p>
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/rust-talk/slide_40.png"><img src="/images/rust-talk/slide_40_small.png"></a>
</div>
<div class="content">
<p>
Luckily, sometimes the C compiler will save a bunch of debug information in a format called DWARF.
</p>
<p>
This basically has all the structs and saves them inside your programs! Yay! This is the best! I had hope again.
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/rust-talk/slide_41.png"><img src="/images/rust-talk/slide_41_small.png"></a>
</div>
<div class="content">
<p>
I needed a library for parsing DWARF, though. I started with trying libdwarf, and I got it maybe 90% working. But it was sort of a terrible experience.
</p>
<p>
The API was terrible, there were no docs that I could find, it was slow, I had a bad time linking the library into my Rust program.
</p>
<p>
One of the most upsetting things to me about this library is that it was really hard to understand how DWARF actually worked by looking at the interfaces it provided. I like knowing how things work.
</p>
</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/rust-talk/slide_42.png"><img src="/images/rust-talk/slide_42_small.png"></a>
</div>
<div class="content">
<p>
A lot of the time when I have programming problems, I complain about them on Twitter. Somebody suggested I try a Rust library called 'gimli'.
</p>
<p>
One of the maintainers, Nick Fitzgerald, told me it wasn't done but he thought it might have all the features I needed! GREAT.
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/rust-talk/slide_43.png"><img src="/images/rust-talk/slide_43_small.png"></a>
</div>
<div class="content">
<p>
Using Gimli was a way better experience. It didn't have too much documentation either, but that was okay -- the example program they provided was really helpful, and explained how to do basically everything I needed to do.
</p>
<p>
The only thing it didn't do that I wanted was really small, and I submitted a tiny pull request to get it.
</p>
<p>
And the maintainers were really helpful! I understood DWARF better after I started working with Gimli.
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/rust-talk/slide_44.png"><img src="/images/rust-talk/slide_44_small.png"></a>
</div>
<div class="content">
<p>
"How does DWARF work" is a question pretty far out of the scope of this talk, but basically if your program is a train car (made of a bunch of ELF section), DWARF debug info is basically just a bunch of extra train cars tacked on to the end. One of the sections just basically has all the strings in your program concatenated together!
</p>
<p>
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/rust-talk/slide_45.png"><img src="/images/rust-talk/slide_45_small.png"></a>
</div>
<div class="content">
<p>
So, after this whole saga, we did it!! I worked on this a lot with Kamal and our ruby stacktrace program worked! It's <a href="https://github.com/jvns/ruby-stacktrace">on github</a> and everything. It works on 3 computers.
</p>
<p>
(insert cool demo here)
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/rust-talk/slide_46.png"><img src="/images/rust-talk/slide_46_small.png"></a>
</div>
<div class="content">
<p>
I spend a lot of time being frustrated with the Rust compiler, but I still like it because it lets me do things I probably wouldn't get done otherwise.
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/rust-talk/slide_47.png"><img src="/images/rust-talk/slide_47_small.png"></a>
</div>
<div class="content">
<p>
I want to leave you with a few things.
</p>
<p>
One delightful thing about systems is that there's always SO MUCH MORE TO LEARN. I don't think there's any danger of any of knowing everything about systems programming any time soon.
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/rust-talk/slide_48.png"><img src="/images/rust-talk/slide_48_small.png"></a>
</div>
<div class="content">
<p>
I'm pretty sure all of you know cool things about programming that I don't know. If you like writing, this can be a great way to make the community around you know more!
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/rust-talk/slide_49.png"><img src="/images/rust-talk/slide_49_small.png"></a>
</div>
<div class="content">
<p>
One thing I really want to emphasize is -- I see a ton of resources for beginners, and I think those are really awesome.
</p>
<p>
What I don't see as much of as I'd like is resources for people who know how to program, or know Rust, and really want to take their skills to the next level. I think the Rust community is really well placed to help people do this.
</p>
<p>
Writing down information like this for developers who might already have 5 or 10 years of experiences is where I spend almost all my time.
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/rust-talk/slide_50.png"><img src="/images/rust-talk/slide_50_small.png"></a>
</div>
<div class="content">
<p>
And while you're writing down cool things to help people level up -- remember that a lot of systems things aren't really that hard. People can learn harder things than you think they can if you explain it in a way that makes sense.
</p>
<p>
I think computer networking is a really good example of this -- a lot of people get really intimidated by networking, but a lot of the core concepts like IP addresses and ports and packets are not really that hard, and once you understand them you can learn a lot.
</p>
<p>
I wrote a zine called "linux debugging tools you'll love" that talks about ngrep, tcpdump, strace, etc. And somebody tweeted at me saying he was using it to teach his 8 year old! What? So I'm not totally sure I believe that the 8 year old is using tcpdump. But maybe I'm wrong!! Who am I to say that?
</p>

<p>
So I've discovered that the audience for clear writing about systems programming is huge. A lot bigger than you might think.
</p>
</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/rust-talk/slide_51.png"><img src="/images/rust-talk/slide_51_small.png"></a>
</div>
<div class="content">
(the <a href="http://jvns.ca/zines">zine</a> I wrote)
</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/rust-talk/slide_52.png"><img src="/images/rust-talk/slide_52_small.png"></a>
</div>
<div class="content">
<p>
I'm really happy about the Rust community because there are a ton of people in this room who know about Linux and networking and concurrency and all these topics that have historically been really hard to learn about.
</p>
<p>
But now many of you are gathered here inside this really welcoming and wonderful community! This feels magical to me and like it's going to be a really good thing for programming as a whole.
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/rust-talk/slide_53.png"><img src="/images/rust-talk/slide_53_small.png"></a>
</div>
<div class="content">
<p>
So, to close, for real, I'm excited for this to be a place where people can walk in asking "what's a system call?"
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/rust-talk/slide_54.png"><img src="/images/rust-talk/slide_54_small.png"></a>
</div>
<div class="content">
<p>
and wake up a year later knowing how to do systems programming, and thinking it wasn't really that hard.
</p>

</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/rust-talk/slide_55.png"><img src="/images/rust-talk/slide_55_small.png"></a>
</div>
<div class="content">
<p>
this is a picture I commissioned of myself at the san franscisco zine festival from <a href="https://twitter.com/ohmaipie">@ohmaipie</a> as a wizard.
</p>
</div>
</div>

<div class="container">
<div class="slide">
<a href="/images/rust-talk/slide_56.png"><img src="/images/rust-talk/slide_56_small.png"></a>
</div>
<div class="content">
♥♥♥
</div>
</div>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[A few notes on my CUSEC talk]]></title>
    <link href="https://jvns.ca/blog/2016/01/14/a-few-notes-on-my-cusec-talk/"/>
    <updated>2016-01-14T12:25:07+00:00</updated>
    <id>https://jvns.ca/blog/2016/01/14/a-few-notes-on-my-cusec-talk/</id>
    <content type="html"><![CDATA[

<p>I gave a talk today! If you came, thanks for coming! Here are some notes and links if you&rsquo;d like to learn more!</p>

<h3 id="on-debugging">on debugging</h3>

<ul>
<li>on Linux, learn strace. It&rsquo;s the best. I wrote <a href="http://jvns.ca/blog/2015/04/14/strace-zine/">a zine about it</a> that you can download and print. I also wrote a <a href="http://jvns.ca/blog/categories/strace/">a million blog posts about it</a>.</li>
<li>on OS X, learn dtrace. It&rsquo;s even better than strace. <a href="https://blog.8thlight.com/colin-jones/2015/11/06/dtrace-even-better-than-strace-for-osx.html">This post</a> has a great introduction</li>
<li><a href="http://jvns.ca/blog/2015/11/21/why-you-should-understand-a-little-about-tcp/">the 40ms networking bug I talked about fixing</a></li>
<li>ngrep is a fun tool for network analysis</li>
<li>If you need to analyze encrypted traffic, use <a href="https://mitmproxy.org/">mitmproxy</a></li>
<li><a href="https://www.wireshark.org/">wireshark</a> gives you a really nice graphical interface for network spying. It&rsquo;s fun.</li>
<li><a href="http://jvns.ca/blog/2015/11/22/how-i-got-better-at-debugging/">How I got better at debugging</a></li>
<li>for more tools: <a href="http://jvns.ca/blog/2015/04/06/a-few-spy-tools-for-your-operating-system-other-than-strace/">a few spy tools for your operating system (other than strace)</a></li>
</ul>

<h3 id="on-computers-being-fast">on computers being fast</h3>

<ul>
<li>play the game: <a href="http://computers-are-fast.github.io">computers-are-fast.github.io</a></li>
<li>visualvm comes with Java, and it&rsquo;s a good first step (<a href="http://jvns.ca/blog/2016/01/03/java-isnt-slow/">a screenshot of it</a>)</li>
<li><a href="http://jvns.ca/blog/2015/09/10/a-millisecond-isnt-fast-and-how-we-fixed-it/">A millisecond isn&rsquo;t fast</a></li>
<li>YourKit is a great profiler for Java, but not free</li>
<li>for stories of performance debugging, see <a href="http://jvns.ca/blog/2015/03/15/nancy-drew-and-the-case-of-the-slow-program/">Nancy Drew and the case of the Slow Program</a></li>
<li>perf is cool for C++, and I wrote <a href="http://jvns.ca/blog/2014/05/13/profiling-with-perf/">a blog post about it</a></li>
<li><a href="https://www.youtube.com/watch?v=tDacjrSCeq4">the video of Brendan Gregg yelling at a hard drive</a>. his website is also fantastic: <a href="http://www.brendangregg.com/">brendangregg.com/</a></li>
</ul>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Why I ❤ Rust]]></title>
    <link href="https://jvns.ca/blog/2016/01/10/why-i-rust/"/>
    <updated>2016-01-10T08:43:43+00:00</updated>
    <id>https://jvns.ca/blog/2016/01/10/why-i-rust/</id>
    <content type="html"><![CDATA[<p>I gave a talk about why I like Rust a while ago! There&rsquo;s no video. Normally my
talk slides are unremarkable and I don&rsquo;t post them, but I think these mostly stand on their own and I&rsquo;m happy with how they turned out. <a href="https://speakerdeck.com/jvns/why-i-rust">Here it is (and it&rsquo;s embedded below)</a>.</p>

<script async class="speakerdeck-embed" data-id="2217f185971243a4ac638c2fa6993ca0" data-ratio="1.29456384323641" src="//speakerdeck.com/assets/embed.js"></script>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Open sourced talks!]]></title>
    <link href="https://jvns.ca/blog/2014/07/25/fork-my-talks/"/>
    <updated>2014-07-25T17:25:06+00:00</updated>
    <id>https://jvns.ca/blog/2014/07/25/fork-my-talks/</id>
    <content type="html"><![CDATA[<p>The wonderful <a href="http://www.harihareswara.net/">Sumana Harihareshwara</a>
recently tweeted that she released her talk
<a href="http://opensourcebridge.org/sessions/1329">A few Python Tips</a> as
CC-BY. I thought this was a super cool idea!</p>

<p>After all, if you&rsquo;ve put in a ton of work to put a talk or workshop
together, it&rsquo;s wonderful if other people can benefit from that as much
as possible. And none of us have an unlimited amount of time to give
talks.</p>

<p>Stephanie Sy, a developer in the Phillippines, emailed me recently to
tell me that she used parts of my
<a href="http://github.com/jvns/pandas-cookbook/">pandas cookbook</a> to run a
<a href="http://devcon.ph/events/python-code-camp">workshop</a>. IN THE
PHILIPPINES. How cool is that? She put
<a href="http://stefsy.com/pandas_devcon/">her materials online, too!</a>.</p>

<p></p>

<p>So if you want to give a talk about how to do data analysis with
Python, you too can reuse these materials in any way you see fit! You
can get materials for talks I&rsquo;ve given on
<a href="http://jvns.ca/talks/">this page of talks</a>. Just attribute me, and
maybe tell me about it because THAT WOULD BE COOL :)</p>

<p>In other open source talks news,
<a href="http://software-carpentry.org/">Software Carpentry</a> also has
MIT-licensed lesson materials! Want to give an novice introduction to
git? Go to
<a href="https://github.com/swcarpentry/bc">the SWC bootcamp respository</a> and
look in
<a href="https://github.com/swcarpentry/bc/tree/master/novice/git">novice/git</a>!
They even take pull requests.</p>]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[NYC Python talk]]></title>
    <link href="https://jvns.ca/blog/2013/11/06/nyc-python-talk-slides/"/>
    <updated>2013-11-06T00:00:00+00:00</updated>
    <id>https://jvns.ca/blog/2013/11/06/nyc-python-talk-slides/</id>
    <content type="html"><![CDATA[<p>I gave a talk at NYC Python today on how to use IPython Notebook, with
the 311 calls dataset from NYC Open Data as an example. We talked about
which borough complains the most about rats (the Bronx) and which days
of the week have the most noise complaints (Saturday, Sunday).</p>

<p>It was a fun time! Here is the notebook, if you want to try it out
yourself: <a href="http://bit.ly/nyc-python-pandas">bit.ly/nyc-python-pandas</a></p>
]]></content>
  </entry>
  
</feed>